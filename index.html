<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ursinho AmigÃ£o 2D - Aventura de Aprendizados</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #aee1f9; /* Fundo azul claro */
            font-family: 'Inter', sans-serif; /* Usando a fonte Inter */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; /* Garante que o corpo ocupa a altura total da viewport */
            position: relative; /* Para posicionamento absoluto dos elementos */
        }
        #personagemSelecao {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .personagem-opcoes {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            justify-content: center;
        }
        .personagem {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #333;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Sombra suave */
            transition: transform 0.2s, background-color 0.2s; /* TransiÃ§Ã£o suave */
        }
        .personagem:hover {
            background-color: #ffd54f; /* Amarelo ao passar o mouse */
            transform: translateY(-5px); /* Efeito de elevaÃ§Ã£o ao passar o mouse */
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            font-size: 1.1em;
            display: none; /* Oculta o HUD por padrÃ£o */
        }
        #objetivoFase {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            font-size: 1.1em;
            text-align: right;
            display: none; /* Adicionado para ocultar o painel de objetivo da fase */
        }
        /* Controles posicionados sobre o canvas */
        #direcional {
            position: fixed; /* Fixado na viewport */
            bottom: 20px;
            left: 20px; /* Canto inferior esquerdo */
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .linha {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .botao-direcional, .botao-jogo { /* Classe geral para botÃµes de jogo */
            width: 50px; /* BotÃµes ligeiramente maiores */
            height: 50px;
            background: rgba(255,255,255,0.3); /* TransparÃªncia */
            border: none;
            border-radius: 12px; /* Cantos mais arredondados */
            font-weight: bold;
            font-size: 24px; /* Fonte maior para Ã­cones */
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            transition: background 0.2s, transform 0.1s;
        }
        .botao-direcional:active, .botao-jogo:active {
            background: rgba(255,255,255,0.5); /* Menos transparente ao clicar */
            transform: translateY(2px); /* Efeito de clique */
        }
        #botao-acao {
            position: fixed; /* Fixado na viewport */
            bottom: 30px;
            right: 20px; /* Canto inferior direito */
            z-index: 10;
            background: rgba(76, 175, 80, 0.3); /* Verde com transparÃªncia */
            color: white;
            border-radius: 50%; /* Torna o botÃ£o redondo */
            display: flex; /* Para centralizar o conteÃºdo */
            align-items: center; /* Para centralizar o conteÃºdo */
            justify-content: center; /* Para centralizar o conteÃºdo */
            font-size: 30px; /* Ajusta o tamanho da fonte para o 'A' */
        }
        #botao-dica {
            position: fixed; /* Fixado na viewport */
            bottom: 90px; /* Posiciona acima do botÃ£o de aÃ§Ã£o */
            right: 20px;
            z-index: 10;
            background: rgba(33, 150, 243, 0.3); /* Azul com transparÃªncia */
            color: white;
            font-size: 16px; /* Ajusta o tamanho da fonte para o texto */
            padding: 5px 10px; /* Ajusta o padding */
            width: auto; /* Largura automÃ¡tica para o texto */
            min-width: 50px; /* Garante um tamanho mÃ­nimo */
            height: auto; /* Altura automÃ¡tica */
            line-height: normal; /* Reseta a altura da linha */
        }

        /* Modal para mensagens de fim de jogo */
        .modal {
            display: none; /* Oculto por padrÃ£o */
            position: fixed; /* Permanece no lugar */
            z-index: 20; /* Fica no topo */
            left: 0;
            top: 0;
            width: 100%; /* Largura total */
            height: 100%; /* Altura total */
            overflow: auto; /* Habilita rolagem se necessÃ¡rio */
            background-color: rgba(0,0,0,0.7); /* Preto com opacidade */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            text-align: center;
            font-size: 1.5em;
            color: #333;
            max-width: 80%;
            transform: scale(0.9);
            animation: pop-in 0.3s forwards;
        }
        @keyframes pop-in {
            from { opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-content button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.1s;
        }
        .modal-content button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        /* Estilo do Canvas 2D */
        canvas {
            background-color: #8bc34a; /* Cor do chÃ£o para 2D */
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            display: block; /* Remove espaÃ§o extra abaixo do canvas */
            max-width: 90%; /* Limita a largura para telas grandes */
            max-height: 80vh; /* Limita a altura para telas grandes */
            margin: 20px auto; /* Centraliza o canvas */
        }

        /* Mensagem de dica LLM */
        #llmHintMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            z-index: 15;
            display: none; /* Oculto por padrÃ£o */
            max-width: 70%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Novo Modal de Continue */
        #continueModal {
            display: none; /* Oculto por padrÃ£o */
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30; /* Acima de outros modais */
            text-align: center;
        }
        #continueModal h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        #continueModal p {
            font-size: 1.8em;
            margin-bottom: 30px;
        }
        #continueModal .botoes-continue {
            display: flex;
            gap: 20px;
        }
        #continueModal .botoes-continue button {
            padding: 15px 30px;
            font-size: 1.5em;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        #continueModal .botoes-continue button:hover {
            transform: translateY(-2px);
        }
        #continueModal #btnSim {
            background-color: #4CAF50;
            color: white;
        }
        #continueModal #btnNao {
            background-color: #f44336;
            color: white;
        }
        #temporaryMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.5em;
            z-index: 25;
            display: none;
        }

        /* Estilo para o tÃ­tulo do capÃ­tulo */
        #chapterTitleDisplay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            z-index: 10;
            text-align: center;
            white-space: nowrap; /* Evita quebra de linha */
        }
    </style>
</head>
<body>
    <!-- Tela de SeleÃ§Ã£o de Personagem -->
    <div id="personagemSelecao">
        <h2>Escolha seu personagem</h2>
        <div class="personagem-opcoes">
            <div class="personagem" id="personagemUrso" style="background:#f4c542;">ğŸ»<br>Urso</div>
            <div class="personagem" id="personagemGato" style="background:#8bc34a;">ğŸ±<br>Gato</div>
            <div class="personagem" id="personagemGirafa" style="background:#ffb74d;">ğŸ¦’<br>Girafa</div>
            <div class="personagem" id="personagemCoelho" style="background:#e91e63;">ğŸ°<br>Coelha</div>
        </div>
    </div>

    <!-- Heads-Up Display (HUD) -->
    <div id="hud">
        <span id="vidasDisplay"></span><br>
        <span id="hudObjectiveLine1"></span><br>
        <span id="hudObjectiveLine2"></span><br>
        <span id="totalAllItemsCollectedDisplay"></span><br>
        <span id="tempo"></span><br> <!-- Corrected id to "tempo" -->
        <span id="hudKeyStatus"></span>
    </div>

    <!-- TÃ­tulo do CapÃ­tulo Centralizado -->
    <div id="chapterTitleDisplay"></div>

    <!-- Painel de Objetivo da Fase (canto superior direito) -->
    <div id="objetivoFase" style="display: none;"></div>

    <!-- Canvas para o jogo 2D -->
    <canvas id="gameCanvas" tabindex="0"></canvas>

    <!-- Controles Direcionais para Celular -->
    <div id="direcional">
        <div class="linha">
            <button class="botao-direcional" id="btnUp">â–²</button>
        </div>
        <div class="linha">
            <button class="botao-direcional" id="btnLeft">â—„</button>
            <button class="botao-direcional" id="btnDown">â–¼</button>
            <button class="botao-direcional" id="btnRight">â–º</button>
        </div>
    </div>

    <!-- BotÃ£o de AÃ§Ã£o para Celular -->
    <button id="botao-acao" class="botao-jogo">A</button>

    <!-- Novo BotÃ£o de Dica LLM -->
    <button id="botao-dica" class="botao-jogo">âœ¨ Pedir Dica</button>

    <!-- Modal de Fim de Jogo/VitÃ³ria -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button onclick="location.reload()">Jogar Novamente</button>
        </div>
    </div>

    <!-- Mensagem de Dica LLM -->
    <div id="llmHintMessage" style="display: none;">
        Aguarde a dica...
    </div>

    <!-- Mensagem TemporÃ¡ria (ex: "Vida perdida!") -->
    <div id="temporaryMessage" style="display: none;"></div>

    <!-- Modal de Continue -->
    <div id="continueModal" style="display: none;">
        <h2>Fim de Jogo!</h2>
        <p>Continuar? <span id="continueCountdown">10</span></p>
        <div class="botoes-continue">
            <button id="btnSim">Sim</button>
            <button id="btnNao">NÃ£o</button>
        </div>
    </div>

    <!-- Script principal do jogo -->
    <script>
        // VariÃ¡veis globais para o canvas 2D e estado do jogo
        let canvas, ctx;
        let player;
        let teclas = {}; // Armazena o estado das teclas pressionadas
        let itens = []; // Array para todos os itens do tesouro (coletÃ¡veis)
        let obstaculos = []; // Array para os obstÃ¡culos que bloqueiam o caminho
        let schoolItems = []; // Novos itens escolares que nÃ£o sÃ£o coletÃ¡veis nem obstÃ¡culos
        let chest = null; // O baÃº do tesouro
        let pedrasColetadas = 0; // Contagem de pedras coletadas
        const TOTAL_PEDRAS = 3; // Total de pedras necessÃ¡rias
        let valesSorveteColetados = 0; // Novo: Contagem de vales sorvete coletados
        const TOTAL_VALES_SORVETE = 4; // Novo: Total de vales sorvete necessÃ¡rios para a Fase 2
        let sorvetesObjetivoColetados = 0; // Novo: Contagem de sorvetes objetivo coletados
        const TOTAL_SORVETES_OBJETIVO = 4; // Novo: Total de sorvetes objetivo necessÃ¡rios para a Fase 2
        let trofeusColetados = 0; // Novo: Contagem de trofÃ©us coletados para a Fase 3
        const TOTAL_TROFEUS = 3; // Novo: Total de trofÃ©us necessÃ¡rios para a Fase 3
        let bolasColetadas = 0; // Novo: Contagem de bolas coletadas para a Fase 3
        const TOTAL_BOLAS_FASE3 = 3; // Novo: Total de bolas necessÃ¡rias para a Fase 3
        let tubosEnsaioColetados = 0; // Novo: Contagem de tubos de ensaio coletados para a Fase 4
        const TOTAL_TUBOS_ENSAIO = 3; // Novo: Total de tubos de ensaio necessÃ¡rios para a Fase 4
        let imasColetados = 0; // Novo: Contagem de Ã­mÃ£s coletados para a Fase 4
        const TOTAL_IMAS = 3; // Novo: Total de Ã­mÃ£s necessÃ¡rios para a Fase 4
        let elefantesColetados = 0; // Novo: Contagem de elefantes coletados para a Fase 5
        const TOTAL_ELEFANTES = 2; // Novo: Total de elefantes necessÃ¡rios para a Fase 5
        let leoesColetados = 0; // Novo: Contagem de leÃµes coletados para a Fase 5
        const TOTAL_LEOES = 2; // Novo: Total de leÃµes necessÃ¡rios para a Fase 5
        let avesColetadas = 0; // Novo: Contagem de aves coletadas para a Fase 5
        const TOTAL_AVES = 2; // Novo: Total de aves necessÃ¡rias para a Fase 5
        let pinturasColetadas = 0; // Novo: Contagem de pinturas coletadas para a Fase 6
        const TOTAL_PINTURAS = 3; // Novo: Total de pinturas necessÃ¡rias para a Fase 6
        let esculturasColetadas = 0; // Novo: Contagem de esculturas coletadas para a Fase 6
        const TOTAL_ESCULTURAS = 3; // Novo: Total de esculturas necessÃ¡rias para a Fase 6
        let fosseisColetados = 0; // Novo: Contagem de fÃ³sseis coletados para a Fase 6
        const TOTAL_FOSSEIS = 2; // Novo: Total de fÃ³sseis necessÃ¡rios para a Fase 6
        let cestasPiqueniqueColetadas = 0; // Novo: Contagem de cestas de piquenique coletadas para a Fase 7
        const TOTAL_CESTAS_PIQUENIQUE = 2; // Novo: Total de cestas de piquenique necessÃ¡rias para a Fase 7
        let bolasFase7Coletadas = 0; // Novo: Contagem de bolas coletadas para a Fase 7
        const TOTAL_BOLAS_FASE7 = 2; // Novo: Total de bolas necessÃ¡rias para a Fase 7
        let brinquedosParqueColetados = 0; // Novo: Contagem de brinquedos de parque coletados para a Fase 7
        const TOTAL_BRINQUEDOS_PARQUE = 2; // Novo: Total de brinquedos de parque necessÃ¡rios para a Fase 7

        // Novos contadores para os capÃ­tulos 8 a 12
        let leiturinhasColetadas = 0;
        const TOTAL_LEITURINHAS = 3;
        let planetaItemsColetados = 0;
        const TOTAL_PLANETA_ITEMS = 3;
        let naturezaExploracaoColetados = 0;
        const TOTAL_NATUREZA_EXPLORACAO = 3;
        let artesItemsColetados = 0;
        const TOTAL_ARTES_ITEMS = 3;
        let musicaDancaColetados = 0;
        const TOTAL_MUSICA_DANCA = 3;


        let totalAllItemsCollected = 0; // Nova variÃ¡vel para contar TODOS os itens coletados
        let vidas = 3; // Vidas do jogador
        let tempo = 90; // Tempo do jogo em segundos
        let coletando = false; // Flag para aÃ§Ã£o de coleta (coletar item ou usar chave no baÃº)
        let gameInterval; // Para o temporador do jogo
        let hintTimeout; // Para esconder a dica LLM
        let hasKey = false; // Flag para verificar se a chave foi coletada
        let continueCountdownInterval; // Intervalo para a contagem regressiva do continue
        let continueTime = 10; // Tempo inicial da contagem regressiva do continue
        let currentPlayerType = ''; // Armazena o tipo de personagem selecionado para reinÃ­cios
        let currentPhase = 1; // Inicia na Fase 1

        const PLAYER_SIZE = 40; // Tamanho do personagem
        const ITEM_SIZE = 30; // Tamanho dos itens coletÃ¡veis
        const OBSTACLE_SIZE = 40; // Tamanho dos obstÃ¡culos que bloqueiam (ligeiramente maior para ser mais visÃ­vel)
        const SCHOOL_ITEM_SIZE = 25; // Tamanho dos itens escolares nÃ£o coletÃ¡veis
        const CHEST_SIZE = 50; // Tamanho do baÃº
        const PLAYER_SPEED = 3; // Velocidade do personagem (ajustada para mÃ©dio)

        // VariÃ¡veis para o limitador de FPS
        var targetFPS = 30; // FPS alvo
        var frameInterval = 1000 / targetFPS; // Intervalo de tempo entre frames em ms
        var lastFrameTime = 0; // Initialized globally

        // Global references to HUD elements (declared, but initialized in window.onload)
        let vidasDisplayElement;
        let hudObjectiveLine1Element;
        let hudObjectiveLine2Element;
        let totalAllItemsCollectedDisplayElement;
        let tempoDisplayElement;
        let hudKeyStatusElement;
        let chapterTitleDisplayElement;
        let objetivoFaseElement; // This element is hidden, but still referenced for consistency.
        
        // FunÃ§Ã£o para atualizar o estado da tecla (para teclado e toque)
        function tecla(k, v) {
            teclas[k] = v;
            // console.log(`DEBUG: Tecla '${k}' set to ${v}. Current teclas:`, teclas); // DepuraÃ§Ã£o
        }

        // FunÃ§Ã£o para selecionar o personagem e iniciar o jogo
        function selecionar(tipo) {
            document.getElementById("personagemSelecao").style.display = 'none'; // Esconde a tela de seleÃ§Ã£o
            currentPlayerType = tipo; // Armazena o tipo de personagem
            console.log("Personagem selecionado:", tipo);
            iniciar(tipo, 1); // Inicia o jogo na Fase 1
        }

        // Inicializa o canvas 2D e os elementos do jogo
        function iniciar(tipo, phase) {
            console.log(`Iniciando o jogo 2D com personagem: ${tipo}, Fase: ${phase}`);
            currentPhase = phase; // Atualiza a fase atual

            // Atualiza o tÃ­tulo da pÃ¡gina com o nome do capÃ­tulo
            updatePageTitle(currentPhase);

            // Garante que os modais estejam ocultos ao iniciar um novo jogo
            document.getElementById('gameModal').style.display = 'none';
            document.getElementById('llmHintMessage').style.display = 'none';
            document.getElementById('continueModal').style.display = 'none';
            document.getElementById('temporaryMessage').style.display = 'none';

            // Torna o HUD visÃ­vel ao iniciar a fase
            const hudElementDiv = document.getElementById('hud');
            if (hudElementDiv) {
                hudElementDiv.style.display = 'block';
            }

            // Get HUD element references locally within iniciar
            // This ensures they are always fresh when a new phase starts or restarts.
            vidasDisplayElement = document.getElementById('vidasDisplay');
            hudObjectiveLine1Element = document.getElementById('hudObjectiveLine1');
            hudObjectiveLine2Element = document.getElementById('hudObjectiveLine2');
            totalAllItemsCollectedDisplayElement = document.getElementById('totalAllItemsCollectedDisplay');
            tempoDisplayElement = document.getElementById('tempo'); // Correctly referencing the span with id="tempo"
            hudKeyStatusElement = document.getElementById('hudKeyStatus');
            chapterTitleDisplayElement = document.getElementById('chapterTitleDisplay');
            objetivoFaseElement = document.getElementById('objetivoFase'); // This element is hidden, but still referenced for consistency.


            // Se for um "continue", reinicia vidas para 3. Se for reinÃ­cio de fase por tempo, apenas reinicia o tempo e itens.
            if (continueCountdownInterval) { // Se veio do continue screen
                clearInterval(continueCountdownInterval);
                continueCountdownInterval = null;
                continueTime = 10; // Reseta o contador para a prÃ³xima vez
            } else if (vidas === 0) { // Se vidas chegou a 0 e nÃ£o Ã© um continue, entÃ£o Ã© um game over completo
                vidas = 3; // Reinicia vidas se for um novo jogo apÃ³s game over
            }
            // Se vidas > 0 (reinÃ­cio de fase por tempo), vidas nÃ£o Ã© resetada aqui

            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');

            // Define o tamanho do canvas para preencher a Ã¡rea disponÃ­vel
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Reinicia as variÃ¡veis de fase
            pedrasColetadas = 0;
            valesSorveteColetados = 0; 
            sorvetesObjetivoColetados = 0;
            trofeusColetados = 0; 
            bolasColetadas = 0; 
            tubosEnsaioColetados = 0; 
            imasColetados = 0; 
            elefantesColetados = 0; 
            leoesColetados = 0; 
            avesColetadas = 0; 
            pinturasColetadas = 0; 
            esculturasColetadas = 0; 
            fosseisColetados = 0; 
            cestasPiqueniqueColetadas = 0; 
            bolasFase7Coletadas = 0; 
            brinquedosParqueColetados = 0; 
            totalAllItemsCollected = 0; // Reinicia a contagem total de itens coletados
            leiturinhasColetadas = 0; // Reinicia para a nova fase
            planetaItemsColetados = 0; // Reinicia para a nova fase
            naturezaExploracaoColetados = 0; // Reinicia para a nova fase
            artesItemsColetados = 0; // Reinicia para a nova fase
            musicaDancaColetados = 0; // Reinicia para a nova fase

            tempo = 90; // RE-ADICIONADO
            coletando = false;
            hasKey = false;
            
            // Configura o personagem do jogador (posiÃ§Ã£o inicial)
            player = {
                x: canvas.width / 2 - PLAYER_SIZE / 2,
                y: canvas.height / 2 - PLAYER_SIZE / 2,
                width: PLAYER_SIZE,
                height: PLAYER_SIZE,
                emoji: getCharacterEmoji(tipo)
            };

            itens = [];
            obstaculos = [];
            schoolItems = [];
            chest = null;

            // GeraÃ§Ã£o de 2 moedas em cada fase
            itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));             // Moeda
            itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));             // Outra moeda

            if (currentPhase === 1) {
                // Itens do objetivo principal da Fase 1: 3 Pedras e a Chave
                itens.push(createGameObject('pedra', 'ğŸ”´', ITEM_SIZE, true, false, 'vermelha', true)); // Pedra vermelha (objetivo)
                itens.push(createGameObject('pedra', 'ğŸŸ¢', ITEM_SIZE, true, false, 'verde', true));   // Pedra verde (objetivo)
                itens.push(createGameObject('pedra', 'ğŸ”µ', ITEM_SIZE, true, false, 'azul', true));    // Pedra azul (objetivo)
                itens.push(createGameObject('chave', 'ğŸ”‘', ITEM_SIZE, true, false, null, true));             // Chave dourada (objetivo)

                // Outros itens coletÃ¡veis que nÃ£o sÃ£o do objetivo principal da Fase 1
                itens.push(createGameObject('folha', 'ğŸ‚', ITEM_SIZE, true, false, null, false));             // Folha encantada
                itens.push(createGameObject('folha', 'ğŸ‚', ITEM_SIZE, true, false, null, false));             // Outra folha encantada

                // Cria o baÃº do tesouro para a Fase 1
                chest = createGameObject('bau', 'ğŸ“¦', CHEST_SIZE, false, false);

            } else if (currentPhase === 2) {
                // Itens do objetivo principal da Fase 2: 4 Vales Sorvete e 4 Sorvetes de sabores especÃ­ficos
                itens.push(createGameObject('vale_sorvete', 'ğŸŸï¸', ITEM_SIZE, true, false, 'ticket', true)); // Ticket
                itens.push(createGameObject('vale_sorvete', 'ğŸŸï¸', ITEM_SIZE, true, false, 'ticket', true));
                itens.push(createGameObject('vale_sorvete', 'ğŸŸï¸', ITEM_SIZE, true, false, 'ticket', true));
                itens.push(createGameObject('vale_sorvete', 'ğŸŸï¸', ITEM_SIZE, true, false, 'ticket', true));

                itens.push(createGameObject('sorvete', 'ğŸ«ğŸ¦', ITEM_SIZE, true, false, 'chocolate', true)); // Sorvete de Chocolate (objetivo)
                itens.push(createGameObject('sorvete', 'ğŸ“ğŸ¦', ITEM_SIZE, true, false, 'morango', true));   // Sorvete de Morango (objetivo)
                itens.push(createGameObject('sorvete', 'ğŸ¥¥ğŸ¦', ITEM_SIZE, true, false, 'coco', true));      // Sorvete de Coco (objetivo)
                itens.push(createGameObject('sorvete', 'ğŸˆğŸ¦', ITEM_SIZE, true, false, 'maracuja', true)); // Sorvete de MaracujÃ¡ (objetivo)

                // Outros itens coletÃ¡veis da Fase 2 (sorvetes nÃ£o-objetivo)
                itens.push(createGameObject('sorvete', 'ğŸ¥­ğŸ¦', ITEM_SIZE, true, false, 'manga', false)); // Sorvete de Manga (nÃ£o objetivo)
                itens.push(createGameObject('sorvete', 'ğŸ¦', ITEM_SIZE, true, false, 'flocos', false)); // Sorvete de Flocos (nÃ£o objetivo)

                // NÃ£o hÃ¡ baÃº na Fase 2, a vitÃ³ria Ã© por coletar vales e sorvetes
                chest = null; 
            } else if (currentPhase === 3) {
                // Itens do objetivo principal da Fase 3: 3 TrofÃ©us e 3 Bolas
                itens.push(createGameObject('trofeu', 'ğŸ†', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('trofeu', 'ğŸ†', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('trofeu', 'ğŸ†', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('bola', 'âš½', ITEM_SIZE, true, false, null, true)); // Bola (objetivo)
                itens.push(createGameObject('bola', 'âš½', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('bola', 'âš½', ITEM_SIZE, true, false, null, true));

                // Outros itens coletÃ¡veis da Fase 3 (pipas)
                itens.push(createGameObject('pipa', 'ğŸª', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('pipa', 'ğŸª', ITEM_SIZE, true, false, null, false));

                // NÃ£o hÃ¡ baÃº na Fase 3
                chest = null;
            } else if (currentPhase === 4) {
                // Itens do objetivo principal da Fase 4: 3 Tubos de Ensaio e 3 ÃmÃ£s
                itens.push(createGameObject('tubo_ensaio', 'ğŸ§ª', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('tubo_ensaio', 'ğŸ§ª', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('tubo_ensaio', 'ğŸ§ª', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('ima', 'ğŸ§²', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('ima', 'ğŸ§²', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('ima', 'ğŸ§²', ITEM_SIZE, true, false, null, true));

                // Outros itens de laboratÃ³rio (nÃ£o objetivo)
                itens.push(createGameObject('bequer', 'âš—ï¸', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('microscopio', 'ğŸ”¬', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('pipeta', 'ğŸ’§', ITEM_SIZE, true, false, null, false)); 
                
                // NÃ£o hÃ¡ baÃº na Fase 4
                chest = null;
            } else if (currentPhase === 5) {
                // Itens do objetivo principal da Fase 5: 2 Elefantes, 2 LeÃµes, 2 Aves
                itens.push(createGameObject('elefante', 'ğŸ˜', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('elefante', 'ğŸ˜', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('leao', 'ğŸ¦', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('leao', 'ğŸ¦', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('ave', 'ğŸ¦œ', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('ave', 'ğŸ¦œ', ITEM_SIZE, true, false, null, true));

                // Outros itens de zoolÃ³gico (nÃ£o objetivo)
                itens.push(createGameObject('macaco', 'ğŸ’', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('crocodilo', 'ğŸŠ', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('cobra', 'ğŸ', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('lagarto', 'ğŸ¦', ITEM_SIZE, true, false, null, false));

                // NÃ£o hÃ¡ baÃº na Fase 5
                chest = null;
            } else if (currentPhase === 6) {
                // Itens do objetivo principal da Fase 6: 3 Pinturas, 3 Esculturas, 2 FÃ³sseis
                itens.push(createGameObject('pintura', 'ğŸ¨', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('pintura', 'ğŸ¨', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('pintura', 'ğŸ¨', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('escultura', 'ğŸ—¿', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('escultura', 'ğŸ—¿', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('escultura', 'ğŸ—¿', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('fossil', 'ğŸ¦´', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('fossil', 'ğŸ¦´', ITEM_SIZE, true, false, null, true));

                // Outros itens de museu (nÃ£o objetivo)
                itens.push(createGameObject('artefato', 'ğŸº', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('pincel', 'ğŸ–Œï¸', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('livro_arte', 'ğŸ–¼ï¸', ITEM_SIZE, true, false, null, false));

                // NÃ£o hÃ¡ baÃº na Fase 6
                chest = null;
            } else if (currentPhase === 7) {
                // Itens do objetivo principal da Fase 7: 2 Cestas de Piquenique, 2 Bolas, 2 Brinquedos de Parque
                itens.push(createGameObject('cesta_piquenique', 'ğŸ§º', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('cesta_piquenique', 'ğŸ§º', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('bola', 'âš½', ITEM_SIZE, true, false, null, true)); // Bola (objetivo)
                itens.push(createGameObject('bola', 'âš½', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('brinquedo_parque', 'ğŸ ', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('brinquedo_parque', 'ğŸ ', ITEM_SIZE, true, false, null, true));

                // Outros itens de parque (nÃ£o objetivo)
                itens.push(createGameObject('balao', 'ğŸˆ', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('balao', 'ğŸˆ', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('flor', 'ğŸŒ¸', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('flor', 'ğŸŒ¸', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('borboleta', 'ğŸ¦‹', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('borboleta', 'ğŸ¦‹', ITEM_SIZE, true, false, null, false));
                
                // NÃ£o hÃ¡ baÃº na Fase 7
                chest = null;
            } else if (currentPhase === 8) { // CapÃ­tulo 8: Leiturinhas
                // Itens para o CapÃ­tulo 8: Leiturinhas (3 itens temÃ¡ticos)
                itens.push(createGameObject('livro_aberto', 'ğŸ“–', ITEM_SIZE, true, false, null, true)); // isObstacle: false
                itens.push(createGameObject('oculos', 'ğŸ‘“', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('caneta', 'ğŸ–Šï¸', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('globo', 'ğŸŒ', ITEM_SIZE, true, false, null, false)); // NÃ£o objetivo
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false)); // Adiciona moedas tambÃ©m
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                chest = null; // NÃ£o hÃ¡ baÃº no CapÃ­tulo 8
            } else if (currentPhase === 9) { // CapÃ­tulo 9: Planeta
                // Itens para o CapÃ­tulo 9: Reciclagem e Meio Ambiente (3 itens temÃ¡ticos)
                itens.push(createGameObject('lixeira_reciclagem', 'â™»ï¸', ITEM_SIZE, true, false, null, true)); // isObstacle: false
                itens.push(createGameObject('garrafa_plastico', 'ğŸ§´', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('arvore_muda', 'ğŸŒ±', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('saco_lixo', 'ğŸ—‘ï¸', ITEM_SIZE, true, false, null, false)); // NÃ£o objetivo
                itens.push(createGameObject('flor', 'ğŸŒ¸', ITEM_SIZE, true, false, null, false)); // NÃ£o objetivo
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                chest = null; // NÃ£o hÃ¡ baÃº no CapÃ­tulo 9
            } else if (currentPhase === 10) { // CapÃ­tulo 10: ExploraÃ§Ã£o da Natureza
                // Itens para o CapÃ­tulo 10: ExploraÃ§Ã£o da Natureza (3 itens temÃ¡ticos)
                itens.push(createGameObject('planta_nativa', 'ğŸŒ¿', ITEM_SIZE, true, false, null, true)); // isObstacle: false
                itens.push(createGameObject('animal_selvagem', 'ğŸ¦‹', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('binoculos', 'ğŸ”­', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('lupa', 'ğŸ”', ITEM_SIZE, true, false, null, false)); // NÃ£o objetivo
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                chest = null; // NÃ£o hÃ¡ baÃº no CapÃ­tulo 10
            } else if (currentPhase === 11) { // CapÃ­tulo 11: Oficina de Artes
                // Itens para o CapÃ­tulo 11: Oficina de Artes (3 itens temÃ¡ticos)
                itens.push(createGameObject('pincel', 'ğŸ–Œï¸', ITEM_SIZE, true, false, null, true)); // isObstacle: false
                itens.push(createGameObject('tinta', 'ğŸ¨', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('argila', 'ğŸº', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('lapis_cor', 'ğŸ–ï¸', ITEM_SIZE, true, false, null, false)); // NÃ£o objetivo
                itens.push(createGameObject('tela', 'ğŸ–¼ï¸', ITEM_SIZE, true, false, null, false)); // NÃ£o objetivo
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                chest = null; // NÃ£o hÃ¡ baÃº no CapÃ­tulo 11
            } else if (currentPhase === 12) { // CapÃ­tulo 12: MÃºsica e DanÃ§a
                // Itens para o CapÃ­tulo 12: MÃºsica e DanÃ§a (3 itens temÃ¡ticos)
                itens.push(createGameObject('violao', 'ğŸ¸', ITEM_SIZE, true, false, null, true)); // isObstacle: false
                itens.push(createGameObject('piano', 'ğŸ¹', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('microfone', 'ğŸ¤', ITEM_SIZE, true, false, null, true));
                itens.push(createGameObject('fones_ouvido', 'ğŸ§', ITEM_SIZE, true, false, null, false)); // NÃ£o objetivo
                itens.push(createGameObject('partitura', 'ğŸ¼', ITEM_SIZE, true, false, null, false)); // NÃ£o objetivo
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                itens.push(createGameObject('moeda', 'ğŸ’°', ITEM_SIZE, true, false, null, false));
                chest = null; // NÃ£o hÃ¡ baÃº no CapÃ­tulo 12
            }


            // Gera os obstÃ¡culos temÃ¡ticos da escola (comum para todas as fases)
            for (let i = 0; i < 4; i++) { 
                obstaculos.push(createGameObject('mesa', 'ğŸª‘', OBSTACLE_SIZE, false, true)); 
                obstaculos.push(createGameObject('cadeira', 'ğŸª‘', OBSTACLE_SIZE, false, true));
                obstaculos.push(createGameObject('armario', 'ğŸšª', OBSTACLE_SIZE, false, true));
                obstaculos.push(createGameObject('quadro', 'ğŸ–¼ï¸', OBSTACLE_SIZE, false, true));
            }

            // Gera os itens escolares (nÃ£o coletÃ¡veis, nÃ£o obstÃ¡culos - comum para todas as fases)
            for (let i = 0; i < 5; i++) { 
                schoolItems.push(createGameObject('lapis', 'âœï¸', SCHOOL_ITEM_SIZE, true, false, null, false)); 
                schoolItems.push(createGameObject('caderno', 'ğŸ““', SCHOOL_ITEM_SIZE, true, false, null, false)); 
                schoolItems.push(createGameObject('livro', 'ğŸ“š', SCHOOL_ITEM_SIZE, false, false)); 
                schoolItems.push(createGameObject('borracha', 'ğŸ§½', SCHOOL_ITEM_SIZE, false, false)); 
                schoolItems.push(createGameObject('mochila', 'ğŸ’', SCHOOL_ITEM_SIZE, false, false)); 
            }

            // Posiciona todos os objetos no canvas de forma aleatÃ³ria, evitando sobreposiÃ§Ã£o inicial
            placeGameObjectsRandomly();

            atualizarHUD(); // Atualiza o HUD com o novo total e objetivo

            // Limpa qualquer temporizador anterior e inicia o novo
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                // console.log("DEBUG: setInterval is running. Current tempo:", tempo); // Debugging timer
                let winConditionMet = false;
                if (currentPhase === 1) {
                    winConditionMet = (pedrasColetadas === TOTAL_PEDRAS && hasKey && chest === null);
                } else if (currentPhase === 2) {
                    winConditionMet = (valesSorveteColetados === TOTAL_VALES_SORVETE && sorvetesObjetivoColetados === TOTAL_SORVETES_OBJETIVO);
                } else if (currentPhase === 3) {
                    winConditionMet = (trofeusColetados === TOTAL_TROFEUS && bolasColetadas === TOTAL_BOLAS_FASE3);
                } else if (currentPhase === 4) {
                    winConditionMet = (tubosEnsaioColetados === TOTAL_TUBOS_ENSAIO && imasColetados === TOTAL_IMAS);
                } else if (currentPhase === 5) {
                    winConditionMet = (elefantesColetados === TOTAL_ELEFANTES && leoesColetados === TOTAL_LEOES && avesColetadas === TOTAL_AVES);
                } else if (currentPhase === 6) {
                    winConditionMet = (pinturasColetadas === TOTAL_PINTURAS && esculturasColetadas === TOTAL_ESCULTURAS && fosseisColetados === TOTAL_FOSSEIS);
                } else if (currentPhase === 7) {
                    winConditionMet = (cestasPiqueniqueColetadas === TOTAL_CESTAS_PIQUENIQUE && bolasFase7Coletadas === TOTAL_BOLAS_FASE7 && brinquedosParqueColetados === TOTAL_BRINQUEDOS_PARQUE);
                } else if (currentPhase === 8) {
                    winConditionMet = (leiturinhasColetadas >= TOTAL_LEITURINHAS);
                } else if (currentPhase === 9) {
                    winConditionMet = (planetaItemsColetados >= TOTAL_PLANETA_ITEMS);
                } else if (currentPhase === 10) {
                    winConditionMet = (naturezaExploracaoColetados >= TOTAL_NATUREZA_EXPLORACAO);
                } else if (currentPhase === 11) {
                    winConditionMet = (artesItemsColetados >= TOTAL_ARTES_ITEMS);
                } else if (currentPhase === 12) {
                    winConditionMet = (musicaDancaColetados >= TOTAL_MUSICA_DANCA);
                }

                if (tempo > 0 && vidas > 0 && !winConditionMet) {
                    tempo--; // DECREMENTO DE TEMPO
                    // Acessa o elemento 'tempo' diretamente aqui para garantir que nÃ£o seja nulo
                    const currentTempoElement = document.getElementById('tempo');
                    if (currentTempoElement) {
                        currentTempoElement.innerText = `Tempo: ${tempo}s`; // Atualiza o texto do tempo
                    } else {
                        console.error("Erro: Elemento 'tempo' nÃ£o encontrado no DOM (dentro do setInterval).");
                    }
                    
                    if (tempo === 0) {
                        // Tempo esgotado, mas ainda tem vidas
                        clearInterval(gameInterval); // Para o jogo enquanto a mensagem Ã© exibida
                        showTemporaryMessage("Perdeu!", 3000); // Exibe "Perdeu!" por 3 segundos
                        
                        setTimeout(() => { // ApÃ³s a mensagem temporÃ¡ria
                            vidas--; // Consome uma vida
                            atualizarHUD(); // Atualiza o HUD para mostrar a vida perdida

                            if (vidas > 0) {
                                // Ainda tem vidas, reinicia a fase
                                iniciar(currentPlayerType, currentPhase); // Reinicia a fase atual
                            } else {
                                // Perdeu a Ãºltima vida, mostra a tela de continue
                                showContinueScreen();
                            }
                        }, 3000); // Espera a duraÃ§Ã£o da mensagem temporÃ¡ria
                    }
                } else if (winConditionMet) {
                    clearInterval(gameInterval); // Para o jogo
                    if (currentPhase === 1) {
                        showTemporaryMessage("CapÃ­tulo 1 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 2); // Inicia a Fase 2
                        }, 2000);
                    } else if (currentPhase === 2) {
                        showTemporaryMessage("CapÃ­tulo 2 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 3); // Inicia a Fase 3
                        }, 2000);
                    } else if (currentPhase === 3) {
                        showTemporaryMessage("CapÃ­tulo 3 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 4); // Inicia a Fase 4
                        }, 2000);
                    } else if (currentPhase === 4) {
                        showTemporaryMessage("CapÃ­tulo 4 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 5); // Inicia a Fase 5
                        }, 2000);
                    } else if (currentPhase === 5) {
                        showTemporaryMessage("CapÃ­tulo 5 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 6); // Inicia a Fase 6
                        }, 2000);
                    } else if (currentPhase === 6) {
                        showTemporaryMessage("CapÃ­tulo 6 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 7); // Inicia a Fase 7
                        }, 2000);
                    } else if (currentPhase === 7) {
                        showTemporaryMessage("CapÃ­tulo 7 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 8); // Inicia a Fase 8 (CapÃ­tulo 8)
                        }, 2000);
                    } else if (currentPhase === 8) {
                        showTemporaryMessage("CapÃ­tulo 8 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 9); // Inicia a Fase 9 (CapÃ­tulo 9)
                        }, 2000);
                    } else if (currentPhase === 9) {
                        showTemporaryMessage("CapÃ­tulo 9 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 10); // Inicia a Fase 10 (CapÃ­tulo 10)
                        }, 2000);
                    } else if (currentPhase === 10) {
                        showTemporaryMessage("CapÃ­tulo 10 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 11); // Inicia a Fase 11 (CapÃ­tulo 11)
                        }, 2000);
                    } else if (currentPhase === 11) {
                        showTemporaryMessage("CapÃ­tulo 11 ConcluÃ­do!", 2000);
                        setTimeout(() => {
                            iniciar(currentPlayerType, 12); // Inicia a Fase 12 (CapÃ­tulo 12)
                        }, 2000);
                    } else if (currentPhase === 12) {
                        encerrar("âœ… ParabÃ©ns! VocÃª completou todos os capÃ­tulos!"); // VitÃ³ria final apÃ³s o CapÃ­tulo 12
                    }
                } else if (vidas <= 0) { // Se vidas chegou a 0, mostra a tela de continue
                    clearInterval(gameInterval); // Para o jogo
                    showContinueScreen();
                }
            }, 1000); // O intervalo ainda roda, mas nÃ£o decrementa o tempo

            // Inicia o loop principal de animaÃ§Ã£o
            lastFrameTime = performance.now();
            animar();
            canvas.focus(); // Garante que o canvas tenha foco ao iniciar o jogo
        }

        // FunÃ§Ã£o para redimensionar o canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth * 0.9; // 90% da largura da janela
            canvas.height = window.innerHeight * 0.7; // 70% da altura da janela
            // Garante que o canvas nÃ£o seja muito pequeno ou muito grande
            canvas.width = Math.max(300, Math.min(800, canvas.width));
            canvas.height = Math.max(200, Math.min(600, canvas.height));
            // Reposiciona o jogador no centro se o canvas for redimensionado
            if (player) {
                player.x = canvas.width / 2 - PLAYER_SIZE / 2;
                player.y = canvas.height / 2 - PLAYER_SIZE / 2;
            }
            // NÃ£o reposiciona itens e obstÃ¡culos existentes para manter o desafio
        }

        // Retorna o emoji do personagem selecionado
        function getCharacterEmoji(tipo) {
            switch (tipo) {
                case 'urso': return 'ğŸ»';
                case 'gato': return 'ğŸ±';
                case 'girafa': return 'ğŸ¦’';
                case 'coelho': return 'ğŸ°';
                default: return 'â“';
            }
        }

        // Cria um objeto de jogo (item, obstÃ¡culo, baÃº, item escolar)
        function createGameObject(type, emoji, size, canBeCollected, isObstacle, color = null, isObjective = false) {
            return {
                type: type,
                emoji: emoji,
                canBeCollected: canBeCollected, // Se pode ser coletado pelo botÃ£o de aÃ§Ã£o
                isObstacle: isObstacle,        // Se bloqueia o caminho
                color: color,
                isObjective: isObjective,      // Se conta para o objetivo principal
                x: 0, 
                y: 0, 
                size: size,
                width: size, 
                height: size 
            };
        }

        // Posiciona todos os objetos no canvas de forma aleatÃ³ria, evitando sobreposiÃ§Ã£o inicial
        function placeGameObjectsRandomly() {
            const padding = 20; // EspaÃ§amento das bordas do canvas
            const minX = padding;
            const minY = padding;
            const maxX = canvas.width - padding;
            const maxY = canvas.height - padding;

            const placedObjects = []; // Para controlar a sobreposiÃ§Ã£o

            // Define uma Ã¡rea segura no centro para o jogador
            const playerStartX = canvas.width / 2 - PLAYER_SIZE / 2;
            const playerStartY = canvas.height / 2 - PLAYER_SIZE / 2;
            // Aumentei a zona segura para 3x o tamanho do jogador (6x PLAYER_SIZE total)
            const playerSafeZone = {
                x: playerStartX - PLAYER_SIZE * 2.5,
                y: playerStartY - PLAYER_SIZE * 2.5,
                width: PLAYER_SIZE * 6,
                height: PLAYER_SIZE * 6
            };

            function getRandomPosition(objSize, isObstacle = false) {
                let newX, newY, collision;
                let attempts = 0;
                const maxAttempts = 100; // Evita loop infinito

                do {
                    collision = false;
                    newX = Math.random() * (maxX - minX - objSize) + minX;
                    newY = Math.random() * (maxY - minY - objSize) + minY;

                    const newRect = { x: newX, y: newY, width: objSize, height: objSize };

                    // Verifica colisÃ£o com objetos jÃ¡ posicionados
                    for (const placedObj of placedObjects) {
                        const exclusionZone = 5.0; // Aumentado para 5.0 para mais dispersÃ£o
                        const expandedRect = {
                            x: placedObj.x - (objSize * (exclusionZone - 1) / 2),
                            y: placedObj.y - (objSize * (exclusionZone - 1) / 2),
                            width: placedObj.width * exclusionZone,
                            height: placedObj.height * exclusionZone
                        };
                        if (checkCollision(newRect, expandedRect)) {
                            collision = true;
                            break;
                        }
                    }

                    // Se for um obstÃ¡culo, verifica tambÃ©m colisÃ£o com a zona segura do jogador
                    if (!collision && isObstacle && checkCollision(newRect, playerSafeZone)) {
                        collision = true;
                    }

                    attempts++;
                } while (collision && attempts < maxAttempts);

                if (attempts === maxAttempts) {
                    console.warn("NÃ£o foi possÃ­vel encontrar uma posiÃ§Ã£o livre para um objeto. Pode haver sobreposiÃ§Ã£o.");
                }
                return { x: newX, y: newY, width: objSize, height: objSize };
            }

            // Posicionar itens
            itens.forEach(item => {
                const pos = getRandomPosition(item.size);
                item.x = pos.x;
                item.y = pos.y;
                placedObjects.push(item);
            });

            // Posicionar obstÃ¡culos
            obstaculos.forEach(obstacle => {
                const pos = getRandomPosition(obstacle.size, true); // Passa true para isObstacle
                obstacle.x = pos.x;
                obstacle.y = pos.y;
                placedObjects.push(obstacle);
            });

            // Posicionar itens escolares
            schoolItems.forEach(sItem => {
                const pos = getRandomPosition(sItem.size);
                sItem.x = pos.x;
                sItem.y = pos.y;
                placedObjects.push(sItem);
            });

            // Posicionar o baÃº (apenas na Fase 1)
            if (chest && currentPhase === 1) {
                const pos = getRandomPosition(chest.size);
                chest.x = pos.x;
                chest.y = pos.y;
                placedObjects.push(chest);
            }
        }

        // Desenha um objeto no canvas
        function drawItem(item) {
            // Tenta usar uma lista de fontes de emoji para melhor compatibilidade
            ctx.font = `${item.size}px "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(item.emoji, item.x + item.size / 2, item.y + item.size / 2);
        }

        // Desenha o personagem no canvas
        function drawPlayer() {
            // Tenta usar uma lista de fontes de emoji para melhor compatibilidade
            ctx.font = `${player.width}px "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(player.emoji, player.x + player.width / 2, player.y + player.height / 2);
        }

        // Verifica colisÃ£o entre dois retÃ¢ngulos (AABB)
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // LÃ³gica de interaÃ§Ãµes (coleta de itens, colisÃ£o com obstÃ¡culos, interaÃ§Ã£o com o baÃº)
        function handleInteractions() {
            // Oculta qualquer dica LLM ativa ao interagir
            document.getElementById('llmHintMessage').style.display = 'none';
            if (hintTimeout) clearTimeout(hintTimeout);

            // 1. Coleta de Itens (se o botÃ£o de aÃ§Ã£o estiver pressionado)
            if (coletando) {
                // Percorre todos os itens para verificar coleta
                for (let i = 0; i < itens.length; i++) {
                    if (itens[i].canBeCollected && checkCollision(player, itens[i])) {
                        const collectedItem = itens.splice(i, 1)[0];
                        totalAllItemsCollected++; // Incrementa a contagem total

                        if (collectedItem.isObjective) {
                            if (currentPhase === 1) { // LÃ³gica de objetivo da Fase 1
                                if (collectedItem.type === 'pedra') {
                                    pedrasColetadas++;
                                    console.log(`DEBUG: Pedra coletada! Total de pedras: ${pedrasColetadas}/${TOTAL_PEDRAS}`);
                                } else if (collectedItem.type === 'chave') {
                                    hasKey = true;
                                    console.log("DEBUG: Chave dourada coletada!");
                                }
                            } else if (currentPhase === 2) { // LÃ³gica de objetivo da Fase 2
                                if (collectedItem.type === 'vale_sorvete') {
                                    valesSorveteColetados++;
                                    console.log(`DEBUG: Vale Sorvete coletado! Total de vales: ${valesSorveteColetados}/${TOTAL_VALES_SORVETE}`);
                                } else if (collectedItem.type === 'sorvete' && collectedItem.isObjective) { // Sorvetes objetivo na Fase 2
                                    sorvetesObjetivoColetados++;
                                    console.log(`DEBUG: Sorvete coletado! Total de sorvetes: ${sorvetesObjetivoColetados}/${TOTAL_SORVETES_OBJETIVO}`);
                                }
                            } else if (currentPhase === 3) { // LÃ³gica de objetivo da Fase 3
                                if (collectedItem.type === 'trofeu') {
                                    trofeusColetados++;
                                    console.log(`DEBUG: TrofÃ©u coletado! Total de trofÃ©us: ${trofeusColetados}/${TOTAL_TROFEUS}`);
                                } else if (collectedItem.type === 'bola' && collectedItem.isObjective) { // Bolas objetivo na Fase 3
                                    bolasColetadas++;
                                    console.log(`DEBUG: Bola coletada! Total de bolas: ${bolasColetadas}/${TOTAL_BOLAS_FASE3}`);
                                }
                            } else if (currentPhase === 4) { // LÃ³gica de objetivo da Fase 4
                                if (collectedItem.type === 'tubo_ensaio') {
                                    tubosEnsaioColetados++;
                                    console.log(`DEBUG: Tubo de Ensaio coletado! Total: ${tubosEnsaioColetados}/${TOTAL_TUBOS_ENSAIO}`);
                                } else if (collectedItem.type === 'ima') {
                                    imasColetados++;
                                    console.log(`DEBUG: ÃmÃ£ coletado! Total: ${imasColetados}/${TOTAL_IMAS}`);
                                }
                            } else if (currentPhase === 5) { // LÃ³gica de objetivo da Fase 5
                                if (collectedItem.type === 'elefante') {
                                    elefantesColetados++;
                                    console.log(`DEBUG: Elefante coletado! Total: ${elefantesColetados}/${TOTAL_ELEFANTES}`);
                                } else if (collectedItem.type === 'leao') {
                                    leoesColetados++;
                                    console.log(`DEBUG: LeÃ£o coletado! Total: ${leoesColetados}/${TOTAL_LEOES}`);
                                } else if (collectedItem.type === 'ave') {
                                    avesColetadas++;
                                    console.log(`DEBUG: Ave coletada! Total: ${avesColetadas}/${TOTAL_AVES}`);
                                }
                            } else if (currentPhase === 6) { // LÃ³gica de objetivo da Fase 6
                                if (collectedItem.type === 'pintura') {
                                    pinturasColetadas++;
                                    console.log(`DEBUG: Pintura coletada! Total: ${pinturasColetadas}/${TOTAL_PINTURAS}`);
                                } else if (collectedItem.type === 'escultura') {
                                    esculturasColetadas++;
                                    console.log(`DEBUG: Escultura coletada! Total: ${esculturasColetadas}/${TOTAL_ESCULTURAS}`);
                                } else if (collectedItem.type === 'fossil') {
                                    fosseisColetados++;
                                    console.log(`DEBUG: FÃ³ssil coletado! Total: ${fosseisColetados}/${TOTAL_FOSSEIS}`);
                                }
                            } else if (currentPhase === 7) { // LÃ³gica de objetivo da Fase 7
                                if (collectedItem.type === 'cesta_piquenique') {
                                    cestasPiqueniqueColetadas++;
                                    console.log(`DEBUG: Cesta de Piquenique coletada! Total: ${cestasPiqueniqueColetadas}/${TOTAL_CESTAS_PIQUENIQUE}`);
                                } else if (collectedItem.type === 'bola' && collectedItem.isObjective) {
                                    bolasFase7Coletadas++;
                                    console.log(`DEBUG: Bola (Fase 7) coletada! Total: ${bolasFase7Coletadas}/${TOTAL_BOLAS_FASE7}`);
                                } else if (collectedItem.type === 'brinquedo_parque') {
                                    brinquedosParqueColetados++;
                                    console.log(`DEBUG: Brinquedo de Parque coletado! Total: ${brinquedosParqueColetados}/${TOTAL_BRINQUEDOS_PARQUE}`);
                                }
                            } else if (currentPhase === 8) { // LÃ³gica de objetivo da Fase 8
                                if (collectedItem.type === 'livro_aberto' || collectedItem.type === 'oculos' || collectedItem.type === 'caneta') {
                                    leiturinhasColetadas++;
                                    console.log(`DEBUG: Item de Leiturinhas coletado! Total: ${leiturinhasColetadas}/${TOTAL_LEITURINHAS}`);
                                }
                            } else if (currentPhase === 9) { // LÃ³gica de objetivo da Fase 9
                                if (collectedItem.type === 'lixeira_reciclagem' || collectedItem.type === 'garrafa_plastico' || collectedItem.type === 'arvore_muda') {
                                    planetaItemsColetados++;
                                    console.log(`DEBUG: Item do Planeta coletado! Total: ${planetaItemsColetados}/${TOTAL_PLANETA_ITEMS}`);
                                }
                            } else if (currentPhase === 10) { // LÃ³gica de objetivo da Fase 10
                                if (collectedItem.type === 'planta_nativa' || collectedItem.type === 'animal_selvagem' || collectedItem.type === 'binoculos') {
                                    naturezaExploracaoColetados++;
                                    console.log(`DEBUG: Item de ExploraÃ§Ã£o da Natureza coletado! Total: ${naturezaExploracaoColetados}/${TOTAL_NATUREZA_EXPLORACAO}`);
                                }
                            } else if (currentPhase === 11) { // LÃ³gica de objetivo da Fase 11
                                if (collectedItem.type === 'pincel' || collectedItem.type === 'tinta' || collectedItem.type === 'argila') {
                                    artesItemsColetados++;
                                    console.log(`DEBUG: Item de Artes coletado! Total: ${artesItemsColetados}/${TOTAL_ARTES_ITEMS}`);
                                }
                            } else if (currentPhase === 12) { // LÃ³gica de objetivo da Fase 12
                                if (collectedItem.type === 'violao' || collectedItem.type === 'piano' || collectedItem.type === 'microfone') {
                                    musicaDancaColetados++;
                                    console.log(`DEBUG: Item de MÃºsica e DanÃ§a coletado! Total: ${musicaDancaColetados}/${TOTAL_MUSICA_DANCA}`);
                                }
                            }
                        } else if (collectedItem.type === 'moeda') { // Moedas aumentam o tempo
                            tempo += 5; // RE-ADICIONADO
                            console.log(`DEBUG: Moeda coletada! Tempo +5s. Tempo atual: ${tempo}`); // RE-ADICIONADO
                        }
                        atualizarHUD();
                        // console.log(`DEBUG: Item coletado: ${collectedItem.type}. Total Coletado: ${totalAllItemsCollected}`);
                        coletando = false; 
                        return; 
                    }
                }
                
                // Depois verifica itens escolares coletÃ¡veis (se houver)
                for (let i = 0; i < schoolItems.length; i++) {
                    if (schoolItems[i].canBeCollected && checkCollision(player, schoolItems[i])) {
                        const collectedItem = schoolItems.splice(i, 1)[0];
                        totalAllItemsCollected++; // Incrementa a contagem total
                        atualizarHUD();
                        // console.log(`DEBUG: Item escolar coletado: ${collectedItem.type}. Total Coletado: ${totalAllItemsCollected}`);
                        coletando = false;
                        return;
                    }
                }


                // 2. InteraÃ§Ã£o com o BaÃº (apenas na Fase 1)
                if (currentPhase === 1 && chest && hasKey && checkCollision(player, chest)) {
                    // Verifica se TODOS os itens do OBJETIVO da Fase 1 foram coletados antes de abrir o baÃº
                    if (pedrasColetadas === TOTAL_PEDRAS && hasKey) {
                        chest = null; // Remove o baÃº apÃ³s ser usado
                        console.log("DEBUG: BaÃº aberto com sucesso!");
                        coletando = false;
                        // A transiÃ§Ã£o de fase Ã© tratada no setInterval principal
                        return; 
                    } else {
                        // Mensagem para o jogador se nÃ£o coletou todos os itens do objetivo da Fase 1
                        const hintMessageDiv = document.getElementById('llmHintMessage');
                        let msg = "VocÃª precisa coletar todos os itens do objetivo antes de abrir o baÃº!";
                        if (pedrasColetadas < TOTAL_PEDRAS) {
                            msg += ` Faltam ${TOTAL_PEDRAS - pedrasColetadas} pedras.`;
                        }
                        if (!hasKey) { 
                            msg += ` VocÃª nÃ£o tem a chave.`; 
                        }
                        hintMessageDiv.innerText = msg;
                        hintMessageDiv.style.display = 'block';
                        if (hintTimeout) clearTimeout(hintTimeout);
                        hintTimeout = setTimeout(() => hintMessageDiv.style.display = 'none', 5000);
                        coletando = false; 
                    }
                }
            }
        }

        // FunÃ§Ã£o para pedir uma dica ao LLM
        async function askForHint() {
            const hintMessageDiv = document.getElementById('llmHintMessage');
            hintMessageDiv.innerText = "Aguarde a dica...";
            hintMessageDiv.style.display = 'block'; // Mostra a mensagem de carregamento

            if (hintTimeout) clearTimeout(hintTimeout); // Limpa qualquer timeout anterior

            let objectFound = false;
            let promptText = "";
            let nearestObject = null; // Pode ser item, obstÃ¡culo, baÃº ou item escolar

            // Encontra o objeto mais prÃ³ximo para dar a dica
            let minDistance = Infinity;
            const allGameObjects = [...itens, ...obstaculos, ...schoolItems]; // Inclui todos os tipos de objetos
            if (chest && currentPhase === 1) allGameObjects.push(chest); // Adiciona o baÃº se existir e for Fase 1

            for (const obj of allGameObjects) {
                const objCenter = { x: obj.x + obj.size / 2, y: obj.y + obj.size / 2 }; 
                const playerCenter = { x: player.x + player.width / 2, y: player.y + player.height / 2 };
                const distance = Math.sqrt(
                    Math.pow(objCenter.x - playerCenter.x, 2) +
                    Math.pow(objCenter.y - playerCenter.y, 2)
                );

                // Define um raio de proximidade para a dica
                const HINT_RADIUS = 100; 
                if (distance < HINT_RADIUS) {
                    minDistance = distance;
                    nearestObject = obj;
                    break; // Corrigido: 'break' deve estar aqui para sair do loop
                }
            }

            if (nearestObject) { // Se o jogador estiver perto de algum objeto
                objectFound = true;
                if (nearestObject.canBeCollected) { // Se o item pode ser coletado
                    if (nearestObject.isObjective) {
                        if (currentPhase === 1) {
                            switch (nearestObject.type) {
                                case 'pedra':
                                    promptText = `VocÃª Ã© uma pedra ${nearestObject.color} vibrante, um dos itens essenciais para o tesouro. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e misterioso.`;
                                    break;
                                case 'chave':
                                    promptText = `VocÃª Ã© a chave dourada, crucial para o tesouro. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e indique sua importÃ¢ncia.`;
                                    break;
                            }
                        } else if (currentPhase === 2) {
                            switch (nearestObject.type) {
                                case 'vale_sorvete':
                                    promptText = `VocÃª Ã© um vale sorvete, muito desejado na Festa do Sorvete. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e alegre.`;
                                    break;
                                case 'sorvete':
                                    promptText = `VocÃª Ã© um sorvete de ${nearestObject.color}, um dos sabores que o Ursinho AmigÃ£o precisa para o objetivo da festa. O que vocÃª diria para ele? Seja breve e convidativo.`;
                                    break;
                            }
                        } else if (currentPhase === 3) {
                            switch (nearestObject.type) {
                                case 'trofeu':
                                    promptText = `VocÃª Ã© um trofÃ©u brilhante, um dos prÃªmios das brincadeiras do parque. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e inspirador.`;
                                    break;
                                case 'bola':
                                    promptText = `VocÃª Ã© uma bola, usada para brincadeiras no parque. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e divertido.`;
                                    break;
                            }
                        } else if (currentPhase === 4) {
                            switch (nearestObject.type) {
                                case 'tubo_ensaio':
                                    promptText = `VocÃª Ã© um tubo de ensaio, essencial para as experiÃªncias no laboratÃ³rio. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e curioso.`;
                                    break;
                                case 'ima':
                                    promptText = `VocÃª Ã© um Ã­mÃ£, parte das experiÃªncias de forÃ§a magnÃ©tica. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e atraente.`;
                                    break;
                            }
                        } else if (currentPhase === 5) {
                            switch (nearestObject.type) {
                                case 'elefante':
                                    promptText = `VocÃª Ã© um elefante, um dos animais majestosos do zoolÃ³gico. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e imponente.`;
                                    break;
                                case 'leao':
                                    promptText = `VocÃª Ã© um leÃ£o, o rei da selva! O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e rÃ©gio.`;
                                    break;
                                case 'ave':
                                    promptText = `VocÃª Ã© uma ave exÃ³tica, com cores vibrantes. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e melÃ³dico.`;
                                    break;
                            }
                        } else if (currentPhase === 6) {
                            switch (nearestObject.type) {
                                case 'pintura':
                                    promptText = `VocÃª Ã© uma pintura, uma obra de arte no museu. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e artÃ­stico.`;
                                    break;
                                case 'escultura':
                                    promptText = `VocÃª Ã© uma escultura, uma obra de arte tridimensional. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e imponente.`;
                                    break;
                                case 'fossil':
                                    promptText = `VocÃª Ã© um fÃ³ssil de dinossauro, um vestÃ­gio da prÃ©-histÃ³ria. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e misterioso.`;
                                    break;
                            }
                        } else if (currentPhase === 7) {
                            switch (nearestObject.type) {
                                case 'cesta_piquenique':
                                    promptText = `VocÃª Ã© uma cesta de piquenique, cheia de delÃ­cias para compartilhar no parque. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convidativo.`;
                                    break;
                                case 'bola':
                                    promptText = `VocÃª Ã© uma bola de futebol, pronta para um jogo divertido no parque. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e enÃ©rgico.`;
                                    break;
                                case 'brinquedo_parque':
                                    promptText = `VocÃª Ã© um brinquedo do parque, que traz muita alegria. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e divertido.`;
                                    break;
                            }
                        } else if (currentPhase === 8) { // Dicas para o CapÃ­tulo 8
                            switch (nearestObject.type) {
                                case 'livro_aberto':
                                    promptText = `VocÃª Ã© um livro aberto, cheio de histÃ³rias. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convide-o para ler.`;
                                    break;
                                case 'oculos':
                                    promptText = `VocÃª Ã© um par de Ã³culos de leitura. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que eles ajudam a ver melhor as palavras.`;
                                    break;
                                case 'caneta':
                                    promptText = `VocÃª Ã© uma caneta, pronta para escrever. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e inspire-o a criar suas prÃ³prias histÃ³rias.`;
                                    break;
                                case 'globo':
                                    promptText = `VocÃª Ã© um globo terrestre. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que hÃ¡ muitas histÃ³rias para descobrir ao redor do mundo.`;
                                    break;
                                default:
                                    promptText = `VocÃª Ã© um item da sala de leitura. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e relacionado Ã  leitura.`;
                            }
                        } else if (currentPhase === 9) { // Dicas para o CapÃ­tulo 9
                            switch (nearestObject.type) {
                                case 'lixeira_reciclagem':
                                    promptText = `VocÃª Ã© uma lixeira de reciclagem. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e incentive a separaÃ§Ã£o do lixo.`;
                                    break;
                                case 'garrafa_plastico':
                                    promptText = `VocÃª Ã© uma garrafa de plÃ¡stico. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que vocÃª pode ser reciclada.`;
                                    break;
                                case 'arvore_muda':
                                    promptText = `VocÃª Ã© uma muda de Ã¡rvore. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convide-o a te plantar para um futuro verde.`;
                                    break;
                                case 'saco_lixo':
                                    promptText = `VocÃª Ã© um saco de lixo. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que vocÃª precisa ser descartado corretamente.`;
                                    break;
                                default:
                                    promptText = `VocÃª Ã© um item relacionado ao meio ambiente. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e incentive o cuidado com o planeta.`;
                            }
                        } else if (currentPhase === 10) { // Dicas para o CapÃ­tulo 10
                            switch (nearestObject.type) {
                                case 'planta_nativa':
                                    promptText = `VocÃª Ã© uma planta nativa da reserva. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e fale sobre a sua importÃ¢ncia no ecossistema.`;
                                    break;
                                case 'animal_selvagem':
                                    promptText = `VocÃª Ã© um animal selvagem. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e fale sobre a importÃ¢ncia de proteger seu habitat.`;
                                    break;
                                case 'binoculos':
                                    promptText = `VocÃª Ã© um binÃ³culo. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que vocÃª ajuda a observar a natureza de perto.`;
                                    break;
                                case 'lupa':
                                    promptText = `VocÃª Ã© uma lupa. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que vocÃª ajuda a ver os pequenos detalhes da natureza.`;
                                    break;
                                default:
                                    promptText = `VocÃª Ã© um item da reserva natural. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e incentive a exploraÃ§Ã£o e o respeito pela natureza.`;
                            }
                        } else if (currentPhase === 11) { // Dicas para o CapÃ­tulo 11
                            switch (nearestObject.type) {
                                case 'pincel':
                                    promptText = `VocÃª Ã© um pincel, pronto para criar uma obra de arte. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convide-o a pintar.`;
                                    break;
                                case 'tinta':
                                    promptText = `VocÃª Ã© uma tinta colorida. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que vocÃª pode dar vida aos desenhos.`;
                                    break;
                                case 'argila':
                                    promptText = `VocÃª Ã© um pedaÃ§o de argila, esperando para ser moldado. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e inspire-o a criar uma escultura.`;
                                    break;
                                case 'lapis_cor':
                                    promptText = `VocÃª Ã© um lÃ¡pis de cor vibrante. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convide-o a colorir o mundo.`;
                                    break;
                                case 'tela':
                                    promptText = `VocÃª Ã© uma tela em branco, esperando por uma obra-prima. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e incentive-o a expressar sua criatividade.`;
                                    break;
                                default:
                                    promptText = `VocÃª Ã© um material de arte. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e incentive a criatividade.`;
                            }
                        } else if (currentPhase === 12) { // Dicas para o CapÃ­tulo 12
                            switch (nearestObject.type) {
                                case 'violao':
                                    promptText = `VocÃª Ã© um violÃ£o. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convide-o a tocar uma melodia.`;
                                    break;
                                case 'piano':
                                    promptText = `VocÃª Ã© um piano. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que ele explore as teclas.`;
                                    break;
                                case 'microfone':
                                    promptText = `VocÃª Ã© um microfone. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convide-o a cantar.`;
                                    break;
                                case 'fones_ouvido':
                                    promptText = `VocÃª Ã© um par de fones de ouvido. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que ele ouÃ§a a mÃºsica com atenÃ§Ã£o.`;
                                    break;
                                case 'partitura':
                                    promptText = `VocÃª Ã© uma partitura musical. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sugira que vocÃª contÃ©m os segredos da mÃºsica.`;
                                    break;
                                default:
                                    promptText = `VocÃª Ã© um item musical. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e incentive a mÃºsica e a danÃ§a.`;
                            }
                        }
                    } else { // Itens coletÃ¡veis nÃ£o-objetivo
                        switch (nearestObject.type) {
                            case 'moeda':
                                promptText = `VocÃª Ã© uma moeda brilhante. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? DÃª uma dica sutil sobre sua utilidade, mas que nÃ£o Ã© crucial para o objetivo principal.`;
                                break;
                            case 'folha':
                                promptText = `VocÃª Ã© uma folha encantada. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? DÃª uma dica sutil sobre sua beleza, mas que nÃ£o Ã© crucial para o objetivo principal.`;
                                break;
                            case 'lapis':
                                promptText = `VocÃª Ã© um lÃ¡pis. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e descreva sua funÃ§Ã£o na escola.`;
                                break;
                            case 'caderno':
                                promptText = `VocÃª Ã© um caderno. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e descreva sua funÃ§Ã£o na escola.`;
                                break;
                            case 'sorvete': // Sorvetes nÃ£o-objetivo
                                promptText = `VocÃª Ã© um delicioso sorvete de sabor ${nearestObject.color}. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convidativo.`;
                                break;
                            case 'bola':
                                promptText = `VocÃª Ã© uma bola de futebol. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convide-o para brincar.`;
                                break;
                            case 'pipa':
                                promptText = `VocÃª Ã© uma pipa colorida. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convide-o para te empinar no cÃ©u.`;
                                break;
                            case 'bequer':
                                promptText = `VocÃª Ã© um bÃ©quer, usado para misturar lÃ­quidos no laboratÃ³rio. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e cientÃ­fico.`;
                                break;
                            case 'microscopio':
                                promptText = `VocÃª Ã© um microscÃ³pio, que ajuda a ver coisas muito pequenas. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e curioso.`;
                                break;
                            case 'pipeta':
                                promptText = `VocÃª Ã© uma pipeta, usada para medir lÃ­quidos com precisÃ£o. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e exato.`;
                                break;
                            case 'macaco':
                                promptText = `VocÃª Ã© um macaco travesso. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e brincalhÃ£o.`;
                                break;
                            case 'crocodilo':
                                promptText = `VocÃª Ã© um crocodilo. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e um pouco assustador.`;
                                break;
                            case 'cobra':
                                promptText = `VocÃª Ã© uma cobra. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e sutil.`;
                                break;
                            case 'lagarto':
                                promptText = `VocÃª Ã© um lagarto. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e rÃ¡pido.`;
                                break;
                            case 'artefato':
                                promptText = `VocÃª Ã© um artefato antigo. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e misterioso, sobre sua histÃ³ria.`;
                                break;
                            case 'pincel':
                                promptText = `VocÃª Ã© um pincel. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e descreva sua funÃ§Ã£o na arte.`;
                                break;
                            case 'livro_arte':
                                promptText = `VocÃª Ã© um livro de arte. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e inspire-o com a beleza da arte.`;
                                break;
                            case 'balao':
                                promptText = `VocÃª Ã© um balÃ£o colorido, flutuando levemente. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e alegre.`;
                                break;
                            case 'flor':
                                promptText = `VocÃª Ã© uma flor do parque, exalando um perfume suave. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e convidativo.`;
                                break;
                            case 'borboleta':
                                promptText = `VocÃª Ã© uma borboleta, voando livremente pelo parque. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e encantador.`;
                                break;
                            default:
                                promptText = `VocÃª Ã© um item coletÃ¡vel. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? DÃª uma dica sutil sobre sua utilidade, mas que nÃ£o Ã© crucial para o objetivo principal.`; // Mensagem mais genÃ©rica
                        }
                    }
                } else if (nearestObject.type === 'bau') {
                    if (hasKey && pedrasColetadas === TOTAL_PEDRAS) {
                        promptText = `VocÃª Ã© um baÃº de tesouros. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima com todos os itens do objetivo? Seja breve e indique que a aventura estÃ¡ prestes a ser concluÃ­da.`;
                    } else if (hasKey) {
                        promptText = `VocÃª Ã© um baÃº de tesouros. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima com a chave, mas sem todos os outros itens do objetivo? Seja breve e indique que algo importante estÃ¡ faltando.`;
                    } else {
                        promptText = `VocÃª Ã© um baÃº de tesouros. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima sem a chave? Seja breve e indique que a chave Ã© necessÃ¡ria.`;
                    }
                } else { // Itens escolares nÃ£o coletÃ¡veis
                    switch (nearestObject.type) {
                        case 'livro':
                            promptText = `VocÃª Ã© um livro. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e descreva sua funÃ§Ã£o na escola.`;
                            break;
                        case 'borracha':
                            promptText = `VocÃª Ã© uma borracha. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e descreva sua funÃ§Ã£o na escola.`;
                            break;
                        case 'mochila':
                            promptText = `VocÃª Ã© uma mochila. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e descreva sua funÃ§Ã£o na escola.`;
                            break;
                        default:
                            promptText = `VocÃª Ã© um item comum da escola. O que vocÃª diria para o Ursinho AmigÃ£o que se aproxima? Seja breve e descreva sua funÃ§Ã£o na escola.`;
                    }
                }
            }

            if (!objectFound) {
                hintMessageDiv.innerText = "NÃ£o hÃ¡ objetos por perto para pedir uma dica.";
                hintTimeout = setTimeout(() => hintMessageDiv.style.display = 'none', 3000); // Esconde apÃ³s 3 segundos
                return;
            }

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: promptText }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Deixe como estÃ¡, a Canvas fornecerÃ¡ em tempo de execuÃ§Ã£o
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json(); // AWAIT AQUI

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    hintMessageDiv.innerText = text; // Exibe a dica gerada
                } else {
                    hintMessageDiv.innerText = "NÃ£o foi possÃ­vel obter a dica. Tente novamente.";
                    console.error("Estrutura de resposta LLM inesperada:", result);
                }
            } catch (error) {
                hintMessageDiv.innerText = "Erro ao conectar com a API de dicas. Tente novamente.";
                    console.error("Erro ao chamar a API Gemini para dica:", error);
            } finally {
                hintTimeout = setTimeout(() => hintMessageDiv.style.display = 'none', 5000); // Esconde a dica apÃ³s 5 segundos
            }
        }

        // Atualiza a exibiÃ§Ã£o do HUD
        function atualizarHUD() {
            let coracao = "â¤ï¸".repeat(vidas); // Exibe coraÃ§Ãµes com base nas vidas
            let hudObjectiveLine1Content = '';
            let hudObjectiveLine2Content = ''; // Para objetivos com duas linhas no HUD

            // ConteÃºdo do HUD principal (canto superior esquerdo)
            if (currentPhase === 1) {
                hudObjectiveLine1Content = `ğŸ”´ Pedras: ${pedrasColetadas} / ${TOTAL_PEDRAS}`;
                hudObjectiveLine2Content = `ğŸ”‘ Chave: ${hasKey ? '1/1' : '0/1'}`; // Always show 0/1 or 1/1 for objective
            } else if (currentPhase === 2) {
                hudObjectiveLine1Content = `ğŸŸï¸ Vales Sorvete: ${valesSorveteColetados} / ${TOTAL_VALES_SORVETE}`;
                hudObjectiveLine2Content = `ğŸ«ğŸ¦ Sorvetes: ${sorvetesObjetivoColetados} / ${TOTAL_SORVETES_OBJETIVO}`;
            } else if (currentPhase === 3) {
                hudObjectiveLine1Content = `ğŸ† TrofÃ©us: ${trofeusColetados} / ${TOTAL_TROFEUS}`;
                hudObjectiveLine2Content = `âš½ Bolas: ${bolasColetadas} / ${TOTAL_BOLAS_FASE3}`;
            } else if (currentPhase === 4) {
                hudObjectiveLine1Content = `ğŸ§ª Tubos Ensaio: ${tubosEnsaioColetados} / ${TOTAL_TUBOS_ENSAIO}`;
                hudObjectiveLine2Content = `ğŸ§² ÃmÃ£s: ${imasColetados} / ${TOTAL_IMAS}`;
            } else if (currentPhase === 5) {
                hudObjectiveLine1Content = `ğŸ˜ Elefantes: ${elefantesColetados} / ${TOTAL_ELEFANTES}`;
                hudObjectiveLine2Content = `ğŸ¦ LeÃµes: ${leoesColetados} / ${TOTAL_LEOES}<br>ğŸ¦œ Aves: ${avesColetadas} / ${TOTAL_AVES}`;
            } else if (currentPhase === 6) {
                hudObjectiveLine1Content = `ğŸ¨ Pinturas: ${pinturasColetadas} / ${TOTAL_PINTURAS}`;
                hudObjectiveLine2Content = `ğŸ—¿ Esculturas: ${esculturasColetadas} / ${TOTAL_ESCULTURAS}<br>ğŸ¦´ FÃ³sseis: ${fosseisColetados} / ${TOTAL_FOSSEIS}`;
            } else if (currentPhase === 7) {
                hudObjectiveLine1Content = `ğŸ§º Cestas Piquenique: ${cestasPiqueniqueColetadas} / ${TOTAL_CESTAS_PIQUENIQUE}`;
                hudObjectiveLine2Content = `âš½ Bolas: ${bolasFase7Coletadas} / ${TOTAL_BOLAS_FASE7}<br>ğŸ  Brinquedos: ${brinquedosParqueColetados} / ${TOTAL_BRINQUEDOS_PARQUE}`;
            } else if (currentPhase === 8) {
                hudObjectiveLine1Content = `ğŸ“– Leitura: ${leiturinhasColetadas} / ${TOTAL_LEITURINHAS}`;
                hudObjectiveLine2Content = ``; // Sem segundo objetivo explÃ­cito para esta fase
            } else if (currentPhase === 9) {
                hudObjectiveLine1Content = `â™»ï¸ Planeta: ${planetaItemsColetados} / ${TOTAL_PLANETA_ITEMS}`;
                hudObjectiveLine2Content = ``; // Sem segundo objetivo explÃ­cito para esta fase
            } else if (currentPhase === 10) {
                hudObjectiveLine1Content = `ğŸŒ¿ Natureza: ${naturezaExploracaoColetados} / ${TOTAL_NATUREZA_EXPLORACAO}`;
                hudObjectiveLine2Content = ``; // Sem segundo objetivo explÃ­cito para esta fase
            } else if (currentPhase === 11) {
                hudObjectiveLine1Content = `ğŸ¨ Artes: ${artesItemsColetados} / ${TOTAL_ARTES_ITEMS}`;
                hudObjectiveLine2Content = ``; // Sem segundo objetivo explÃ­cito para esta fase
            } else if (currentPhase === 12) {
                hudObjectiveLine1Content = `ğŸµ MÃºsica: ${musicaDancaColetados} / ${TOTAL_MUSICA_DANCA}`;
                hudObjectiveLine2Content = ``; // Sem segundo objetivo explÃ­cito para esta fase
            }

            // Atualiza o texto dos elementos do HUD
            if (vidasDisplayElement) vidasDisplayElement.innerText = `Vidas: ${coracao}`; // Adiciona o rÃ³tulo "Vidas:"
            if (hudObjectiveLine1Element) hudObjectiveLine1Element.innerHTML = hudObjectiveLine1Content;
            if (hudObjectiveLine2Element) hudObjectiveLine2Element.innerHTML = hudObjectiveLine2Content;
            if (totalAllItemsCollectedDisplayElement) totalAllItemsCollectedDisplayElement.innerText = `Total Coletado: ${totalAllItemsCollected}`;
            if (tempoDisplayElement) tempoDisplayElement.innerText = `Tempo: ${tempo}s`; // Adiciona o rÃ³tulo "Tempo:"
            // Removido: hudKeyStatusElement.innerText = (currentPhase === 1 && hasKey) ? `Chave: Sim` : '';
            // A linha da chave Ã© agora parte de hudObjectiveLine2Content na Fase 1
        }

        // Exibe a mensagem de fim de jogo em um modal e recarrega
        function encerrar(msg) {
            console.log("Encerrar chamado com mensagem:", msg); // Log de depuraÃ§Ã£o
            clearInterval(gameInterval); // Para o temporador do jogo
            document.getElementById('llmHintMessage').style.display = 'none'; // Oculta a mensagem de dica LLM
            if (hintTimeout) clearTimeout(hintTimeout); // Limpa qualquer timeout de dica

            const modal = document.getElementById('gameModal');
            document.getElementById('modalMessage').innerText = msg;
            modal.style.display = 'flex'; // Mostra o modal
        }

        // Exibe uma mensagem temporÃ¡ria no centro da tela
        function showTemporaryMessage(msg, duration) {
            const tempMessageDiv = document.getElementById('temporaryMessage');
            tempMessageDiv.innerText = msg;
            tempMessageDiv.style.display = 'block';
            setTimeout(() => {
                tempMessageDiv.style.display = 'none';
            }, duration);
        }

        // Exibe a tela de continue
        function showContinueScreen() {
            document.getElementById('continueModal').style.display = 'flex';
            continueTime = 10; // Reinicia o contador
            document.getElementById('continueCountdown').innerText = continueTime;

            if (continueCountdownInterval) clearInterval(continueCountdownInterval);
            continueCountdownInterval = setInterval(() => {
                continueTime--;
                document.getElementById('continueCountdown').innerText = continueTime;
                if (continueTime <= 0) {
                    clearInterval(continueCountdownInterval);
                    handleContinue('nao'); // Se o tempo acabar, Ã© como se clicasse em "NÃ£o"
                }
            }, 1000);
        }

        // Lida com a escolha do jogador na tela de continue
        function handleContinue(choice) {
            clearInterval(continueCountdownInterval);
            document.getElementById('continueModal').style.display = 'none';

            if (choice === 'sim') {
                console.log("DEBUG: Jogador escolheu SIM. Reiniciando para seleÃ§Ã£o de personagem.");
                vidas = 3; // Restaura vidas
                // Mostra a tela de seleÃ§Ã£o de personagem
                document.getElementById('personagemSelecao').style.display = 'flex';
                // Limpa o canvas para a prÃ³xima inicializaÃ§Ã£o
                if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpa o canvas se jÃ¡ foi inicializado
                // Reinicia todas as variÃ¡veis do jogo para um novo comeÃ§o
                pedrasColetadas = 0;
                valesSorveteColetados = 0;
                sorvetesObjetivoColetados = 0;
                trofeusColetados = 0;
                bolasColetadas = 0;
                tubosEnsaioColetados = 0;
                imasColetados = 0;
                elefantesColetados = 0;
                leoesColetados = 0;
                avesColetadas = 0;
                pinturasColetadas = 0;
                esculturasColetadas = 0;
                fosseisColetados = 0;
                cestasPiqueniqueColetadas = 0;
                bolasFase7Coletadas = 0;
                brinquedosParqueColetados = 0;
                totalAllItemsCollected = 0;
                leiturinhasColetadas = 0; // Reinicia para a nova fase
                planetaItemsColetados = 0; // Reinicia para a nova fase
                naturezaExploracaoColetados = 0; // Reinicia para a nova fase
                artesItemsColetados = 0; // Reinicia para a nova fase
                musicaDancaColetados = 0; // Reinicia para a nova fase
                tempo = 90; // RE-ADICIONADO
                coletando = false;
                hasKey = false;
                itens = [];
                obstaculos = [];
                schoolItems = [];
                chest = null;
                currentPhase = 1; // Reseta para a Fase 1
                // O iniciar serÃ¡ chamado novamente quando o personagem for selecionado
            } else {
                console.log("DEBUG: Jogador escolheu NÃƒO ou tempo esgotou. Recarrega a pÃ¡gina.");
                location.reload(); // Recarrega a pÃ¡gina para reiniciar completamente
            }
        }

        // Loop principal de animaÃ§Ã£o do jogo 2D
        function animar(currentTime) {
            requestAnimationFrame(animar);

            // Limitar FPS
            if (currentTime < lastFrameTime + frameInterval) {
                return;
            }
            lastFrameTime = currentTime;

            // A condiÃ§Ã£o de parada agora Ã© mais complexa, entÃ£o a verificamos no inÃ­cio
            let winConditionMet = false;
            if (currentPhase === 1) {
                winConditionMet = (pedrasColetadas === TOTAL_PEDRAS && hasKey && chest === null);
            } else if (currentPhase === 2) {
                winConditionMet = (valesSorveteColetados === TOTAL_VALES_SORVETE && sorvetesObjetivoColetados === TOTAL_SORVETES_OBJETIVO);
            } else if (currentPhase === 3) {
                winConditionMet = (trofeusColetados === TOTAL_TROFEUS && bolasColetadas === TOTAL_BOLAS_FASE3);
            } else if (currentPhase === 4) {
                winConditionMet = (tubosEnsaioColetados === TOTAL_TUBOS_ENSAIO && imasColetados === TOTAL_IMAS);
            } else if (currentPhase === 5) {
                winConditionMet = (elefantesColetados === TOTAL_ELEFANTES && leoesColetados === TOTAL_LEOES && avesColetadas === TOTAL_AVES);
            } else if (currentPhase === 6) {
                winConditionMet = (pinturasColetadas === TOTAL_PINTURAS && esculturasColetadas === TOTAL_ESCULTURAS && fosseisColetados === TOTAL_FOSSEIS);
            } else if (currentPhase === 7) {
                winConditionMet = (cestasPiqueniqueColetadas === TOTAL_CESTAS_PIQUENIQUE && bolasFase7Coletadas === TOTAL_BOLAS_FASE7 && brinquedosParqueColetados === TOTAL_BRINQUEDOS_PARQUE);
            } else if (currentPhase === 8) {
                winConditionMet = (leiturinhasColetadas >= TOTAL_LEITURINHAS);
            } else if (currentPhase === 9) {
                winConditionMet = (planetaItemsColetados >= TOTAL_PLANETA_ITEMS);
            } else if (currentPhase === 10) {
                winConditionMet = (naturezaExploracaoColetados >= TOTAL_NATUREZA_EXPLORACAO);
            } else if (currentPhase === 11) {
                winConditionMet = (artesItemsColetados >= TOTAL_ARTES_ITEMS);
            } else if (currentPhase === 12) {
                winConditionMet = (musicaDancaColetados >= TOTAL_MUSICA_DANCA);
            }

            if (vidas <= 0 || tempo <= 0 || winConditionMet) { // CondiÃ§Ã£o de tempo RE-ADICIONADA
                // A lÃ³gica de encerramento/transiÃ§Ã£o de fase Ã© tratada no setInterval
                return;
            }

            // Limpa o canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Guarda a posiÃ§Ã£o anterior do jogador para reverter em caso de colisÃ£o com obstÃ¡culo
            const prevX = player.x;
            const prevY = player.y;

            // Atualiza a posiÃ§Ã£o do jogador com base nas teclas pressionadas
            if (teclas["w"]) player.y -= PLAYER_SPEED;
            if (teclas["s"]) player.y += PLAYER_SPEED;
            if (teclas["a"]) player.x -= PLAYER_SPEED;
            if (teclas["d"]) player.x += PLAYER_SPEED;

            // Limita a posiÃ§Ã£o do jogador para permanecer dentro dos limites do canvas
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
            player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));

            // Verifica colisÃ£o com obstÃ¡culos e reverte a posiÃ§Ã£o se houver colisÃ£o
            obstaculos.forEach(obstacle => {
                if (obstacle.isObstacle && checkCollision(player, obstacle)) { // Verifica se Ã© um obstÃ¡culo real
                    // Reverte a posiÃ§Ã£o do jogador
                    player.x = prevX;
                    player.y = prevY;
                }
            });

            // Realiza as interaÃ§Ãµes (coleta, baÃº)
            handleInteractions();

            // Ordem de desenho para simular profundidade:
            // 1. BaÃº (fundo - apenas na Fase 1)
            if (chest && currentPhase === 1) {
                drawItem(chest);
            }
            // 2. Itens escolares (fundo)
            schoolItems.forEach(drawItem);
            // 3. ObstÃ¡culos (fundo)
            obstaculos.forEach(drawItem);
            // 4. Itens coletÃ¡veis (para que o jogador possa passar "por cima" deles)
            itens.forEach(drawItem);
            // 5. Jogador (sempre por cima)
            drawPlayer();

            // DepuraÃ§Ã£o: Log da posiÃ§Ã£o do jogador e estado das teclas
            // console.log(`DEBUG: Player Pos: (${player.x.toFixed(0)}, ${player.y.toFixed(0)}) | Teclas: W:${teclas.w} A:${teclas.a} S:${teclas.s} D:${teclas.d} | Speed: ${PLAYER_SPEED} | Phase: ${currentPhase}`);
        }

        // FunÃ§Ã£o para atualizar o tÃ­tulo da pÃ¡gina com base na fase atual
        function updatePageTitle(phase) {
            let title = "Ursinho AmigÃ£o 2D - ";
            switch (phase) {
                case 1:
                    title += "CapÃ­tulo 1: Uma Aventura de Aprendizados";
                    break;
                case 2:
                    title += "CapÃ­tulo 2: A Festa do Sorvete";
                    break;
                case 3:
                    title += "CapÃ­tulo 3: Brincadeira de CrianÃ§a";
                    break;
                case 4:
                    title += "CapÃ­tulo 4: Nem Todo Dia Ã© Brincadeira, mas TambÃ©m Ã©...";
                    break;
                case 5:
                    title += "CapÃ­tulo 5: No Reino dos Animais";
                    break;
                case 6:
                    title += "CapÃ­tulo 6: Aprender Ã© uma Arte";
                    break;
                case 7:
                    title += "CapÃ­tulo 7: Lazer no Parque"; // Novo tÃ­tulo para Fase 7
                    break;
                case 8:
                    title += "CapÃ­tulo 8: Leiturinhas"; // Novo tÃ­tulo para Fase 8
                    break;
                case 9:
                    title += "CapÃ­tulo 9: Planeta"; // Novo tÃ­tulo para Fase 9
                    break;
                case 10:
                    title += "CapÃ­tulo 10: ExploraÃ§Ã£o da Natureza"; // Novo tÃ­tulo para Fase 10
                    break;
                case 11:
                    title += "CapÃ­tulo 11: Oficina de Artes"; // Novo tÃ­tulo para Fase 11
                    break;
                case 12:
                    title += "CapÃ­tulo 12: MÃºsica e DanÃ§a"; // Novo tÃ­tulo para Fase 12
                    break;
                default:
                    title += "Aventura Desconhecida";
            }
            document.title = title;
            if (chapterTitleDisplayElement) {
                chapterTitleDisplayElement.innerText = title.split(" - ")[1]; // Exibe apenas o nome do capÃ­tulo
            }
        }

        // Inicia o loop de animaÃ§Ã£o quando a janela carrega
        window.onload = function () {
            // Get global references to HUD elements
            vidasDisplayElement = document.getElementById('vidasDisplay');
            hudObjectiveLine1Element = document.getElementById('hudObjectiveLine1');
            hudObjectiveLine2Element = document.getElementById('hudObjectiveLine2');
            totalAllItemsCollectedDisplayElement = document.getElementById('totalAllItemsCollectedDisplay');
            tempoDisplayElement = document.getElementById('tempo');
            hudKeyStatusElement = document.getElementById('hudKeyStatus');
            chapterTitleDisplayElement = document.getElementById('chapterTitleDisplay');
            objetivoFaseElement = document.getElementById('objetivoFase'); // This element is hidden, but still referenced for consistency.

            // Garante que os modais estejam ocultos ao carregar
            document.getElementById('gameModal').style.display = 'none';
            document.getElementById('llmHintMessage').style.display = 'none';
            document.getElementById('continueModal').style.display = 'none';
            document.getElementById('temporaryMessage').style.display = 'none';
            // Oculta o HUD inicialmente na tela de seleÃ§Ã£o de personagem
            if (document.getElementById('hud')) {
                document.getElementById('hud').style.display = 'none';
            }
            console.log("DEBUG: Modais ocultados ao carregar. HUD oculto.");

            // Adiciona ouvintes de eventos para a seleÃ§Ã£o de personagem
            document.getElementById('personagemUrso').addEventListener('click', () => selecionar('urso'));
            document.getElementById('personagemGato').addEventListener('click', () => selecionar('gato'));
            document.getElementById('personagemGirafa').addEventListener('click', () => selecionar('girafa'));
            document.getElementById('personagemCoelho').addEventListener('click', () => selecionar('coelho'));

            // Adiciona ouvintes de eventos para os botÃµes direcionais (toque)
            document.getElementById('btnUp').addEventListener('touchstart', (e) => { e.preventDefault(); tecla('w', true); /* console.log("DEBUG: Touch Up START"); */ });
            document.getElementById('btnUp').addEventListener('touchend', (e) => { e.preventDefault(); tecla('w', false); /* console.log("DEBUG: Touch Up END"); */ });
            document.getElementById('btnLeft').addEventListener('touchstart', (e) => { e.preventDefault(); tecla('a', true); /* console.log("DEBUG: Touch Left START"); */ });
            document.getElementById('btnLeft').addEventListener('touchend', (e) => { e.preventDefault(); tecla('a', false); /* console.log("DEBUG: Touch Left END"); */ });
            document.getElementById('btnDown').addEventListener('touchstart', (e) => { e.preventDefault(); tecla('s', true); /* console.log("DEBUG: Touch Down START"); */ });
            document.getElementById('btnDown').addEventListener('touchend', (e) => { e.preventDefault(); tecla('s', false); /* console.log("DEBUG: Touch Down END"); */ });
            document.getElementById('btnRight').addEventListener('touchstart', (e) => { e.preventDefault(); tecla('d', true); /* console.log("DEBUG: Touch Right START"); */ });
            document.getElementById('btnRight').addEventListener('touchend', (e) => { e.preventDefault(); tecla('d', false); /* console.log("DEBUG: Touch Right END"); */ });

            // Adiciona ouvintes de eventos para o teclado (W, A, S, D)
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                // Verifica se a tecla Ã© uma das direcionais ou espaÃ§o
                if (['w', 'a', 's', 'd', ' '].includes(key)) {
                    e.preventDefault(); // Previne o comportamento padrÃ£o do navegador (ex: rolagem)
                    if (key === ' ') { // Se for espaÃ§o, ativa/desativa a coleta
                        coletando = true;
                        // console.log("DEBUG: Tecla EspaÃ§o DOWN. Coletando:", coletando);
                    } else { // Caso contrÃ¡rio, Ã© uma tecla direcional
                        tecla(key, true);
                    }
                }
            });
            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                // Verifica se a tecla Ã© uma das direcionais ou espaÃ§o
                if (['w', 'a', 's', 'd', ' '].includes(key)) {
                    e.preventDefault(); // Previne o comportamento padrÃ£o do navegador
                    if (key === ' ') { // Se for espaÃ§o, desativa a coleta
                        coletando = false;
                        // console.log("DEBUG: Tecla EspaÃ§o UP. Coletando:", coletando);
                    } else { // Caso contrÃ¡rio, Ã© uma tecla direcional
                        tecla(key, false);
                    }
                }
            });

            // Adiciona o listener para o botÃ£o de aÃ§Ã£o (toque)
            document.getElementById('botao-acao').addEventListener('touchstart', (e) => { e.preventDefault(); coletando = true; /* console.log("DEBUG: BotÃ£o AÃ§Ã£o START. Coletando:", coletando); */ });
            document.getElementById('botao-acao').addEventListener('touchend', (e) => { e.preventDefault(); coletando = false; /* console.log("DEBUG: BotÃ£o AÃ§Ã£o END. Coletando:", coletando); */ });

            // Adiciona o listener para o novo botÃ£o de dica
            document.getElementById('botao-dica').addEventListener('click', askForHint);

            // Adiciona listeners para os botÃµes do modal de continue
            document.getElementById('btnSim').addEventListener('click', () => handleContinue('sim'));
            document.getElementById('btnNao').addEventListener('click', () => handleContinue('nao'));

            console.log("DEBUG: Ouvintes de seleÃ§Ã£o de personagem, botÃµes direcionais, botÃ£o de dica e botÃµes de continue adicionados.");
            // Foca o canvas para garantir que ele receba eventos de teclado
            document.getElementById('gameCanvas').focus();

            // Chamar atualizarHUD() aqui para garantir que o HUD seja populado com os valores iniciais
            // antes mesmo de uma fase ser iniciada, mas ele estarÃ¡ oculto pelo CSS.
            atualizarHUD();
        };
    </script>
</body>
</html>
