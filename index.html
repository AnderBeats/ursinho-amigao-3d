<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ursinho Amigão 2D - Aventura de Aprendizados</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #aee1f9; /* Fundo azul claro */
            font-family: 'Inter', sans-serif; /* Usando a fonte Inter */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align items to the top initially */
            min-height: 100vh; /* Garante que o corpo ocupa a altura total da viewport */
            position: relative; /* For absolute positioning of intro/selection screens */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        #introScreen, #personagemSelecao {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            background: #aee1f9;
            color: #333;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            cursor: pointer;
        }
        #personagemSelecao {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: none; /* Hidden by default */
        }
        #introImagePlaceholder {
            width: 400px;
            height: 300px;
            background-color: #ffd54f;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8em;
            color: #333;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        #introScreen h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        #introScreen h1 span {
            display: block;
        }
        #introScreen p {
            font-size: 1.5em;
            font-weight: bold;
            color: #34495e;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .personagem-opcoes {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .personagem {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #333;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, background-color 0.2s;
            text-align: center;
            font-size: 3em;
        }
        .personagem:hover {
            background-color: #ffd54f;
            transform: translateY(-5px);
        }
        .personagem span {
            font-size: 0.3em;
            display: block;
            margin-top: 0.2em;
        }

        /* Main game content container */
        @media (max-width: 768px) {
            #mainGameContainer {
                padding-top: 80px; 
            }
        }
        @media (max-width: 360px) {
            #mainGameContainer {
                padding-top: 70px;
            }
        }

        #mainGameContainer {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            box-sizing: border-box;
            padding: 10px;
        }

        #chapterTitleDisplay {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 0 0 8px 8px;
            font-size: 1.2em;
            z-index: 100;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #hud {
            width: 90%;
            max-width: 700px;
            background: rgba(0,0,0,0.4);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            font-size: 1.1em;
            display: flex; /* Sempre flexível quando visível */
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            box-sizing: border-box;
            /* Margens controladas por justify-content: space-around no pai */
        }
        .hud-column {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-basis: 48%;
            padding: 0 5px;
            box-sizing: border-box;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
        }
        .hud-column:last-child {
            align-items: flex-end;
        }

        canvas {
            background-color: #8bc34a;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            display: block;
            margin: 0 auto; /* Centraliza horizontalmente */
            flex-shrink: 0; /* Impede que o canvas encolha abaixo do seu tamanho de conteúdo */
            /* Largura e altura serão definidas dinamicamente pelo JS para manter a proporção 1:1 */
            width: auto;
            height: auto;
        }

        /* Controls positioned fixed relative to viewport */
        #direcional {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .linha {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .botao-direcional, .botao-jogo {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            transition: background 0.2s, transform 0.1s;
            z-index: 10;
        }
        .botao-direcional:active, .botao-jogo:active {
            background: rgba(255,255,255,0.5);
            transform: translateY(2px);
        }
        #botao-acao {
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 10;
            background: rgba(76, 175, 80, 0.3);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        #soundControlBtn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s, transform 0.1s;
        }
        #soundControlBtn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: translateX(-50%) translateY(2px);
        }
        #soundControlBtn svg {
            width: 30px;
            height: 30px;
        }

        /* Overlays/Modals */
        #llmHintMessage, #temporaryMessage, #gameModal, #continueModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
            z-index: 25;
            display: none;
            max-width: 70%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #continueModal {
            z-index: 30;
            background: rgba(0, 0, 0, 0.9);
            flex-direction: column;
        }
        #continueModal h2 { font-size: 2.5em; margin-bottom: 20px; }
        #continueModal p { font-size: 1.8em; margin-bottom: 30px; }
        #continueModal .botoes-continue { display: flex; gap: 20px; }
        #continueModal .botoes-continue button {
            padding: 15px 30px; font-size: 1.5em; border: none; border-radius: 10px;
            cursor: pointer; transition: background-color 0.2s, transform 0.1s;
        }
        #continueModal .botoes-continue button:hover { background-color: #45a049; transform: translateY(-2px); }
        #continueModal #btnSim { background-color: #4CAF50; color: white; }
        #continueModal #btnNao { background-color: #f44336; color: white; }


        /* Media Queries for Mobile Adjustments */
        @media (max-width: 768px) {
            #introImagePlaceholder {
                width: 80vw;
                height: 40vh;
                font-size: 6em;
            }
            #introScreen h1 {
                font-size: 1.8em;
            }
            #introScreen p {
                font-size: 1.2em;
            }
            /* Corrigido para garantir que o HUD e o título não se sobreponham em telas pequenas */
            #mainGameContainer {
                padding-top: 80px; 
            }
            #hud {
                font-size: 0.9em;
                padding: 8px;
                margin-top: 5px; /* Reduced margin for mobile */
                margin-bottom: 5px; /* Reduced margin for mobile */
            }
            .hud-column {
                align-items: flex-start;
            }
            .hud-column:last-child {
                align-items: flex-end;
            }
            .botao-direcional, .botao-jogo {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            #botao-acao {
                width: 60px;
                height: 60px;
                font-size: 26px;
            }
            #direcional {
                bottom: 10px;
                left: 10px;
            }
            #botao-acao {
                bottom: 20px;
                right: 10px;
            }
            #continueModal h2 {
                font-size: 2em;
            }
            #continueModal p {
                font-size: 1.5em;
            }
            #continueModal .botoes-continue button {
                padding: 12px 25px;
                font-size: 1.2em;
            }
        }

        @media (max-width: 360px) {
            #mainGameContainer {
                padding-top: 70px; /* Further adjusted padding-top for very small screens */
            }
            #hud {
                font-size: 0.9em;
                padding: 8px;
                margin-top: 5px;
                margin-bottom: 5px;
                flex-direction: column; /* Stack HUD columns on very small screens */
                align-items: center; /* Center items when stacked */
            }
            .hud-column {
                align-items: center; /* Center text when stacked */
                flex-basis: auto; /* Allow columns to take full width when stacked */
                width: 100%; /* Ensure full width */
            }
            .hud-column:last-child {
                align-items: center; /* Center text when stacked */
            }
            #introScreen h1 {
                font-size: 1.3em;
            }
            #introScreen p {
                font-size: 0.9em;
            }
            .botao-direcional, .botao-jogo {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            #botao-acao {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
            #direcional {
                bottom: 2px;
                left: 2px;
            }
            #botao-acao {
                bottom: 10px;
                right: 2px;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Introdução -->
    <div id="introScreen">
        <div id="introImagePlaceholder">
            🐻
        </div>
        <h1>
            <span>Ursinho Amigão e Seus Amigos em:</span><br>
            <span>Meu Dia na Escola - Parte I</span>
        </h1>
        <p>Pressione qualquer botão para começar</p>
    </div>

    <!-- Tela de Seleção de Personagem -->
    <div id="personagemSelecao">
        <h2>Escolha seu personagem</h2>
        <div class="personagem-opcoes">
            <div class="personagem" id="personagemUrso" style="background:#f4c542;">🐻<br><span>URSINHO<br>AMIGÃO</span></div>
            <div class="personagem" id="personagemGato" style="background:#8bc34a;">🐱<br><span>GATINHO<br>TITO</span></div>
            <div class="personagem" id="personagemGirafa" style="background:#ffb74d;">🦒<br><span>GIRAFINHA<br>GINA</span></div>
            <div class="personagem" id="personagemCoelho" style="background:#e91e63;">🐰<br><span>COELHINHA<br>LILI</span></div>
        </div>
    </div>

    <!-- Título do Capítulo Centralizado -->
    <div id="chapterTitleDisplay"></div>

    <!-- Main Game Content Container -->
    <div id="mainGameContainer">
        <!-- Heads-Up Display (HUD) -->
        <div id="hud">
            <div class="hud-column">
                <span id="vidasDisplay"></span>
                <span id="totalAllItemsCollectedDisplay"></span>
                <span id="tempo"></span>
            </div>
            <div class="hud-column">
                <span id="hudObjectiveLine1"></span>
                <span id="hudObjectiveLine2"></span>
            </div>
        </div>

        <!-- Canvas para o jogo 2D -->
        <canvas id="gameCanvas" tabindex="0"></canvas>
    </div>

    <!-- Container para todos os controles inferiores -->
    <div id="bottomControlsContainer">
        <!-- Controles Direcionais para Celular -->
        <div id="direcional">
            <div class="linha">
                <button class="botao-direcional" id="btnUp">▲</button>
            </div>
            <div class="linha">
                <button class="botao-direcional" id="btnLeft">◄</button>
                <button class="botao-direcional" id="btnDown">▼</button>
                <button class="botao-direcional" id="btnRight">►</button>
            </div>
        </div>

        <!-- Botão de controle de som -->
        <button id="soundControlBtn" class="botao-jogo">
            <svg id="soundOnIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            <svg id="soundOffIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-x" style="display: none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        </button>

        <!-- Botão de Ação para Celular -->
        <button id="botao-acao" class="botao-jogo">A</button>
    </div>

    <!-- Mensagem de Dica LLM -->
    <div id="llmHintMessage" style="display: none;">
        Aguarde a dica...
    </div>

    <!-- Mensagem Temporária (ex: "Vida perdida!") -->
    <div id="temporaryMessage" style="display: none;"></div>

    <!-- Modal de Fim de Jogo/Vitória -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button onclick="location.reload()">Jogar Novamente</button>
        </div>
    </div>

    <!-- Novo Modal de Continue -->
    <div id="continueModal">
        <h2>Fim de Jogo!</h2>
        <p>Você perdeu todas as suas vidas. Deseja continuar do início?</p>
        <p>Tempo restante: <span id="continueCountdown">10</span>s</p>
        <div class="botoes-continue">
            <button id="btnSim">Sim</button>
            <button id="btnNao">Não</button>
        </div>
    </div>

    <!-- Tags de áudio para as trilhas sonoras -->
    <audio id="introMusic" src="https://raw.githack.com/AnderBeats/ursinho-amigao-3d/main/Ursinho%20Trilha/Abertura_Fim.mp3" preload="auto" loop></audio>
    <!-- Removida a tag de música de fase, pois apenas a música de introdução será utilizada por enquanto. -->

    <!-- Script principal do jogo -->
    <script>
        // Mapeamento de nomes de tipo de item para nomes de exibição amigáveis, com acentuação correta.
        const itemDisplayNames = {
            pedra_vermelha: 'Pedra Vermelha',
            pedra_azul: 'Pedra Azul',
            pedra_verde: 'Pedra Verde',
            chave: 'Chaves',
            vale_sorvete: 'Vales Sorvetes',
            sorvete: 'Sorvetes',
            trofeu: 'Troféus',
            bola: 'Bolas',
            pipa: 'Pipas',
            tubo_ensaio: 'Tubos Ensaio',
            ima: 'Ímãs',
            microscopio: 'Microscópios',
            elefante: 'Elefantes',
            leao: 'Leões',
            ave: 'Aves',
            pintura: 'Pinturas',
            escultura: 'Esculturas',
            fossil: 'Fósseis',
            cesta_piquenique: 'Cestas Piquenique',
            bola_fase7: 'Bolas',
            brinquedo_parque: 'Brinquedos de Parque',
            livro_aventura: 'Livros de Aventura',
            livro_animais: 'Livros de Animais',
            livro_fabula: 'Livros de Fábula',
            lixeira_reciclagem: 'Lixeiras de Reciclagem',
            garrafa_plastico: 'Garrafas Plásticas',
            arvore_muda: 'Mudas de Árvore',
            planta_nativa: 'Plantas Nativas',
            animal_selvagem: 'Animais Selvagens',
            telescopio: 'Telescópios',
            pincel: 'Pincéis',
            tinta: 'Tintas',
            argila: 'Argila',
            violao: 'Violão',
            piano: 'Piano',
            microfone: 'Microfones',
            lapis: 'Lápis',
            caderno: 'Caderno',
            mochila: 'Mochilas',
            livro_extra: 'Livros',
            borracha: 'Borrachas'
        };

        // Dados de configuração de cada fase. Isso centraliza a lógica de itens e títulos.
        const phasesData = {
            1: {
                title: "Capítulo 1: Uma Aventura de Aprendizados",
                items: [
                    { type: 'pedra_vermelha', emoji: '🔴', count: 1, isObjective: true, canBeCollected: true },
                    { type: 'pedra_azul', emoji: '🔵', count: 1, isObjective: true, canBeCollected: true },
                    { type: 'pedra_verde', emoji: '🟢', count: 1, isObjective: true, canBeCollected: true },
                    { type: 'chave', emoji: '🔑', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                chest: { type: 'bau', emoji: '📦', size: 0.098, canBeCollected: false, isObjective: true },
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            2: {
                title: "Capítulo 2: A Festa do Sorvete",
                items: [
                    { type: 'vale_sorvete', emoji: '🎟️', count: 4, isObjective: true, canBeCollected: true },
                    { type: 'sorvete', emoji: '🍦', count: 4, isObjective: true, flavors: ['🍓', '🍫', '🍋', '🫐'], canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            3: {
                title: "Capítulo 3: Brincadeira de Criança",
                items: [
                    { type: 'trofeu', emoji: '🏆', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'bola', emoji: '⚽', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'pipa', emoji: '🪁', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            4: {
                title: "Capítulo 4: Nem Todo Dia é Brincadeira, mas Também é...",
                items: [
                    { type: 'tubo_ensaio', emoji: '🧪', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'ima', emoji: '🧲', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'microscopio', emoji: '🔬', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            5: {
                title: "Capítulo 5: No Reino dos Animais",
                items: [
                    { type: 'elefante', emoji: '🐘', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'leao', emoji: '🦁', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'ave', emoji: '🦜', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            6: {
                title: "Capítulo 6: Aprender é uma Arte",
                items: [
                    { type: 'pintura', emoji: '🎨', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'escultura', emoji: '🗿', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'fossil', emoji: '🦴', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            7: {
                title: "Capítulo 7: Lazer no Parque",
                items: [
                    { type: 'cesta_piquenique', emoji: '🧺', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'bola_fase7', emoji: '⚽', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'brinquedo_parque', emoji: '🎠', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            8: {
                title: "Capítulo 8: Leiturinhas",
                items: [
                    { type: 'livro_aventura', emoji: '📖', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'livro_animais', emoji: '🦁', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'livro_fabula', emoji: '📜', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            9: {
                title: "Capítulo 9: Planeta",
                items: [
                    { type: 'lixeira_reciclagem', emoji: '♻️', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'garrafa_plastico', emoji: '🧴', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'arvore_muda', emoji: '🌱', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            10: {
                title: "Capítulo 10: Exploração da Natureza",
                items: [
                    { type: 'planta_nativa', emoji: '🌿', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'animal_selvagem', emoji: '🦁', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'telescopio', emoji: '🔭', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            11: {
                title: "Capítulo 11: Oficina de Artes",
                items: [
                    { type: 'pincel', emoji: '🖌️', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'tinta', emoji: '🎨', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'argila', emoji: '🏺', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            },
            12: {
                title: "Capítulo 12: Música e Dança",
                items: [
                    { type: 'violao', emoji: '🎸', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'piano', emoji: '🎹', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'microfone', emoji: '🎤', count: 3, isObjective: true, canBeCollected: true },
                    { type: 'lapis', emoji: '✏️', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'caderno', emoji: '📓', count: 3, isObjective: false, canBeCollected: true },
                    { type: 'livro_extra', emoji: '📚', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'borracha', emoji: '🧽', count: 5, isObjective: false, canBeCollected: false },
                    { type: 'mochila', emoji: '🎒', count: 5, isObjective: false, canBeCollected: false }
                ],
                obstacles: [
                    { type: 'mesa', emoji: '🟫', count: 3 },
                    { type: 'cadeira', emoji: '🪑', count: 3 },
                    { type: 'armario', emoji: '🚪', count: 3 }
                ],
                moneyBags: 2,
            }
        };

        // Centraliza a lógica do jogo em um objeto global para melhor organização e evitar problemas de escopo.
        const game = {
            canvas: null,
            ctx: null,
            player: null,
            teclas: {}, // Armazena o estado das teclas pressionadas
            itens: [], // Array para todos os itens do jogo (coletáveis, não-coletáveis, etc)
            obstaculos: [], // Array para os obstáculos que bloqueiam o caminho
            chest: null, // O baú do tesouro

            // Contador de itens coletados para a fase atual
            objectiveCounts: {}, 
            
            // Variáveis para o sistema de fases e pontuação
            totalAllItemsCollected: 0, // Nova variável para contar TODOS os itens coletados
            vidas: 3, // Vidas do jogador
            tempo: 90, // Tempo do jogo em segundos (fixo para padronizar)
            coletando: false, // Flag para ação de coleta (coletar item ou usar chave no baú)
            gameInterval: null, // Para o temporador do jogo
            hintTimeout: null, // Para esconder a dica LLM
            continueCountdownInterval: null, // Intervalo para a contagem regressiva do continue
            continueTime: 10, // Tempo inicial da contagem regressiva do continue
            currentPlayerType: '', // Armazena o tipo de personagem selecionado para reinícios
            currentPhase: 1, // Inicia na Fase 1

            // Dynamic sizes based on canvas size
            PLAYER_SIZE: 0, 
            ITEM_SIZE: 0, 
            OBSTACLE_SIZE: 0, 
            SCHOOL_ITEM_SIZE: 0, 
            CHEST_SIZE: 0, 
            PLAYER_SPEED: 1.0, // Velocidade do jogador (padronizado para 1.0)

            // Variáveis para o limitador de FPS
            targetFPS: 60, // FPS alvo (aumentado para uma experiência mais fluida)
            frameInterval: 0, // Intervalo de tempo entre frames em ms (calculado em initGame)
            lastFrameTime: 0, // Initialized globally

            // Global references to HUD elements (set in initGame)
            vidasDisplayElement: null,
            hudObjectiveLine1Element: null,
            hudObjectiveLine2Element: null,
            totalAllItemsCollectedDisplayElement: null,
            tempoDisplayElement: null,
            chapterTitleDisplayElement: null,
            
            // Variáveis de áudio
            introMusicElement: null,
            currentMusic: null, // Para controlar a música que está tocando atualmente

            // Método para tocar uma música, pausando a anterior se houver
            playMusic: function(musicElement) {
                // Se a música atual não é a que queremos tocar ou se não há música tocando, ajusta.
                if (this.currentMusic !== musicElement) {
                    if (this.currentMusic) {
                        this.currentMusic.pause();
                        this.currentMusic.currentTime = 0; // Reinicia a música para o começo
                    }
                    this.currentMusic = musicElement;
                    if (this.currentMusic) {
                        this.currentMusic.play().catch(e => console.log("Erro ao tocar música (pode precisar de interação do usuário):", e));
                    }
                } else if (this.currentMusic && this.currentMusic.paused) {
                    // Se a mesma música já está selecionada mas está pausada, tenta tocar.
                    this.currentMusic.play().catch(e => console.log("Erro ao retomar música (pode precisar de interação do usuário):", e));
                }
            },

            // Método para parar toda a música
            stopAllMusic: function() {
                if (this.currentMusic) {
                    this.currentMusic.pause();
                    this.currentMusic.currentTime = 0;
                    this.currentMusic = null;
                }
            },

            // Método para atualizar o estado da tecla (para teclado e toque)
            tecla: function(k, v) {
                this.teclas[k] = v;
            },

            // Método para redimensionar o canvas
            resizeCanvas: function() {
                if (!this.canvas) return;

                // Get heights of fixed elements
                const chapterTitleElement = document.getElementById('chapterTitleDisplay');
                const hudElement = document.getElementById('hud');
                const direcionalElement = document.getElementById('direcional');
                const botaoAcaoElement = document.getElementById('botao-acao');
                const soundControlElement = document.getElementById('soundControlBtn');

                // Get actual heights of elements that take up vertical space
                const chapterTitleHeight = chapterTitleElement ? chapterTitleElement.offsetHeight : 0;
                const hudHeight = hudElement ? hudElement.offsetHeight : 0;
                const hudMarginTop = hudElement ? parseFloat(getComputedStyle(hudElement).marginTop) : 0;
                const hudMarginBottom = hudElement ? parseFloat(getComputedStyle(hudElement).marginBottom) : 0;
                
                let direcionalHeight = direcionalElement ? direcionalElement.offsetHeight : 0;
                let soundControlHeight = soundControlElement ? soundControlElement.offsetHeight : 0;

                const controlsBottomMargin = 20; // Margin from bottom of controls to viewport edge
                const controlsPadding = 10; // Padding of bottomControlsContainer
                const controlsSpacing = 10; // Spacing between direcional and sound control

                // Calculate the total height of the bottom fixed controls area
                const bottomControlsTotalHeight = Math.max(direcionalHeight, (botaoAcaoElement ? botaoAcaoElement.offsetHeight : 0), soundControlHeight) + controlsBottomMargin + controlsSpacing;

                // Set the top and bottom CSS properties for mainGameContainer
                const mainGameContainer = document.getElementById('mainGameContainer');
                if (mainGameContainer) {
                    // Calculate the desired top for mainGameContainer based on chapterTitleHeight
                    // Adicione um espaçamento fixo de 20px entre o título e o HUD
                    mainGameContainer.style.top = `${chapterTitleHeight + 20}px`;

                    // mainGameContainer ends right above bottom controls
                    mainGameContainer.style.bottom = `${bottomControlsTotalHeight}px`;
                }

                // Recalculate available space for canvas within mainGameContainer.
                // This is the total height of mainGameContainer minus the HUD height and its margins.
                const availableSpaceInMainContainer = mainGameContainer ? mainGameContainer.clientHeight : window.innerHeight; // Fallback
                const availableCanvasHeight = availableSpaceInMainContainer - hudHeight - hudMarginTop - hudMarginBottom; // Subtract HUD height and its padding

                // User explicitly requested a square canvas (1:1 aspect ratio)
                const aspectRatio = 1; // Desired 1:1 aspect ratio (width / height)

                // Determine the maximum possible size for the square canvas
                // It should be limited by both available width and available height
                let newCanvasSize = Math.min(window.innerWidth * 0.95, availableCanvasHeight); // Start with 95vw for mobile, or available height

                // Apply max width limit for desktop
                const maxWidthLimit = 720;
                if (newCanvasSize > maxWidthLimit) {
                    newCanvasSize = maxWidthLimit;
                }
                
                // Apply the 20% reduction to the height/width of the square field
                newCanvasSize = newCanvasSize * 0.80; // Reduce by 20%

                // Set the canvas element's attributes (drawing buffer size)
                this.canvas.width = newCanvasSize;
                this.canvas.height = newCanvasSize;

                // Set the CSS dimensions to match the attributes, ensuring it fits the container
                this.canvas.style.width = `${newCanvasSize}px`;
                this.canvas.style.height = `${newCanvasSize}px`;

                // Update dynamic game object sizes based on new canvas size
                this.PLAYER_SIZE = newCanvasSize * 0.078; // 8% of canvas size, slightly reduced
                this.ITEM_SIZE = newCanvasSize * 0.061; // Adjusted to be smaller (approx 2px reduction from 0.066)
                this.OBSTACLE_SIZE = newCanvasSize * 0.055; // Adjusted to be smaller (approx 2px reduction)
                this.SCHOOL_ITEM_SIZE = newCanvasSize * 0.048; // 5% of canvas size, slightly reduced
                this.CHEST_SIZE = newCanvasSize * 0.098; // 10% of canvas size, slightly reduced
                // PLAYER_SPEED is now a fixed value, not scaled by newCanvasSize

                console.log(`DEBUG: Canvas resized to Width: ${newCanvasSize.toFixed(2)}px, Height: ${newCanvasSize.toFixed(2)}px (1:1 aspect ratio, 20% reduced)`);
                console.log(`DEBUG: Player Size: ${this.PLAYER_SIZE.toFixed(2)}, Item Size: ${this.ITEM_SIZE.toFixed(2)}, Obstacle Size: ${this.OBSTACLE_SIZE.toFixed(2)}`);

                // Reposition player
                if (this.player) {
                    this.player.x = this.canvas.width / 2 - this.player.width / 2;
                    this.player.y = this.canvas.height / 2 - this.player.height / 2;
                }
                // Re-place all game objects as their sizes might have changed
                this.placeGameObjectsRandomly();
            },

            // Retorna o emoji do personagem selecionado
            getCharacterEmoji: function(tipo) {
                switch (tipo) {
                    case 'urso': return '🐻';
                    case 'gato': return '🐱';
                    case 'girafa': return '🦒';
                    case 'coelho': return '🐰';
                    default: return '❓';
                }
            },

            // Cria um objeto de jogo (item, obstáculo, baú, item escolar)
            createGameObject: function(type, emoji, size, canBeCollected, isObstacle, color = null, isObjective = false) {
                return {
                    type: type,
                    emoji: emoji,
                    canBeCollected: canBeCollected, // Se pode ser coletado pelo botão de ação
                    isObstacle: isObstacle,      // Se bloqueia o caminho
                    color: color,
                    isObjective: isObjective,      // Se conta para o objetivo principal
                    x: 0,  
                    y: 0,  
                    size: size,
                    width: size,  
                    height: size  
                };
            },

            // Posiciona todos os objetos no canvas de forma aleatória, evitando sobreposição inicial
            placeGameObjectsRandomly: function() {
                const padding = 20; // Espaçamento das bordas do canvas
                const minX = padding;
                const minY = padding;
                const maxX = this.canvas.width - padding;
                const maxY = this.canvas.height - padding;

                const placedObjects = []; // Para controlar a sobreposição

                // Define uma área segura no centro para o jogador (dinâmica)
                const playerSafeZoneSize = this.PLAYER_SIZE + (4 * this.OBSTACLE_SIZE); // 2x OBSTACLE_SIZE em cada lado do player
                const playerSafeZone = {
                    x: this.canvas.width / 2 - playerSafeZoneSize / 2,
                    y: this.canvas.height / 2 - playerSafeZoneSize / 2,
                    width: playerSafeZoneSize,
                    height: playerSafeZoneSize
                };

                const getRandomPosition = (objSize, isObstacle = false) => {
                    let newX, newY, collision;
                    let attempts = 0;
                    const maxAttempts = 1000; // Aumentado para mais chances de posicionamento
                    // Define a distância mínima de afastamento para objetos (3 vezes o tamanho de um obstáculo)
                    // Diminuído para permitir mais itens visíveis
                    const minClearanceBetweenObjects = 0.6 * this.OBSTACLE_SIZE;  

                    do {
                        collision = false;
                        newX = Math.random() * (maxX - minX - objSize) + minX;
                        newY = Math.random() * (maxY - minY - objSize) + minY;

                        const newRect = { x: newX, y: newY, width: objSize, height: objSize };

                        // Verifica colisão com objetos já posicionados
                        for (const placedObj of placedObjects) {
                            // Calcula a distância mínima necessária entre os centros dos objetos
                            const requiredMinDistanceX = (newRect.width / 2) + (placedObj.width / 2) + minClearanceBetweenObjects;
                            const requiredMinDistanceY = (newRect.height / 2) + (placedObj.height / 2) + minClearanceBetweenObjects;

                            // Verifica se os objetos estão muito próximos
                            if (Math.abs(newRect.x + newRect.width / 2 - (placedObj.x + placedObj.width / 2)) < requiredMinDistanceX &&
                                Math.abs(newRect.y + newRect.height / 2 - (placedObj.y + placedObj.height / 2)) < requiredMinDistanceY) {
                                collision = true;
                                break;
                            }
                        }

                        // Se for um obstáculo ou um item coletável, verifica também colisão com a zona segura do jogador
                        if (!collision && (isObstacle || newRect.canBeCollected) && this.checkCollision(newRect, playerSafeZone)) {
                            collision = true;
                        }

                        attempts++;
                    } while (collision && attempts < maxAttempts);

                    if (attempts === maxAttempts) {
                        console.warn(`AVISO: Não foi possível encontrar uma posição livre para o objeto de tamanho ${objSize} após ${maxAttempts} tentativas. Pode haver sobreposição.`);
                    }
                    return { x: newX, y: newY, width: objSize, height: objSize };
                };

                // Limpa os itens e obstáculos antes de repopular
                this.itens = [];
                this.obstaculos = [];
                this.chest = null;

                const phaseData = phasesData[this.currentPhase];

                // Posicionar obstáculos
                if (phaseData.obstacles) {
                    phaseData.obstacles.forEach(obstacleData => {
                        for (let i = 0; i < obstacleData.count; i++) {
                            const obstacle = this.createGameObject(obstacleData.type, obstacleData.emoji, this.OBSTACLE_SIZE, false, true);
                            const pos = getRandomPosition(obstacle.size, true);
                            obstacle.x = pos.x;
                            obstacle.y = pos.y;
                            this.obstaculos.push(obstacle);
                            placedObjects.push(obstacle);
                        }
                    });
                }

                // Posicionar itens de objetivo e não-objetivo (incluindo lápis e caderno)
                if (phaseData.items) {
                    phaseData.items.forEach(itemData => {
                        for (let i = 0; i < itemData.count; i++) {
                            let emoji = itemData.emoji;
                            // Lógica para sorvetes com sabores
                            if (itemData.type === 'sorvete' && itemData.flavors && itemData.flavors[i]) {
                                emoji = `🍦${itemData.flavors[i]}`;
                            }
                            const item = this.createGameObject(itemData.type, emoji, this.ITEM_SIZE, itemData.canBeCollected, false, null, itemData.isObjective);
                            const pos = getRandomPosition(item.size);
                            item.x = pos.x;
                            item.y = pos.y;
                            this.itens.push(item);
                            placedObjects.push(item);
                        }
                    });
                }
                
                // Posicionar o baú (apenas na Fase 1)
                if (this.currentPhase === 1 && phaseData.chest) {
                    this.chest = this.createGameObject(phaseData.chest.type, phaseData.chest.emoji, this.CHEST_SIZE, phaseData.chest.canBeCollected, false, null, phaseData.chest.isObjective);
                    const pos = getRandomPosition(this.chest.size);
                    this.chest.x = pos.x;
                    this.chest.y = pos.y;
                    placedObjects.push(this.chest);
                }

                // Posicionar sacos de dinheiro
                if (phaseData.moneyBags) {
                    for (let i = 0; i < phaseData.moneyBags; i++) {
                        const moneyBag = this.createGameObject('moeda', '💰', this.ITEM_SIZE, true, false, null, false);
                        const pos = getRandomPosition(moneyBag.size);
                        moneyBag.x = pos.x;
                        moneyBag.y = pos.y;
                        this.itens.push(moneyBag);
                        placedObjects.push(moneyBag);
                    }
                }
            },

            // Desenha um objeto no canvas
            drawItem: function(item) {
                if (!this.ctx) return;
                this.ctx.font = `${item.size}px "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(item.emoji, item.x + item.size / 2, item.y + item.size / 2);
            },

            // Desenha o personagem no canvas
            drawPlayer: function() {
                if (!this.ctx) return;
                this.ctx.font = `${this.player.width}px "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(this.player.emoji, this.player.x + this.player.width / 2, this.player.y + this.player.height / 2);
            },

            // Verifica colisão entre dois retângulos (AABB)
            checkCollision: function(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            },

            // Lógica de interações (coleta de itens, colisão com obstáculos, interação com o baú)
            handleInteractions: function() {
                // Oculta qualquer dica LLM ativa ao interagir
                const hintMessageDiv = document.getElementById('llmHintMessage');
                if (hintMessageDiv) {
                    hintMessageDiv.style.display = 'none';
                }
                if (this.hintTimeout) clearTimeout(this.hintTimeout);

                // 1. Coleta de Itens (se o botão de ação estiver pressionado)
                if (this.coletando) {
                    // Percorre todos os itens para verificar coleta
                    for (let i = 0; i < this.itens.length; i++) {
                        if (this.itens[i].canBeCollected && this.checkCollision(this.player, this.itens[i])) {
                            const collectedItem = this.itens.splice(i, 1)[0];
                            this.totalAllItemsCollected++; // Incrementa a contagem total

                            if (collectedItem.isObjective) {
                                // Usa a nova estrutura de dados para contagem
                                this.objectiveCounts[collectedItem.type] = (this.objectiveCounts[collectedItem.type] || 0) + 1;
                                console.log(`DEBUG: Item objetivo coletado! Tipo: ${collectedItem.type}, Total: ${this.objectiveCounts[collectedItem.type]}`);
                            } else {
                                // Estes são itens coletáveis que não são objetivos da fase
                                console.log(`DEBUG: Item coletado: ${collectedItem.type}`);
                            }
                            this.atualizarHUD();
                            this.coletando = false;
                            return;
                        }
                    }

                    // 2. Interação com o Baú (apenas na Fase 1)
                    const phaseData = phasesData[this.currentPhase];
                    if (phaseData.chest && this.checkCollision(this.player, this.chest)) { 
                        let allObjectivesMet = true;
                        if (phaseData.items) {
                            for (const item of phaseData.items) {
                                if (item.isObjective && (this.objectiveCounts[item.type] || 0) < item.count) {
                                    allObjectivesMet = false;
                                    break;
                                }
                            }
                        }

                        if (allObjectivesMet) {
                            this.chest.isOpened = true;
                            this.chest.emoji = '🗃️'; 
                            console.log("DEBUG: Baú aberto com sucesso!");
                            this.coletando = false;
                            this.atualizarHUD(); 
                            return;
                        } else {
                            const hintMessageDiv = document.getElementById('llmHintMessage');
                            let msg = "Você precisa coletar todos os itens do objetivo antes de abrir o baú!";
                            
                            // Adiciona a contagem de itens faltantes na dica
                            const missingItems = phaseData.items.filter(item => item.isObjective && (this.objectiveCounts[item.type] || 0) < item.count);
                            if (missingItems.length > 0) {
                                msg += ` Faltam: `;
                                missingItems.forEach(item => {
                                    const itemName = itemDisplayNames[item.type] || item.type;
                                    msg += `${item.emoji} ${itemName} (${item.count - (this.objectiveCounts[item.type] || 0)}) `;
                                });
                            }

                            if (hintMessageDiv) {
                                hintMessageDiv.innerText = msg;
                                hintMessageDiv.style.display = 'block';
                            }
                            if (this.hintTimeout) clearTimeout(this.hintTimeout);
                            this.hintTimeout = setTimeout(() => {
                                if (hintMessageDiv) {
                                    hintMessageDiv.style.display = 'none';
                                }
                            }, 5000);
                            this.coletando = false;
                        }
                    }
                }
            },

            // Método para atualizar a exibição do HUD
            atualizarHUD: function() {
                const currentVidasDisplayElement = document.getElementById('vidasDisplay');
                const currentHudObjectiveLine1Element = document.getElementById('hudObjectiveLine1');
                const currentHudObjectiveLine2Element = document.getElementById('hudObjectiveLine2');
                const currentTotalAllItemsCollectedDisplayElement = document.getElementById('totalAllItemsCollectedDisplay');
                const currentTempoDisplayElement = document.getElementById('tempo');

                let coracao = "❤️".repeat(this.vidas);
                let objectiveLine1Content = '';
                let objectiveLine2Content = '';
                
                const phaseData = phasesData[this.currentPhase];
                if (!phaseData) return;

                const objectives = phaseData.items.filter(item => item.isObjective);

                // Build first line of objectives
                const firstLineObjectives = objectives.slice(0, 2);
                let line1Text = '';
                firstLineObjectives.forEach(obj => {
                    const itemName = itemDisplayNames[obj.type] || obj.type;
                    line1Text += `${obj.emoji} ${itemName}: ${this.objectiveCounts[obj.type] || 0} / ${obj.count}<br>`;
                });
                objectiveLine1Content = line1Text;

                // Build second line of objectives
                let line2Text = '';
                const secondLineObjectives = objectives.slice(2, 4);
                secondLineObjectives.forEach(obj => {
                    const itemName = itemDisplayNames[obj.type] || obj.type;
                    line2Text += `${obj.emoji} ${itemName}: ${this.objectiveCounts[obj.type] || 0} / ${obj.count}<br>`;
                });
                // Adiciona o baú se for a fase 1
                if (this.currentPhase === 1 && this.chest) {
                    line2Text += `📦 Baú: ${this.chest.isOpened ? '1/1 🔓' : '0/1 🔒'}`;
                }
                objectiveLine2Content = line2Text;


                if (currentVidasDisplayElement) currentVidasDisplayElement.innerText = `Vidas: ${coracao}`;
                if (currentTotalAllItemsCollectedDisplayElement) currentTotalAllItemsCollectedDisplayElement.innerText = `Total Coletado: ${this.totalAllItemsCollected}`;
                if (currentTempoDisplayElement) currentTempoDisplayElement.innerText = `Tempo: ${this.tempo}s`;

                if (currentHudObjectiveLine1Element) currentHudObjectiveLine1Element.innerHTML = objectiveLine1Content;
                if (currentHudObjectiveLine2Element) currentHudObjectiveLine2Element.innerHTML = objectiveLine2Content;
            },

            // Função para selecionar o personagem e iniciar o jogo
            selecionar: function(tipo) {
                const personagemSelecaoElement = document.getElementById('personagemSelecao');
                if (personagemSelecaoElement) {
                    personagemSelecaoElement.style.display = 'none'; // Esconde a tela de seleção
                }
                this.currentPlayerType = tipo; // Armazena o tipo de personagem
                console.log("Personagem selecionado:", tipo);
                this.iniciar(tipo, 1); // Inicia o jogo na Fase 1
            },

            // Inicializa o canvas 2D e os elementos do jogo
            iniciar: function(tipo, phase) {
                console.log(`Iniciando o jogo 2D com personagem: ${tipo}, Fase: ${phase}`);
                this.currentPhase = phase;
                const phaseData = phasesData[this.currentPhase];
                if (!phaseData) {
                    this.encerrar("O jogo terminou! Não há mais capítulos.");
                    return;
                }

                this.updatePageTitle(this.currentPhase);

                const gameModalElement = document.getElementById('gameModal');
                if (gameModalElement) gameModalElement.style.display = 'none';
                
                const llmHintMessageElement = document.getElementById('llmHintMessage');
                if (llmHintMessageElement) llmHintMessageElement.style.display = 'none';

                const continueModalElement = document.getElementById('continueModal');
                if (continueModalElement) continueModalElement.style.display = 'none';

                const temporaryMessageElement = document.getElementById('temporaryMessage');
                if (temporaryMessageElement) temporaryMessageElement.style.display = 'none';


                const hudElementDiv = document.getElementById('hud');
                if (hudElementDiv) {
                    hudElementDiv.style.display = 'flex'; 
                }

                if (this.continueCountdownInterval) {
                    clearInterval(this.continueCountdownInterval);
                    this.continueCountdownInterval = null;
                    this.continueTime = 10;
                } else if (this.vidas === 0) {
                    this.vidas = 3;
                }

                this.tempo = 90; // Tempo fixo para cada fase.
                this.coletando = false;
                this.objectiveCounts = {};
                this.totalAllItemsCollected = 0;
                // Inicializa a contagem de objetivos para a nova fase
                if (phaseData.items) {
                    phaseData.items.forEach(itemData => {
                        if (itemData.isObjective) {
                           this.objectiveCounts[itemData.type] = 0;
                        }
                    });
                }

                this.player = {
                    x: this.canvas.width / 2 - this.PLAYER_SIZE / 2,
                    y: this.canvas.height / 2 - this.PLAYER_SIZE / 2,
                    width: this.PLAYER_SIZE,
                    height: this.PLAYER_SIZE,
                    emoji: this.getCharacterEmoji(tipo)
                };

                // Limpa arrays antes de preencher
                this.itens = [];
                this.obstaculos = [];
                this.chest = null;


                // Geração de itens de objetivo e não-objetivo
                if (phaseData.items) {
                    phaseData.items.forEach(itemData => {
                        for (let i = 0; i < itemData.count; i++) {
                            let emoji = itemData.emoji;
                            // Lógica para sorvetes com sabores
                            if (itemData.type === 'sorvete' && itemData.flavors && itemData.flavors[i]) {
                                emoji = `🍦${itemData.flavors[i]}`;
                            }
                            this.itens.push(this.createGameObject(itemData.type, emoji, this.ITEM_SIZE, itemData.canBeCollected, false, null, itemData.isObjective));
                        }
                    });
                }

                // Cria e posiciona o baú se ele existir para a fase atual
                if (this.currentPhase === 1 && phaseData.chest) {
                    this.chest = this.createGameObject(phaseData.chest.type, phaseData.chest.emoji, this.CHEST_SIZE, phaseData.chest.canBeCollected, false, null, phaseData.chest.isObjective);
                    this.itens.push(this.chest); // Adiciona o baú na lista de itens para ser posicionado
                }
                
                // Gera obstáculos com base na nova contagem
                if (phaseData.obstacles) {
                    phaseData.obstacles.forEach(obstacleData => {
                        for (let i = 0; i < obstacleData.count; i++) {
                            const obstacle = this.createGameObject(obstacleData.type, obstacleData.emoji, this.OBSTACLE_SIZE, false, true);
                            this.obstaculos.push(obstacle);
                        }
                    });
                }
                
                // Gera sacos de dinheiro
                if (phaseData.moneyBags) {
                    for (let i = 0; i < phaseData.moneyBags; i++) {
                        this.itens.push(this.createGameObject('moeda', '💰', this.ITEM_SIZE, true, false, null, false));
                    }
                }

                this.placeGameObjectsRandomly();
                this.atualizarHUD();

                if (this.gameInterval) clearInterval(this.gameInterval);
                this.gameInterval = setInterval(() => {
                    let winConditionMet = false;
                    
                    if (this.currentPhase === 1) {
                        // Verifica se todas as pedras e chaves foram coletadas
                        const redStoneCollected = (this.objectiveCounts['pedra_vermelha'] || 0) >= (phasesData[1].items.find(item => item.type === 'pedra_vermelha')?.count || 0);
                        const blueStoneCollected = (this.objectiveCounts['pedra_azul'] || 0) >= (phasesData[1].items.find(item => item.type === 'pedra_azul')?.count || 0);
                        const greenStoneCollected = (this.objectiveCounts['pedra_verde'] || 0) >= (phasesData[1].items.find(item => item.type === 'pedra_verde')?.count || 0);
                        const keysCollected = (this.objectiveCounts['chave'] || 0) >= (phasesData[1].items.find(item => item.type === 'chave')?.count || 0);
                        
                        if (redStoneCollected && blueStoneCollected && greenStoneCollected && keysCollected) {
                            winConditionMet = (this.chest && this.chest.isOpened);
                        }
                    } else if (phaseData) {
                        winConditionMet = phaseData.items.filter(item => item.isObjective).every(item => {
                            return (this.objectiveCounts[item.type] || 0) >= item.count;
                        });
                    }

                    if (this.tempo > 0 && this.vidas > 0 && !winConditionMet) {
                        this.tempo--;
                        const currentTempoElement = document.getElementById('tempo');
                        if (currentTempoElement) {
                            currentTempoElement.innerText = `Tempo: ${this.tempo}s`;
                        }
                        if (this.tempo === 0) {
                            clearInterval(this.gameInterval);
                            this.showTemporaryMessage("Perdeu!", 3000);
                            
                            setTimeout(() => {
                                this.vidas--;
                                this.atualizarHUD();

                                if (this.vidas > 0) {
                                    this.iniciar(this.currentPlayerType, this.currentPhase);
                                } else {
                                    this.showContinueScreen();
                                }
                            }, 3000);
                        }
                    } else if (winConditionMet) {
                        clearInterval(this.gameInterval);
                        if (this.currentPhase < 12) {
                            this.showTemporaryMessage(`Capítulo ${this.currentPhase} Concluído!`, 2000);
                            setTimeout(() => {
                                this.currentPhase++; // Avança para o próximo capítulo
                                this.iniciar(this.currentPlayerType, this.currentPhase);
                            }, 2000);
                        } else {
                            this.encerrar("✅ Parabéns! Você completou todos os capítulos!");
                        }
                    } else if (this.vidas <= 0) {
                        clearInterval(this.gameInterval);
                        this.showContinueScreen();
                    }
                }, 1000);

                this.lastFrameTime = performance.now();
                this.animar();
                if (this.canvas) {
                    this.canvas.focus();
                }
            },

            encerrar: function(msg) {
                console.log("DEBUG: Encerrar chamado com mensagem:", msg);
                clearInterval(this.gameInterval);
                const llmHintMessageElement = document.getElementById('llmHintMessage');
                if (llmHintMessageElement) llmHintMessageElement.style.display = 'none';
                if (this.hintTimeout) clearTimeout(this.hintTimeout);

                const modal = document.getElementById('gameModal');
                if (modal) {
                    document.getElementById('modalMessage').innerText = msg;
                    modal.style.display = 'flex';
                }
                this.stopAllMusic();
            },

            showTemporaryMessage: function(msg, duration) {
                const tempMessageDiv = document.getElementById('temporaryMessage');
                if (tempMessageDiv) {
                    tempMessageDiv.innerText = msg;
                    tempMessageDiv.style.display = 'block';
                    setTimeout(() => {
                        tempMessageDiv.style.display = 'none';
                    }, duration);
                }
            },

            showContinueScreen: function() {
                const continueModalElement = document.getElementById('continueModal');
                if (continueModalElement) {
                    continueModalElement.style.display = 'flex';
                }
                this.continueTime = 10;
                const continueCountdownElement = document.getElementById('continueCountdown');
                if (continueCountdownElement) {
                    continueCountdownElement.innerText = this.continueTime;
                }


                if (this.continueCountdownInterval) clearInterval(this.continueCountdownInterval);
                this.continueCountdownInterval = setInterval(() => {
                    this.continueTime--;
                    if (continueCountdownElement) {
                        continueCountdownElement.innerText = this.continueTime;
                    }
                    if (this.continueTime <= 0) {
                        clearInterval(this.continueCountdownInterval);
                        this.handleContinue('nao');
                    }
                }, 1000);
                this.stopAllMusic();
            },

            handleContinue: function(choice) {
                clearInterval(this.continueCountdownInterval);
                const continueModalElement = document.getElementById('continueModal');
                if (continueModalElement) {
                    continueModalElement.style.display = 'none';
                }

                if (choice === 'sim') {
                    console.log("DEBUG: Jogador escolheu SIM. Reiniciando para seleção de personagem.");
                    this.vidas = 3;
                    const personagemSelecaoElement = document.getElementById('personagemSelecao');
                    if (personagemSelecaoElement) {
                        personagemSelecaoElement.style.display = 'flex';
                    }
                    if (this.ctx && this.canvas) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.totalAllItemsCollected = 0;
                    this.tempo = 90;
                    this.coletando = false;
                    this.itens = [];
                    this.obstaculos = [];
                    this.chest = null;
                    this.currentPhase = 1;
                    this.objectiveCounts = {};
                    const introScreenElement = document.getElementById('introScreen');
                    if (introScreenElement) {
                        introScreenElement.style.display = 'flex';
                    }
                    const hudElement = document.getElementById('hud');
                    if (hudElement) {
                        hudElement.style.display = 'none';
                    }
                } else {
                    console.log("DEBUG: Jogador escolheu NÃO ou tempo esgotou. Recarrega a página.");
                    location.reload();
                }
            },

            animar: function(currentTime) {
                requestAnimationFrame(this.animar.bind(this));

                if (!this.lastFrameTime) {
                    this.lastFrameTime = currentTime;
                }

                const elapsed = currentTime - this.lastFrameTime;
                this.frameInterval = 1000 / this.targetFPS;

                if (elapsed > this.frameInterval) {
                    this.lastFrameTime = currentTime - (elapsed % this.frameInterval);

                    let winConditionMet = false;
                    const phaseData = phasesData[this.currentPhase];
                    if (phaseData && phaseData.chest) {
                        winConditionMet = (this.chest && this.chest.isOpened);
                    } else if (phaseData) {
                        winConditionMet = phaseData.items.filter(item => item.isObjective).every(item => {
                            return (this.objectiveCounts[item.type] || 0) >= item.count;
                        });
                    }

                    if (this.vidas <= 0 || this.tempo <= 0 || winConditionMet) {
                        return;
                    }

                    if (this.ctx && this.canvas) {
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    } else {
                        console.error("Erro: Canvas ou contexto 2D não está disponível para limpeza.");
                        return;
                    }


                    const prevX = this.player.x;
                    const prevY = this.player.y;

                    if (this.teclas["w"]) this.player.y -= this.PLAYER_SPEED;
                    if (this.teclas["s"]) this.player.y += this.PLAYER_SPEED;
                    if (this.teclas["a"]) this.player.x -= this.PLAYER_SPEED;
                    if (this.teclas["d"]) this.player.x += this.PLAYER_SPEED;

                    this.player.x = Math.max(0, Math.min(this.canvas.width - this.player.width, this.player.x));
                    this.player.y = Math.max(0, Math.min(this.canvas.height - this.player.height, this.player.y));

                    this.obstaculos.forEach(obstacle => {
                        const exclusionZone = 1.0;
                        const expandedObstacleRect = {
                            x: obstacle.x - (obstacle.size * (exclusionZone - 1) / 2),
                            y: obstacle.y - (obstacle.size * (exclusionZone - 1) / 2),
                            width: obstacle.width * exclusionZone,
                            height: obstacle.height * exclusionZone
                        };
                        if (obstacle.isObstacle && this.checkCollision(this.player, expandedObstacleRect)) {
                            this.player.x = prevX;
                            this.player.y = prevY;
                        }
                    });

                    this.handleInteractions();

                    if (this.chest && this.currentPhase === 1) {
                        this.drawItem(this.chest);
                    }
                    this.itens.forEach(this.drawItem.bind(this));
                    this.obstaculos.forEach(this.drawItem.bind(this));
                    this.drawPlayer();
                }
            },

            updatePageTitle: function(phase) {
                const phaseData = phasesData[phase];
                if (phaseData) {
                    document.title = `Ursinho Amigão 2D - ${phaseData.title}`;
                    const currentChapterTitleDisplayElement = document.getElementById('chapterTitleDisplay');
                    if (currentChapterTitleDisplayElement) {
                        currentChapterTitleDisplayElement.innerText = phaseData.title;
                    }
                }
            },

            initGame: function() {
                this.vidasDisplayElement = document.getElementById('vidasDisplay');
                this.hudObjectiveLine1Element = document.getElementById('hudObjectiveLine1');
                this.hudObjectiveLine2Element = document.getElementById('hudObjectiveLine2');
                this.totalAllItemsCollectedDisplayElement = document.getElementById('totalAllItemsCollectedDisplay');
                this.tempoDisplayElement = document.getElementById('tempo');
                this.chapterTitleDisplayElement = document.getElementById('chapterTitleDisplay');

                this.canvas = document.getElementById('gameCanvas');
                if (this.canvas) {
                    this.ctx = this.canvas.getContext('2d');
                    this.resizeCanvas();
                    window.addEventListener('resize', this.resizeCanvas.bind(this));
                } else {
                    console.error("Erro: Elemento 'gameCanvas' não encontrado no DOM.");
                    return;
                }
                
                this.introMusicElement = document.getElementById('introMusic');
                if (this.introMusicElement) {
                    this.introMusicElement.volume = 0.6;
                }

                const introScreen = document.getElementById('introScreen');
                const personagemSelecao = document.getElementById('personagemSelecao');
                
                const dismissIntro = () => {
                    const currentIntroScreen = document.getElementById('introScreen');
                    const currentPersonagemSelecao = document.getElementById('personagemSelecao');

                    if (currentIntroScreen && currentIntroScreen.style.display !== 'none') {
                        currentIntroScreen.style.display = 'none';
                        if (currentPersonagemSelecao) {
                            currentPersonagemSelecao.style.display = 'flex';
                        }
                        if (this.introMusicElement && this.introMusicElement.paused) {
                            this.introMusicElement.play().catch(e => console.log("Erro ao tocar música de introdução após interação:", e));
                            this.currentMusic = this.introMusicElement;
                        }
                        document.removeEventListener('keydown', dismissIntro);
                        currentIntroScreen.removeEventListener('click', dismissIntro);
                        currentIntroScreen.removeEventListener('touchstart', dismissIntro);
                    }
                };

                if (introScreen) {
                    introScreen.addEventListener('click', dismissIntro);
                    introScreen.addEventListener('touchstart', dismissIntro);
                } else {
                    console.error("ERRO: Elemento 'introScreen' não encontrado no DOM (no window.onload).");
                }
                document.addEventListener('keydown', dismissIntro);

                const personagemUrsoBtn = document.getElementById('personagemUrso');
                if (personagemUrsoBtn) personagemUrsoBtn.addEventListener('click', () => this.selecionar('urso'));
                
                const personagemGatoBtn = document.getElementById('personagemGato');
                if (personagemGatoBtn) personagemGatoBtn.addEventListener('click', () => this.selecionar('gato'));
                
                const personagemGirafaBtn = document.getElementById('personagemGirafa');
                if (personagemGirafaBtn) personagemGirafaBtn.addEventListener('click', () => this.selecionar('girafa'));
                
                const personagemCoelhoBtn = document.getElementById('personagemCoelho');
                if (personagemCoelhoBtn) personagemCoelhoBtn.addEventListener('click', () => this.selecionar('coelho'));

                const btnUp = document.getElementById('btnUp');
                if (btnUp) {
                    btnUp.addEventListener('touchstart', (e) => { e.preventDefault(); this.tecla('w', true); });
                    btnUp.addEventListener('touchend', (e) => { e.preventDefault(); this.tecla('w', false); });
                }
                const btnLeft = document.getElementById('btnLeft');
                if (btnLeft) {
                    btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); this.tecla('a', true); });
                    btnLeft.addEventListener('touchend', (e) => { e.preventDefault(); this.tecla('a', false); });
                }
                const btnDown = document.getElementById('btnDown');
                if (btnDown) {
                    btnDown.addEventListener('touchstart', (e) => { e.preventDefault(); this.tecla('s', true); });
                    btnDown.addEventListener('touchend', (e) => { e.preventDefault(); this.tecla('s', false); });
                }
                const btnRight = document.getElementById('btnRight');
                if (btnRight) {
                    btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); this.tecla('d', true); });
                    btnRight.addEventListener('touchend', (e) => { e.preventDefault(); this.tecla('d', false); });
                }

                document.addEventListener('keydown', (e) => {
                    const key = e.key.toLowerCase();
                    if (['w', 'a', 's', 'd', ' '].includes(key)) {
                        e.preventDefault();
                        if (key === ' ') {
                            this.coletando = true;
                        } else {
                            this.tecla(key, true);
                        }
                    }
                });
                document.addEventListener('keyup', (e) => {
                    const key = e.key.toLowerCase();
                    if (['w', 'a', 's', 'd', ' '].includes(key)) {
                        e.preventDefault();
                        if (key === ' ') {
                            this.coletando = false;
                        } else {
                            this.tecla(key, false);
                        }
                    }
                });

                const botaoAcao = document.getElementById('botao-acao');
                if (botaoAcao) {
                    botaoAcao.addEventListener('touchstart', (e) => { e.preventDefault(); this.coletando = true; });
                    botaoAcao.addEventListener('touchend', (e) => { e.preventDefault(); this.coletando = false; });
                }

                const soundControlBtn = document.getElementById('soundControlBtn');
                const soundOnIcon = document.getElementById('soundOnIcon');
                const soundOffIcon = document.getElementById('soundOffIcon');

                if (soundControlBtn && soundOnIcon && soundOffIcon) {
                    soundControlBtn.addEventListener('click', () => {
                        const musicToControl = this.currentMusic; 
                        if (musicToControl) {
                            musicToControl.muted = !musicToControl.muted;
                            if (musicToControl.muted) {
                                soundOnIcon.style.display = 'none';
                                soundOffIcon.style.display = 'block';
                            } else {
                                soundOnIcon.style.display = 'block';
                                soundOffIcon.style.display = 'none';
                                if (musicToControl.paused) {
                                    musicToControl.play().catch(e => console.log("Erro ao tentar tocar música após desmutar:", e));
                                }
                            }
                        }
                    });
                }

                const btnSim = document.getElementById('btnSim');
                if (btnSim) btnSim.addEventListener('click', () => this.handleContinue('sim'));
                
                const btnNao = document.getElementById('btnNao');
                if (btnNao) btnNao.addEventListener('click', () => this.handleContinue('nao'));
                
                if (this.canvas) {
                    this.canvas.focus();
                }

                this.atualizarHUD();
            }
        };

        document.addEventListener('DOMContentLoaded', () => game.initGame());
    </script>
</body>
</html>
