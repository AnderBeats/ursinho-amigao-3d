<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ursinho Amig√£o 2D - Aventura de Aprendizados</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #aee1f9; /* Fundo azul claro */
            font-family: 'Inter', sans-serif; /* Usando a fonte Inter */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; /* Garante que o corpo ocupa a altura total da viewport */
            position: relative; /* Para posicionamento absoluto dos elementos */
        }
        #introScreen {
            position: absolute;
            inset: 0;
            background: #aee1f9; /* Fundo azul claro para a tela de introdu√ß√£o */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20; /* Acima de tudo, exceto modais */
            color: #333;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            cursor: pointer; /* Adicionado para indicar que a tela √© clic√°vel */
        }
        #introImagePlaceholder { /* New style for the image placeholder */
            width: 400px;
            height: 300px;
            background-color: #ffd54f; /* Yellowish background */
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8em; /* Increased font size for the emoji */
            color: #333;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        #introScreen h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            display: flex; /* Use flexbox for centering children */
            flex-direction: column; /* Stack children vertically */
            align-items: center; /* Center horizontally */
            text-align: center; /* Ensure text within spans is centered */
        }
        #introScreen h1 span {
            display: block; /* Ensure spans take full width for line break */
        }
        #introScreen p {
            font-size: 1.5em;
            font-weight: bold;
            color: #34495e;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        #personagemSelecao {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex; /* Changed from none to flex to ensure it's visible initially */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .personagem-opcoes {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            justify-content: center;
        }
        .personagem {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #333;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Sombra suave */
            transition: transform 0.2s, background-color 0.2s; /* Transi√ß√£o suave */
            text-align: center; /* Adicionado para centralizar o texto dentro da caixinha */
            font-size: 3em; /* Ajustado o tamanho do emoji para caber na caixa */
        }
        .personagem:hover {
            background-color: #ffd54f; /* Amarelo ao passar o mouse */
            transform: translateY(-5px); /* Efeito de eleva√ß√£o ao passar o mouse */
        }
        .personagem span { /* Estilo para o nome do personagem */
            font-size: 0.3em; /* Reduz o tamanho da fonte para o nome */
            display: block; /* Garante que o nome fique em uma nova linha */
            margin-top: 0.2em; /* Ajusta a margem para aproximar o nome do emoji e subir o emoji */
        }
        #hud {
            position: absolute;
            top: 80px; /* Adjusted top for desktop */
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            font-size: 1.1em;
            display: none; /* Oculta o HUD por padr√£o */
            flex-direction: row; /* Use flexbox for columns */
            justify-content: space-between; /* Distribute space between columns */
            width: 90%; /* Occupy most of the width */
            max-width: 700px; /* Limit max width */
            box-sizing: border-box; /* Include padding in width */
            align-items: flex-start; /* Align columns to the top */
        }
        .hud-column {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align text to the left within each column */
            flex-basis: 48%; /* Give columns a basis to distribute space */
            padding: 0 5px; /* Reduced internal padding for better fit */
            box-sizing: border-box; /* Include padding in width */
            background: rgba(255,255,255,0.2); /* Light background for the "box" effect - Adjusted to 0.2 */
            border-radius: 5px;
        }
        .hud-column:last-child {
            align-items: flex-end; /* Align right column text to the right */
        }
        #objetivoFase {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            font-size: 1.1em;
            text-align: right;
            display: none; /* Adicionado para ocultar o painel de objetivo da fase */
        }
        /* Controles posicionados sobre o canvas */
        #direcional {
            position: fixed; /* Fixado na viewport */
            bottom: 20px;
            left: 20px; /* Canto inferior esquerdo */
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .linha {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .botao-direcional, .botao-jogo { /* Classe geral para bot√µes de jogo */
            width: 50px; /* Bot√µes ligeiramente maiores */
            height: 50px;
            background: rgba(255,255,255,0.3); /* Transpar√™ncia */
            border: none;
            border-radius: 12px; /* Cantos mais arredondados */
            font-weight: bold;
            font-size: 24px; /* Fonte maior para √≠cones */
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            transition: background 0.2s, transform 0.1s;
            z-index: 10; /* Ensure buttons are above canvas */
        }
        .botao-direcional:active, .botao-jogo:active {
            background: rgba(255,255,255,0.5); /* Menos transparente ao clicar */
            transform: translateY(2px); /* Efeito de clique */
        }
        #botao-acao {
            position: fixed; /* Fixado na viewport */
            bottom: 30px;
            right: 20px; /* Canto inferior direito */
            z-index: 10;
            background: rgba(76, 175, 80, 0.3); /* Verde com transpar√™ncia */
            color: white;
            border-radius: 50%; /* Torna o bot√£o redondo */
            display: flex; /* Para centralizar o conte√∫do */
            align-items: center; /* Para centralizar o conte√∫do */
            justify-content: center; /* Para centralizar o conte√∫do */
            font-size: 30px; /* Ajusta o tamanho da fonte para o 'A' */
        }

        /* Estilo do Canvas 2D */
        canvas {
            background-color: #8bc34a; /* Cor do ch√£o para 2D */
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            display: block; /* Remove espa√ßo extra abaixo do canvas */
            width: 90%; /* Ocupa 90% da largura da janela */
            height: 80vh; /* Ocupa 80% da altura da viewport */
            margin: 20px auto; /* Centraliza o canvas */
        }

        /* Mensagem de dica LLM */
        #llmHintMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            z-index: 15;
            display: none; /* Oculto por padr√£o */
            max-width: 70%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Novo Modal de Continue */
        #continueModal {
            display: none; /* Oculto por padr√£o */
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            flex-direction: column; /* Changed to flex for centering */
            align-items: center;
            justify-content: center;
            z-index: 30; /* Acima de outros modais */
            text-align: center;
        }
        #continueModal h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        #continueModal p {
            font-size: 1.8em;
            margin-bottom: 30px;
        }
        #continueModal .botoes-continue {
            display: flex;
            gap: 20px;
        }
        #continueModal .botoes-continue button {
            padding: 15px 30px;
            font-size: 1.5em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        #continueModal .botoes-continue button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        #continueModal #btnSim {
            background-color: #4CAF50;
            color: white;
        }
        #continueModal #btnNao {
            background-color: #f44336;
            color: white;
        }
        #temporaryMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.5em;
            z-index: 25;
            display: none;
        }

        /* Estilo para o t√≠tulo do cap√≠tulo */
        #chapterTitleDisplay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            z-index: 10;
            text-align: center;
            white-space: nowrap; /* Evita quebra de linha */
        }

        /* Bot√£o de controle de som */
        #soundControlBtn {
            position: fixed;
            bottom: 20px; /* Ajuste conforme necess√°rio para n√£o colidir com outros bot√µes */
            left: 50%;
            transform: translateX(-50%);
            width: 60px; /* Tamanho do bot√£o */
            height: 60px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%; /* Redondo */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px; /* Tamanho do √≠cone */
            color: white;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s, transform 0.1s;
        }
        #soundControlBtn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: translateX(-50%) translateY(2px);
        }
        #soundControlBtn svg {
            width: 30px; /* Tamanho do SVG */
            height: 30px;
        }


        /* Media Queries for Mobile Adjustments */
        @media (max-width: 768px) {
            #introImagePlaceholder {
                width: 80vw;
                height: 40vh;
                font-size: 6em;
            }
            #introScreen h1 {
                font-size: 1.8em;
            }
            #introScreen p {
                font-size: 1.2em;
            }
            #hud {
                font-size: 0.9em;
                padding: 8px;
                top: 70px; /* Adjusted top for mobile */
                flex-direction: row; /* Keep columns side-by-side if enough space */
            }
            .hud-column {
                align-items: flex-start; /* Default for both columns */
            }
            .hud-column:last-child {
                align-items: flex-end; /* Keep right column aligned right */
            }
            .botao-direcional, .botao-jogo {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            #botao-acao {
                width: 60px;
                height: 60px;
                font-size: 26px;
            }
            #direcional {
                bottom: 10px;
                left: 10px;
            }
            #botao-acao {
                bottom: 20px;
                right: 10px;
            }
            .modal-content { /* This rule is now unused as gameModal is removed */
                padding: 20px;
                font-size: 1.2em;
            }
            .modal-content button { /* This rule is now unused as gameModal is removed */
                padding: 10px 20px;
                font-size: 1em;
            }
            #continueModal h2 {
                font-size: 2em;
            }
            #continueModal p {
                font-size: 1.5em;
            }
            #continueModal .botoes-continue button {
                padding: 12px 25px;
                font-size: 1.2em;
            }
        }

        @media (max-width: 360px) { /* Adjusted breakpoint for stacking columns on very small screens */
            #hud {
                top: 40px; /* Further adjust top for very small screens */
                font-size: 0.75em; /* Smaller font for very small screens */
                flex-direction: column; /* Stack columns vertically on very small screens */
                align-items: center; /* Center stacked columns */
            }
            .hud-column:last-child {
                align-items: center; /* Center text when stacked */
            }
            #introScreen h1 {
                font-size: 1.3em;
            }
            #introScreen p {
                font-size: 0.9em;
            }
            .botao-direcional, .botao-jogo {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            #botao-acao {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
            #direcional {
                bottom: 2px;
                left: 2px;
            }
            #botao-acao {
                bottom: 10px;
                right: 2px;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Introdu√ß√£o -->
    <div id="introScreen">
        <div id="introImagePlaceholder">
            üêª
        </div>
        <h1>
            <span>Ursinho Amig√£o e Seus Amigos em:</span><br>
            <span>Meu Dia na Escola - Parte I</span>
        </h1>
        <p>Pressione qualquer bot√£o para come√ßar</p>
    </div>

    <!-- Tela de Sele√ß√£o de Personagem -->
    <div id="personagemSelecao">
        <h2>Escolha seu personagem</h2>
        <div class="personagem-opcoes">
            <div class="personagem" id="personagemUrso" style="background:#f4c542;">üêª<br><span>URSINHO<br>AMIG√ÉO</span></div>
            <div class="personagem" id="personagemGato" style="background:#8bc34a;">üê±<br><span>GATINHO<br>TITO</span></div>
            <div class="personagem" id="personagemGirafa" style="background:#ffb74d;">ü¶í<br><span>GIRAFINHA<br>GINA</span></div>
            <div class="personagem" id="personagemCoelho" style="background:#e91e63;">üê∞<br><span>COELHINHA<br>LILI</span></div>
        </div>
    </div>

    <!-- Heads-Up Display (HUD) -->
    <div id="hud">
        <div class="hud-column">
            <span id="vidasDisplay"></span>
            <span id="totalAllItemsCollectedDisplay"></span>
            <span id="tempo"></span>
        </div>
        <div class="hud-column">
            <span id="hudObjectiveLine1"></span>
            <span id="hudObjectiveLine2"></span>
        </div>
    </div>

    <!-- T√≠tulo do Cap√≠tulo Centralizado -->
    <div id="chapterTitleDisplay"></div>

    <!-- Painel de Objetivo da Fase (canto superior direito) -->
    <div id="objetivoFase" style="display: none;"></div>

    <!-- Canvas para o jogo 2D -->
    <canvas id="gameCanvas" tabindex="0"></canvas>

    <!-- Controles Direcionais para Celular -->
    <div id="direcional">
        <div class="linha">
            <button class="botao-direcional" id="btnUp">‚ñ≤</button>
        </div>
        <div class="linha">
            <button class="botao-direcional" id="btnLeft">‚óÑ</button>
            <button class="botao-direcional" id="btnDown">‚ñº</button>
            <button class="botao-direcional" id="btnRight">‚ñ∫</button>
        </div>
    </div>

    <!-- Bot√£o de A√ß√£o para Celular -->
    <button id="botao-acao" class="botao-jogo">A</button>

    <!-- Bot√£o de controle de som -->
    <button id="soundControlBtn" class="botao-jogo">
        <svg id="soundOnIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        <svg id="soundOffIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-x" style="display: none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
    </button>

    <!-- Mensagem de Dica LLM -->
    <div id="llmHintMessage" style="display: none;">
        Aguarde a dica...
    </div>

    <!-- Mensagem Tempor√°ria (ex: "Vida perdida!") -->
    <div id="temporaryMessage" style="display: none;"></div>

    <!-- Modal de Continue -->
    <div id="continueModal" style="display: none;">
        <h2>Fim de Jogo!</h2>
        <p>Continuar? <span id="continueCountdown">10</span></p>
        <div class="botoes-continue">
            <button id="btnSim">Sim</button>
            <button id="btnNao">N√£o</button>
        </div>
    </div>

    <!-- Tags de √°udio para as trilhas sonoras -->
    <audio id="introMusic" src="https://raw.githack.com/AnderBeats/ursinho-amigao-3d/main/Ursinho%20Trilha/Abertura_Fim.mp3" preload="auto" loop></audio>
    <!-- Removida a tag de m√∫sica de fase, pois apenas a m√∫sica de introdu√ß√£o ser√° utilizada por enquanto. -->

    <!-- Script principal do jogo -->
    <script>
        // Vari√°veis globais para o canvas 2D e estado do jogo
        let canvas; 
        let ctx;    
        let player;
        let teclas = {}; // Armazena o estado das teclas pressionadas
        let itens = []; // Array para todos os itens do tesouro (colet√°veis)
        let obstaculos = []; // Array para os obst√°culos que bloqueiam o caminho
        let schoolItems = []; // Novos itens escolares que n√£o s√£o colet√°veis nem obst√°culos
        let chest = null; // O ba√∫ do tesouro
        let pedrasColetadas = 0; // Contagem de pedras coletadas
        const TOTAL_PEDRAS = 3; // Total de pedras necess√°rias
        let keysColetadas = 0; // Novo: Contagem de chaves coletadas
        const TOTAL_CHAVES = 3; // Novo: Total de chaves necess√°rias para a Fase 1

        let valesSorveteColetados = 0; // Novo: Contagem de vales sorvete coletados
        const TOTAL_VALES_SORVETE = 4; // Novo: Total de vales sorvete necess√°rios para a Fase 2
        let sorvetesObjetivoColetados = 0; // Novo: Contagem de sorvetes objetivo coletados
        const TOTAL_SORVETES_OBJETIVO = 4; // Novo: Total de sorvetes objetivo necess√°rios para a Fase 2
        let trofeusColetados = 0; // Novo: Contagem de trof√©us coletados para a Fase 3
        const TOTAL_TROFEUS = 3; // Novo: Total de trof√©us necess√°rios para a Fase 3
        let bolasColetadas = 0; // Novo: Contagem de bolas coletadas para a Fase 3
        const TOTAL_BOLAS_FASE3 = 3; // Novo: Total de bolas necess√°rias para a Fase 3
        let pipasColetadas = 0; // Novo: Contagem de pipas coletadas para a Fase 3
        const TOTAL_PIPAS = 3; // Novo: Total de pipas necess√°rias para a Fase 3

        let tubosEnsaioColetados = 0; // Novo: Contagem de tubos de ensaio coletados para a Fase 4
        const TOTAL_TUBOS_ENSAIO = 3; // Novo: Total de tubos de ensaio necess√°rios para a Fase 4
        let imasColetados = 0; // Novo: Contagem de √≠m√£s coletados para a Fase 4
        const TOTAL_IMAS = 3; // Novo: Total de √≠m√£s necess√°rios para a Fase 4
        let microscopioColetados = 0; // Novo: Contagem de microsc√≥pios coletados para a Fase 4
        const TOTAL_MICROSCOPIO = 3; // Novo: Total de microsc√≥pios necess√°rios para a Fase 4
        let elefantesColetados = 0; // Novo: Contagem de elefantes coletados para a Fase 5
        const TOTAL_ELEFANTES = 3; // Novo: Total de elefantes necess√°rios para a Fase 5
        let leoesColetados = 0; // Novo: Contagem de le√µes coletados para a Fase 5
        const TOTAL_LEOES = 3; // Novo: Total de le√µes necess√°rios para a Fase 5
        let avesColetadas = 0; // Novo: Contagem de aves coletadas para a Fase 5
        const TOTAL_AVES = 3; // Novo: Total de aves necess√°rias para a Fase 5
        let pinturasColetadas = 0; // Novo: Contagem de pinturas coletadas para a Fase 6
        const TOTAL_PINTURAS = 3; // Novo: Total de pinturas necess√°rias para a Fase 6
        let esculturasColetadas = 0; // Novo: Contagem de esculturas coletadas para a Fase 6
        const TOTAL_ESCULTURAS = 3; // Novo: Total de esculturas necess√°rias para a Fase 6
        let fosseisColetados = 0; // Novo: Contagem de f√≥sseis coletados para a Fase 6
        const TOTAL_FOSSEIS = 3; // Novo: Total de f√≥sseis necess√°rios para a Fase 6
        let cestasPiqueniqueColetadas = 0; // Novo: Contagem de cestas de piquenique coletadas para a Fase 7
        const TOTAL_CESTAS_PIQUENIQUE = 3; // Novo: Total de cestas de piquenique necess√°rias para a Fase 7
        let bolasFase7Coletadas = 0; // Novo: Contagem de bolas coletadas para a Fase 7
        const TOTAL_BOLAS_FASE7 = 3; // Novo: Total de bolas necess√°rias para a Fase 7
        let brinquedosParqueColetados = 0; // Novo: Contagem de brinquedos de parque coletados para a Fase 7
        const TOTAL_BRINQUEDOS_PARQUE = 3; // Novo: Total de brinquedos de parque necess√°rios para a Fase 7

        // Novos contadores para os cap√≠tulos 8 a 12
        let livroAventuraColetados = 0;
        const TOTAL_LIVRO_AVENTURA = 3;
        let livroAnimaisColetados = 0;
        const TOTAL_LIVRO_ANIMAIS = 3;
        let livroFabulaColetados = 0;
        const TOTAL_LIVRO_FABULA = 3;

        let lixeiraReciclagemColetados = 0;
        const TOTAL_LIXEIRA_RECICLAGEM = 3;
        let garrafaPlasticoColetados = 0;
        const TOTAL_GARRAFA_PLASTICO = 3;
        let arvoreMudaColetados = 0;
        const TOTAL_ARVORE_MUDA = 3;

        let plantaNativaColetados = 0;
        const TOTAL_PLANTAS_NATIVAS = 3;
        let animalSelvagemColetados = 0;
        const TOTAL_ANIMAIS_SELVAGENS = 3;
        let telescopioColetados = 0; // Renamed from binoculosColetados
        const TOTAL_TELESCOPIO = 3; // Renamed from TOTAL_BINOCULOS

        let pincelColetados = 0;
        const TOTAL_PINCEL = 3;
        let tintaColetados = 0;
        const TOTAL_TINTA = 3;
        let argilaColetados = 0;
        const TOTAL_ARGILA = 3;

        let violaoColetados = 0;
        const TOTAL_VIOLAO = 3;
        let pianoColetados = 0;
        const TOTAL_PIANO = 3;
        let microfoneColetados = 0;
        const TOTAL_MICROFONE = 3;

        // Vari√°veis para o sistema de n√≠veis
        let currentLevel = 1; // Come√ßa no N√≠vel 1
        const BASE_TIME = 90; // Tempo base em segundos para o N√≠vel 1
        const TIME_DECREMENT_PER_LEVEL = 10; // Decremento de tempo por n√≠vel

        let totalAllItemsCollected = 0; // Nova vari√°vel para contar TODOS os itens coletados
        let vidas = 3; // Vidas do jogador
        let tempo = BASE_TIME; // Tempo do jogo em segundos
        let coletando = false; // Flag para a√ß√£o de coleta (coletar item ou usar chave no ba√∫)
        let gameInterval; // Para o temporador do jogo
        let hintTimeout; // Para esconder a dica LLM
        let hasKey = false; // Flag para verificar se a chave foi coletada
        let continueCountdownInterval; // Intervalo para a contagem regressiva do continue
        let continueTime = 10; // Tempo inicial da contagem regressiva do continue
        let currentPlayerType = ''; // Armazena o tipo de personagem selecionado para rein√≠cios
        let currentPhase = 1; // Inicia na Fase 1

        const PLAYER_SIZE = 40; // Tamanho do personagem
        const ITEM_SIZE = 30; // Tamanho dos itens colet√°veis
        const OBSTACLE_SIZE = 30; // Tamanho dos obst√°culos (AUMENTADO PARA 30 PIXELS)
        const SCHOOL_ITEM_SIZE = 25; // Tamanho dos itens escolares n√£o colet√°veis
        const CHEST_SIZE = 50; // Tamanho do ba√∫
        const PLAYER_SPEED = 3; // Velocidade do personagem (ajustada para m√©dio)

        // Vari√°veis para o limitador de FPS
        var targetFPS = 30; // FPS alvo
        var frameInterval = 1000 / targetFPS; // Intervalo de tempo entre frames em ms
        var lastFrameTime = 0; // Initialized globally

        // Global references to HUD elements
        let vidasDisplayElement;
        let hudObjectiveLine1Element;
        let hudObjectiveLine2Element;
        let totalAllItemsCollectedDisplayElement;
        let tempoDisplayElement;
        let chapterTitleDisplayElement;
        let objetivoFaseElement;
        
        // Vari√°veis de √°udio
        let introMusicElement;
        let currentMusic = null; // Para controlar a m√∫sica que est√° tocando atualmente

        // Fun√ß√£o para tocar uma m√∫sica, pausando a anterior se houver
        function playMusic(musicElement) {
            // Se a m√∫sica atual n√£o √© a que queremos tocar ou se n√£o h√° m√∫sica tocando, ajusta.
            if (currentMusic !== musicElement) {
                if (currentMusic) {
                    currentMusic.pause();
                    currentMusic.currentTime = 0; // Reinicia a m√∫sica para o come√ßo
                }
                currentMusic = musicElement;
                if (currentMusic) {
                    currentMusic.play().catch(e => console.log("Erro ao tocar m√∫sica (pode precisar de intera√ß√£o do usu√°rio):", e));
                }
            } else if (currentMusic && currentMusic.paused) {
                // Se a mesma m√∫sica j√° est√° selecionada mas est√° pausada, tenta tocar.
                currentMusic.play().catch(e => console.log("Erro ao retomar m√∫sica (pode precisar de intera√ß√£o do usu√°rio):", e));
            }
        }

        // Fun√ß√£o para parar toda a m√∫sica
        function stopAllMusic() {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
                currentMusic = null;
            }
        }

        // Fun√ß√£o para atualizar o estado da tecla (para teclado e toque)
        function tecla(k, v) {
            teclas[k] = v;
        }

        // Fun√ß√£o para redimensionar o canvas
        function resizeCanvas() {
            // canvas e ctx j√° s√£o globais e inicializados no topo do script
            canvas.width = window.innerWidth * 0.9; // 90% da largura da janela
            canvas.height = window.innerHeight * 0.8; // 80% da altura da viewport
            // Reposiciona o jogador no centro se o canvas for redimensionado
            if (player) {
                player.x = canvas.width / 2 - PLAYER_SIZE / 2;
                player.y = canvas.height / 2 - PLAYER_SIZE / 2;
            }
            // N√£o reposiciona itens e obst√°culos existentes para manter o desafio
        }

        // Retorna o emoji do personagem selecionado
        function getCharacterEmoji(tipo) {
            switch (tipo) {
                case 'urso': return 'üêª';
                case 'gato': return 'üê±';
                case 'girafa': return 'ü¶í';
                case 'coelho': return 'üê∞';
                default: return '‚ùì';
            }
        }

        // Cria um objeto de jogo (item, obst√°culo, ba√∫, item escolar)
        function createGameObject(type, emoji, size, canBeCollected, isObstacle, color = null, isObjective = false) {
            return {
                type: type,
                emoji: emoji,
                canBeCollected: canBeCollected, // Se pode ser coletado pelo bot√£o de a√ß√£o
                isObstacle: isObstacle,        // Se bloqueia o caminho
                color: color,
                isObjective: isObjective,      // Se conta para o objetivo principal
                x: 0, 
                y: 0, 
                size: size,
                width: size, 
                height: size 
            };
        }

        // Posiciona todos os objetos no canvas de forma aleat√≥ria, evitando sobreposi√ß√£o inicial
        function placeGameObjectsRandomly() {
            const padding = 20; // Espa√ßamento das bordas do canvas
            const minX = padding;
            const minY = padding;
            const maxX = canvas.width - padding;
            const maxY = canvas.height - padding;

            const placedObjects = []; // Para controlar a sobreposi√ß√£o

            // Define uma √°rea segura no centro para o jogador (din√¢mica)
            const playerSafeZoneSize = PLAYER_SIZE + (4 * OBSTACLE_SIZE); // 2x OBSTACLE_SIZE em cada lado do player
            const playerSafeZone = {
                x: canvas.width / 2 - playerSafeZoneSize / 2,
                y: canvas.height / 2 - playerSafeZoneSize / 2,
                width: playerSafeZoneSize,
                height: playerSafeZoneSize
            };

            function getRandomPosition(objSize, isObstacle = false) {
                let newX, newY, collision;
                let attempts = 0;
                const maxAttempts = 1000; // Aumentado para mais chances de posicionamento
                // Define a dist√¢ncia m√≠nima de afastamento para objetos (3 vezes o tamanho de um obst√°culo)
                const minClearanceBetweenObjects = 3 * OBSTACLE_SIZE; 

                do {
                    collision = false;
                    newX = Math.random() * (maxX - minX - objSize) + minX;
                    newY = Math.random() * (maxY - minY - objSize) + minY;

                    const newRect = { x: newX, y: newY, width: objSize, height: objSize };

                    // Verifica colis√£o com objetos j√° posicionados
                    for (const placedObj of placedObjects) {
                        // Calcula a dist√¢ncia m√≠nima necess√°ria entre os centros dos objetos
                        const requiredMinDistanceX = (newRect.width / 2) + (placedObj.width / 2) + minClearanceBetweenObjects;
                        const requiredMinDistanceY = (newRect.height / 2) + (placedObj.height / 2) + minClearanceBetweenObjects;

                        // Verifica se os objetos est√£o muito pr√≥ximos
                        if (Math.abs(newRect.x + newRect.width / 2 - (placedObj.x + placedObj.width / 2)) < requiredMinDistanceX &&
                            Math.abs(newRect.y + newRect.height / 2 - (placedObj.y + placedObj.height / 2)) < requiredMinDistanceY) {
                            collision = true;
                            break;
                        }
                    }

                    // Se for um obst√°culo ou um item colet√°vel, verifica tamb√©m colis√£o com a zona segura do jogador
                    if (!collision && (isObstacle || newRect.canBeCollected) && checkCollision(newRect, playerSafeZone)) {
                        collision = true;
                    }

                    attempts++;
                } while (collision && attempts < maxAttempts);

                if (attempts === maxAttempts) {
                    console.warn(`AVISO: N√£o foi poss√≠vel encontrar uma posi√ß√£o livre para o objeto de tamanho ${objSize} ap√≥s ${maxAttempts} tentativas. Pode haver sobreposi√ß√£o.`);
                }
                return { x: newX, y: newY, width: objSize, height: objSize };
            }

            // Posicionar obst√°culos primeiro para garantir o espa√ßamento
            obstaculos.forEach(obstacle => {
                const pos = getRandomPosition(obstacle.size, true); // Passa true para isObstacle
                obstacle.x = pos.x;
                obstacle.y = pos.y;
                placedObjects.push(obstacle);
            });

            // Posicionar o ba√∫ (apenas na Fase 1)
            if (chest && currentPhase === 1) {
                const pos = getRandomPosition(chest.size);
                chest.x = pos.x;
                chest.y = pos.y;
                placedObjects.push(chest);
            }

            // Posicionar itens
            itens.forEach(item => {
                const pos = getRandomPosition(item.size);
                item.x = pos.x;
                item.y = pos.y;
                placedObjects.push(item);
            });

            // Posicionar itens escolares
            schoolItems.forEach(sItem => {
                const pos = getRandomPosition(sItem.size);
                sItem.x = pos.x;
                sItem.y = pos.y;
                placedObjects.push(sItem);
            });
        }

        // Desenha um objeto no canvas
        function drawItem(item) {
            // Tenta usar uma lista de fontes de emoji para melhor compatibilidade
            ctx.font = `${item.size}px "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(item.emoji, item.x + item.size / 2, item.y + item.size / 2);
        }

        // Desenha o personagem no canvas
        function drawPlayer() {
            // Tenta usar uma lista de fontes de emoji para melhor compatibilidade
            ctx.font = `${player.width}px "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(player.emoji, player.x + player.width / 2, player.y + player.height / 2);
        }

        // Verifica colis√£o entre dois ret√¢ngulos (AABB)
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // L√≥gica de intera√ß√µes (coleta de itens, colis√£o com obst√°culos, intera√ß√£o com o ba√∫)
        function handleInteractions() {
            // Oculta qualquer dica LLM ativa ao interagir
            const hintMessageDiv = document.getElementById('llmHintMessage');
            if (hintMessageDiv) {
                hintMessageDiv.style.display = 'none';
            }
            if (hintTimeout) clearTimeout(hintTimeout);

            // 1. Coleta de Itens (se o bot√£o de a√ß√£o estiver pressionado)
            if (coletando) {
                // Percorre todos os itens para verificar coleta
                for (let i = 0; i < itens.length; i++) {
                    if (itens[i].canBeCollected && checkCollision(player, itens[i])) {
                        const collectedItem = itens.splice(i, 1)[0];
                        totalAllItemsCollected++; // Incrementa a contagem total

                        if (collectedItem.isObjective) {
                            if (currentPhase === 1) { // L√≥gica de objetivo da Fase 1
                                if (collectedItem.type === 'pedra') {
                                    pedrasColetadas++;
                                    console.log(`DEBUG: Pedra coletada! Total de pedras: ${pedrasColetadas}/${TOTAL_PEDRAS}`);
                                } else if (collectedItem.type === 'chave') {
                                    keysColetadas++; // Incrementa o contador de chaves
                                    console.log(`DEBUG: Chave coletada! Total de chaves: ${keysColetadas}/${TOTAL_CHAVES}`); // Log para a nova l√≥gica de chaves
                                }
                            } else if (currentPhase === 2) { // L√≥gica de objetivo da Fase 2
                                if (collectedItem.type === 'vale_sorvete') {
                                    valesSorveteColetados++;
                                    console.log(`DEBUG: Vale Sorvete coletado! Total de vales: ${valesSorveteColetados}/${TOTAL_VALES_SORVETE}`);
                                } else if (collectedItem.type === 'sorvete' && collectedItem.isObjective) { // Sorvetes objetivo na Fase 2
                                    sorvetesObjetivoColetados++;
                                    console.log(`DEBUG: Sorvete coletado! Total de sorvetes: ${sorvetesObjetivoColetados}/${TOTAL_SORVETES_OBJETIVO}`);
                                }
                            } else if (currentPhase === 3) { // L√≥gica de objetivo da Fase 3
                                if (collectedItem.type === 'trofeu') {
                                    trofeusColetados++;
                                    console.log(`DEBUG: Trof√©u coletado! Total de trof√©us: ${trofeusColetados}/${TOTAL_TROFEUS}`);
                                } else if (collectedItem.type === 'bola' && collectedItem.isObjective) { // Bolas objetivo na Fase 3
                                    bolasColetadas++;
                                    console.log(`DEBUG: Bola coletada! Total de bolas: ${bolasColetadas}/${TOTAL_BOLAS_FASE3}`);
                                } else if (collectedItem.type === 'pipa') { // Novo objetivo
                                    pipasColetadas++;
                                    console.log(`DEBUG: Pipa coletada! Total: ${pipasColetadas}/${TOTAL_PIPAS}`);
                                }
                            } else if (currentPhase === 4) { // L√≥gica de objetivo da Fase 4
                                if (collectedItem.type === 'tubo_ensaio') {
                                    tubosEnsaioColetados++;
                                    console.log(`DEBUG: Tubo de Ensaio coletado! Total: ${tubosEnsaioColetados}/${TOTAL_TUBOS_ENSAIO}`);
                                } else if (collectedItem.type === 'ima') {
                                    imasColetados++;
                                    console.log(`DEBUG: √çm√£ coletado! Total: ${imasColetados}/${TOTAL_IMAS}`);
                                } else if (collectedItem.type === 'microscopio') { // Novo objetivo
                                    microscopioColetados++;
                                    console.log(`DEBUG: Microsc√≥pio coletado! Total: ${microscopioColetados}/${TOTAL_MICROSCOPIO}`);
                                }
                            } else if (currentPhase === 5) {
                                // Itens do objetivo principal da Fase 5: 3 Elefantes, 3 Le√µes, 3 Aves
                                if (collectedItem.type === 'elefante') {
                                    elefantesColetados++;
                                    console.log(`DEBUG: Elefante coletado! Total: ${elefantesColetados}/${TOTAL_ELEFANTES}`);
                                } else if (collectedItem.type === 'leao') {
                                    leoesColetados++;
                                    console.log(`DEBUG: Le√£o coletado! Total: ${leoesColetados}/${TOTAL_LEOES}`);
                                } else if (collectedItem.type === 'ave') {
                                    avesColetadas++;
                                    console.log(`DEBUG: Ave coletada! Total: ${avesColetadas}/${TOTAL_AVES}`);
                                }
                            } else if (currentPhase === 6) {
                                // Itens do objetivo principal da Fase 6: 3 Pinturas, 3 Esculturas, 3 F√≥sseis
                                if (collectedItem.type === 'pintura') {
                                    pinturasColetadas++;
                                    console.log(`DEBUG: Pintura coletada! Total: ${pinturasColetadas}/${TOTAL_PINTURAS}`);
                                } else if (collectedItem.type === 'escultura') {
                                    esculturasColetadas++;
                                    console.log(`DEBUG: Escultura coletada! Total: ${esculturasColetadas}/${TOTAL_ESCULTURAS}`);
                                } else if (collectedItem.type === 'fossil') {
                                    fosseisColetados++;
                                    console.log(`DEBUG: F√≥ssil coletado! Total: ${fosseisColetados}/${TOTAL_FOSSEIS}`);
                                }
                            } else if (currentPhase === 7) {
                                // Itens do objetivo principal da Fase 7: 3 Cestas de Piquenique, 3 Bolas, 3 Brinquedos de Parque
                                if (collectedItem.type === 'cesta_piquenique') {
                                    cestasPiqueniqueColetadas++;
                                    console.log(`DEBUG: Cesta de Piquenique coletada! Total: ${cestasPiqueniqueColetadas}/${TOTAL_CESTAS_PIQUENIQUE}`);
                                } else if (collectedItem.type === 'bola' && collectedItem.isObjective) {
                                    bolasFase7Coletadas++;
                                    console.log(`DEBUG: Bola (Fase 7) coletada! Total: ${bolasFase7Coletadas}/${TOTAL_BOLAS_FASE7}`);
                                } else if (collectedItem.type === 'brinquedo_parque') {
                                    brinquedosParqueColetados++;
                                    console.log(`DEBUG: Brinquedo de Parque coletado! Total: ${brinquedosParqueColetados}/${TOTAL_BRINQUEDOS_PARQUE}`);
                                }
                            } else if (currentPhase === 8) { // Cap√≠tulo 8: Leiturinhas
                                if (collectedItem.type === 'livro_aventura') {
                                    livroAventuraColetados++;
                                    console.log(`DEBUG: Livro de Aventura coletado! Total: ${livroAventuraColetados}/${TOTAL_LIVRO_AVENTURA}`);
                                } else if (collectedItem.type === 'livro_animais') {
                                    livroAnimaisColetados++;
                                    console.log(`DEBUG: Livro de Animais coletado! Total: ${livroAnimaisColetados}/${TOTAL_LIVRO_ANIMAIS}`);
                                } else if (collectedItem.type === 'livro_fabula') {
                                    livroFabulaColetados++;
                                    console.log(`DEBUG: Livro de F√°bula coletado! Total: ${livroFabulaColetados}/${TOTAL_LIVRO_FABULA}`);
                                }
                            } else if (currentPhase === 9) {
                                if (collectedItem.type === 'lixeira_reciclagem') {
                                    lixeiraReciclagemColetados++;
                                    console.log(`DEBUG: Lixeira de Reciclagem coletada! Total: ${lixeiraReciclagemColetados}/${TOTAL_LIXEIRA_RECICLAGEM}`);
                                } else if (collectedItem.type === 'garrafa_plastico') {
                                    garrafaPlasticoColetados++;
                                    console.log(`DEBUG: Garrafa Pl√°stica coletada! Total: ${garrafaPlasticoColetados}/${TOTAL_GARRAFA_PLASTICO}`);
                                } else if (collectedItem.type === 'arvore_muda') {
                                    arvoreMudaColetados++;
                                    console.log(`DEBUG: Muda de √Årvore coletada! Total: ${arvoreMudaColetados}/${TOTAL_ARVORE_MUDA}`);
                                }
                            } else if (currentPhase === 10) {
                                if (collectedItem.type === 'planta_nativa') {
                                    plantaNativaColetados++;
                                    console.log(`DEBUG: Planta Nativa coletada! Total: ${plantaNativaColetados}/${TOTAL_PLANTAS_NATIVAS}`);
                                } else if (collectedItem.type === 'animal_selvagem') {
                                    animalSelvagemColetados++;
                                    console.log(`DEBUG: Animal Selvagem coletado! Total: ${animalSelvagemColetados}/${TOTAL_ANIMAIS_SELVAGENS}`);
                                } else if (collectedItem.type === 11) {
                                    telescopioColetados++;
                                    console.log(`DEBUG: Telesc√≥pio coletado! Total: ${telescopioColetados}/${TOTAL_TELESCOPIO}`);
                                }
                            } else if (currentPhase === 11) {
                                if (collectedItem.type === 'pincel') {
                                    pincelColetados++;
                                    console.log(`DEBUG: Pincel coletado! Total: ${pincelColetados}/${TOTAL_PINCEL}`);
                                } else if (collectedItem.type === 'tinta') {
                                    tintaColetados++;
                                    console.log(`DEBUG: Tinta coletada! Total: ${tintaColetados}/${TOTAL_TINTA}`);
                                } else if (collectedItem.type === 'argila') {
                                    argilaColetados++;
                                    console.log(`DEBUG: Argila coletada! Total: ${argilaColetados}/${TOTAL_ARGILA}`);
                                }
                            } else if (currentPhase === 12) {
                                if (collectedItem.type === 'violao') {
                                    violaoColetados++;
                                    console.log(`DEBUG: Viol√£o coletado! Total: ${violaoColetados}/${TOTAL_VIOLAO}`);
                                } else if (collectedItem.type === 'piano') {
                                    pianoColetados++;
                                    console.log(`DEBUG: Piano coletado! Total: ${pianoColetados}/${TOTAL_PIANO}`);
                                } else if (collectedItem.type === 'microfone') {
                                    microfoneColetados++;
                                    console.log(`DEBUG: Microfone coletado! Total: ${microfoneColetados}/${TOTAL_MICROFONE}`);
                                }
                            }
                        } else if (collectedItem.type === 'moeda') {
                            tempo += 5;
                            console.log(`DEBUG: Moeda coletada! Tempo +5s. Tempo atual: ${tempo}`);
                        }
                        atualizarHUD();
                        coletando = false;
                        return;
                    }
                }


                // Depois verifica itens escolares n√£o colet√°veis (se houver)
                for (let i = 0; i < schoolItems.length; i++) {
                    if (schoolItems[i].canBeCollected && checkCollision(player, schoolItems[i])) {
                        const collectedItem = schoolItems.splice(i, 1)[0];
                        totalAllItemsCollected++; // Incrementa a contagem total
                        atualizarHUD();
                        coletando = false;
                        return;
                    }
                }


                // 2. Intera√ß√£o com o Ba√∫ (apenas na Fase 1)
                if (currentPhase === 1 && chest && checkCollision(player, chest)) { // Only check collision if chest exists
                    if (pedrasColetadas === TOTAL_PEDRAS && keysColetadas === TOTAL_CHAVES) { // Updated condition
                        chest.isOpened = true; // Marca o ba√∫ como aberto
                        chest.emoji = 'üóÉÔ∏è'; // Muda o emoji do ba√∫ para aberto
                        console.log("DEBUG: Ba√∫ aberto com sucesso!");
                        coletando = false;
                        atualizarHUD(); // Atualiza o HUD para mostrar o ba√∫ aberto
                        // A transi√ß√£o de fase √© tratada no setInterval principal, que agora verifica chest.isOpened
                        return;
                    } else { // If trying to open but not all collected
                        const hintMessageDiv = document.getElementById('llmHintMessage');
                        let msg = "Voc√™ precisa coletar todos os itens do objetivo antes de abrir o ba√∫!";
                        if (pedrasColetadas < TOTAL_PEDRAS) {
                            msg += ` Faltam ${TOTAL_PEDRAS - pedrasColetadas} pedras.`;
                        }
                        if (keysColetadas < TOTAL_CHAVES) {
                            msg += ` Faltam ${TOTAL_CHAVES - keysColetadas} chaves.`;
                        }
                        if (hintMessageDiv) { // Check if element exists before setting innerText
                           hintMessageDiv.innerText = msg;
                           hintMessageDiv.style.display = 'block';
                        }
                        if (hintTimeout) clearTimeout(hintTimeout);
                        hintTimeout = setTimeout(() => {
                            if (hintMessageDiv) { // Check again before hiding
                                hintMessageDiv.style.display = 'none';
                            }
                        }, 5000);
                        coletando = false;
                    }
                }
            }
        }

        function atualizarHUD() {
            // Obtenha as refer√™ncias dos elementos do HUD aqui para garantir que s√£o v√°lidas
            const currentVidasDisplayElement = document.getElementById('vidasDisplay');
            const currentHudObjectiveLine1Element = document.getElementById('hudObjectiveLine1');
            const currentHudObjectiveLine2Element = document.getElementById('hudObjectiveLine2');
            const currentTotalAllItemsCollectedDisplayElement = document.getElementById('totalAllItemsCollectedDisplay');
            const currentTempoDisplayElement = document.getElementById('tempo');

            let coracao = "‚ù§Ô∏è".repeat(vidas); // Exibe cora√ß√µes com base nas vidas
            let objectiveLine1Content = ''; // Conte√∫do para a linha 1 do objetivo
            let objectiveLine2Content = ''; // Conte√∫do para a linha 2 do objetivo
            let hudTotalCollectedContent = `Total Coletado: ${totalAllItemsCollected}`;
            let hudTempoContent = `Tempo: ${tempo}s`;

            // HUD content for Phase 1
            if (currentPhase === 1) {
                objectiveLine1Content = `üî¥ Pedras: ${pedrasColetadas} / ${TOTAL_PEDRAS}`;
                objectiveLine2Content = `üîë Chave: ${keysColetadas} / ${TOTAL_CHAVES}<br>üì¶ Ba√∫: ${chest && chest.isOpened ? '1/1 üîì' : '0/1 üîí'}`;
            } else if (currentPhase === 2) {
                objectiveLine1Content = `üéüÔ∏è Vales Sorvete: ${valesSorveteColetados} / ${TOTAL_VALES_SORVETE}`;
                objectiveLine2Content = `üç´üç¶ Sorvetes: ${sorvetesObjetivoColetados} / ${TOTAL_SORVETES_OBJETIVO}`;
            } else if (currentPhase === 3) {
                objectiveLine1Content = `üèÜ Trof√©us: ${trofeusColetados} / ${TOTAL_TROFEUS}`;
                objectiveLine2Content = `‚öΩ Bolas: ${bolasColetadas} / ${TOTAL_BOLAS_FASE3}<br>ü™Å Pipas: ${pipasColetadas} / ${TOTAL_PIPAS}`;
            } else if (currentPhase === 4) {
                objectiveLine1Content = `üß™ Tubos Ensaio: ${tubosEnsaioColetados} / ${TOTAL_TUBOS_ENSAIO}`;
                objectiveLine2Content = `üß≤ √çm√£s: ${imasColetados} / ${TOTAL_IMAS}<br>üî¨ Microsc√≥pios: ${microscopioColetados} / ${TOTAL_MICROSCOPIO}`;
            } else if (currentPhase === 5) {
                objectiveLine1Content = `üêò Elefantes: ${elefantesColetados} / ${TOTAL_ELEFANTES}`;
                objectiveLine2Content = `ü¶Å Le√µes: ${leoesColetados} / ${TOTAL_LEOES}<br>ü¶ú Aves: ${avesColetadas} / ${TOTAL_AVES}`;
            } else if (currentPhase === 6) {
                objectiveLine1Content = `üé® Pinturas: ${pinturasColetadas} / ${TOTAL_PINTURAS}`;
                objectiveLine2Content = `üóø Esculturas: ${esculturasColetadas} / ${TOTAL_ESCULTURAS}<br>ü¶¥ F√≥sseis: ${fosseisColetados} / ${TOTAL_FOSSEIS}`;
            } else if (currentPhase === 7) {
                objectiveLine1Content = `üß∫ Cestas Piquenique: ${cestasPiqueniqueColetadas} / ${TOTAL_CESTAS_PIQUENIQUE}`;
                objectiveLine2Content = `‚öΩ Bolas: ${bolasFase7Coletadas} / ${TOTAL_BOLAS_FASE7}<br>üé† Brinquedos: ${brinquedosParqueColetados} / ${TOTAL_BRINQUEDOS_PARQUE}`;
            } else if (currentPhase === 8) {
                objectiveLine1Content = `üìñ Aventura: ${livroAventuraColetados} / ${TOTAL_LIVRO_AVENTURA}`;
                objectiveLine2Content = `ü¶Å Animais: ${livroAnimaisColetados} / ${TOTAL_LIVRO_ANIMAIS}<br>üìú F√°bula: ${livroFabulaColetados} / ${TOTAL_LIVRO_FABULA}`;
            } else if (currentPhase === 9) {
                objectiveLine1Content = `‚ôªÔ∏è Reciclagem: ${lixeiraReciclagemColetados} / ${TOTAL_LIXEIRA_RECICLAGEM}`;
                objectiveLine2Content = `üß¥ Pl√°stico: ${garrafaPlasticoColetados} / ${TOTAL_GARRAFA_PLASTICO}<br>üå± √Årvore: ${arvoreMudaColetados} / ${TOTAL_ARVORE_MUDA}`;
            } else if (currentPhase === 10) {
                objectiveLine1Content = `üåø Plantas: ${plantaNativaColetados} / ${TOTAL_PLANTAS_NATIVAS}`;
                objectiveLine2Content = `ü¶Å Animais: ${animalSelvagemColetados} / ${TOTAL_ANIMAIS_SELVAGENS}<br>üî≠ Telesc√≥pios: ${telescopioColetados} / ${TOTAL_TELESCOPIO}`;
            } else if (currentPhase === 11) {
                objectiveLine1Content = `üñåÔ∏è Pinc√©is: ${pincelColetados} / ${TOTAL_PINCEL}`;
                objectiveLine2Content = `üé® Tintas: ${tintaColetados} / ${TOTAL_TINTA}<br>üè∫ Argila: ${argilaColetados} / ${TOTAL_ARGILA}`;
            } else if (currentPhase === 12) {
                objectiveLine1Content = `üé∏ Viol√£o: ${violaoColetados} / ${TOTAL_VIOLAO}`;
                objectiveLine2Content = `üéπ Piano: ${pianoColetados} / ${TOTAL_PIANO}<br>üé§ Microfone: ${microfoneColetados} / ${TOTAL_MICROFONE}`;
            }

            // Atualiza o texto dos elementos do HUD
            if (currentVidasDisplayElement) currentVidasDisplayElement.innerText = `Vidas: ${coracao}`; // Adiciona o r√≥tulo "Vidas:"
            if (currentTotalAllItemsCollectedDisplayElement) currentTotalAllItemsCollectedDisplayElement.innerText = `Total Coletado: ${totalAllItemsCollected}`;
            if (currentTempoDisplayElement) currentTempoDisplayElement.innerText = `Tempo: ${tempo}s`; // Adiciona o r√≥tulo "Tempo:"

            if (currentHudObjectiveLine1Element) currentHudObjectiveLine1Element.innerHTML = objectiveLine1Content;
            if (currentHudObjectiveLine2Element) currentHudObjectiveLine2Element.innerHTML = objectiveLine2Content;
        }

        function encerrar(msg) {
            console.log("Encerrar chamado com mensagem:", msg); // Log de depura√ß√£o
            clearInterval(gameInterval); // Para o temporador do jogo
            document.getElementById('llmHintMessage').style.display = 'none'; // Oculta a mensagem de dica LLM
            if (hintTimeout) clearTimeout(hintTimeout); // Limpa qualquer timeout de dica

            const modal = document.getElementById('gameModal');
            document.getElementById('modalMessage').innerText = msg;
            modal.style.display = 'flex'; // Mostra o modal
            stopAllMusic(); // Parar m√∫sica ao encerrar o jogo
        }

        function showTemporaryMessage(msg, duration) {
            const tempMessageDiv = document.getElementById('temporaryMessage');
            if (tempMessageDiv) {
                tempMessageDiv.innerText = msg;
                tempMessageDiv.style.display = 'block';
                setTimeout(() => {
                    tempMessageDiv.style.display = 'none';
                }, duration);
            }
        }

        function showContinueScreen() {
            document.getElementById('continueModal').style.display = 'flex';
            continueTime = 10;
            document.getElementById('continueCountdown').innerText = continueTime;

            if (continueCountdownInterval) clearInterval(continueCountdownInterval);
            continueCountdownInterval = setInterval(() => {
                continueTime--;
                document.getElementById('continueCountdown').innerText = continueTime;
                if (continueTime <= 0) {
                    clearInterval(continueCountdownInterval);
                    handleContinue('nao');
                }
            }, 1000);
            stopAllMusic(); // Parar m√∫sica na tela de continue
        }

        function handleContinue(choice) {
            clearInterval(continueCountdownInterval);
            document.getElementById('continueModal').style.display = 'none';

            if (choice === 'sim') {
                console.log("DEBUG: Jogador escolheu SIM. Reiniciando para sele√ß√£o de personagem.");
                vidas = 3;
                document.getElementById('personagemSelecao').style.display = 'flex';
                if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
                pedrasColetadas = 0;
                keysColetadas = 0;
                valesSorveteColetados = 0;
                sorvetesObjetivoColetados = 0;
                trofeusColetados = 0;
                bolasColetadas = 0;
                pipasColetadas = 0;
                tubosEnsaioColetados = 0;
                imasColetados = 0;
                microscopioColetados = 0;
                elefantesColetados = 0;
                leoesColetados = 0;
                avesColetadas = 0;
                pinturasColetadas = 0;
                esculturasColetadas = 0;
                fosseisColetados = 0;
                cestasPiqueniqueColetadas = 0;
                bolasFase7Coletadas = 0;
                brinquedosParqueColetados = 0;
                totalAllItemsCollected = 0;
                livroAventuraColetados = 0;
                livroAnimaisColetados = 0;
                livroFabulaColetados = 0;
                lixeiraReciclagemColetados = 0;
                garrafaPlasticoColetados = 0;
                arvoreMudaColetados = 0;
                plantaNativaColetados = 0;
                animalSelvagemColetados = 0;
                telescopioColetados = 0;
                pincelColetados = 0;
                tintaColetados = 0;
                argilaColetados = 0;
                violaoColetados = 0;
                pianoColetados = 0;
                microfoneColetados = 0;
                tempo = BASE_TIME; // Reset time to base for new game
                coletando = false;
                hasKey = false;
                itens = [];
                obstaculos = [];
                schoolItems = [];
                chest = null; // Reset chest for new game

                // Go back to intro screen for a full restart
                document.getElementById('introScreen').style.display = 'flex';
                document.getElementById('personagemSelecao').style.display = 'none';
                document.getElementById('hud').style.display = 'none';
            } else {
                console.log("DEBUG: Jogador escolheu N√ÉO ou tempo esgotou. Recarrega a p√°gina.");
                location.reload();
            }
        }

        function animar(currentTime) {
            requestAnimationFrame(animar);

            if (currentTime < lastFrameTime + frameInterval) {
                return;
            }
            lastFrameTime = currentTime;

            let winConditionMet = false;
            if (currentPhase === 1) {
                winConditionMet = (chest && chest.isOpened);
            } else if (currentPhase === 2) {
                winConditionMet = (valesSorveteColetados === TOTAL_VALES_SORVETE && sorvetesObjetivoColetados === TOTAL_SORVETES_OBJETIVO);
            } else if (currentPhase === 3) {
                winConditionMet = (trofeusColetados >= TOTAL_TROFEUS && bolasColetadas >= TOTAL_BOLAS_FASE3 && pipasColetadas >= TOTAL_PIPAS);
            } else if (currentPhase === 4) {
                winConditionMet = (tubosEnsaioColetados >= TOTAL_TUBOS_ENSAIO && imasColetados >= TOTAL_IMAS && microscopioColetados >= TOTAL_MICROSCOPIO);
            } else if (currentPhase === 5) {
                winConditionMet = (elefantesColetados >= TOTAL_ELEFANTES && leoesColetados >= TOTAL_LEOES && avesColetadas >= TOTAL_AVES);
            } else if (currentPhase === 6) {
                winConditionMet = (pinturasColetadas === TOTAL_PINTURAS && esculturasColetadas === TOTAL_ESCULTURAS && fosseisColetados >= TOTAL_FOSSEIS);
            } else if (currentPhase === 7) {
                winConditionMet = (cestasPiqueniqueColetadas >= TOTAL_CESTAS_PIQUENIQUE && bolasFase7Coletadas >= TOTAL_BOLAS_FASE7 && brinquedosParqueColetados >= TOTAL_BRINQUEDOS_PARQUE);
            } else if (currentPhase === 8) {
                winConditionMet = (livroAventuraColetados >= TOTAL_LIVRO_AVENTURA && livroAnimaisColetados >= TOTAL_LIVRO_ANIMAIS && livroFabulaColetados >= TOTAL_LIVRO_FABULA);
            } else if (currentPhase === 9) {
                winConditionMet = (lixeiraReciclagemColetados >= TOTAL_LIXEIRA_RECICLAGEM && garrafaPlasticoColetados >= TOTAL_GARRAFA_PLASTICO && arvoreMudaColetados >= TOTAL_ARVORE_MUDA);
            } else if (currentPhase === 10) {
                winConditionMet = (plantaNativaColetados >= TOTAL_PLANTAS_NATIVAS && animalSelvagemColetados >= TOTAL_ANIMAIS_SELVAGENS && telescopioColetados >= TOTAL_TELESCOPIO);
            } else if (currentPhase === 11) {
                winConditionMet = (pincelColetados >= TOTAL_PINCEL && tintaColetados >= TOTAL_TINTA && argilaColetados >= TOTAL_ARGILA);
            } else if (currentPhase === 12) {
                winConditionMet = (violaoColetados >= TOTAL_VIOLAO && pianoColetados >= TOTAL_PIANO && microfoneColetados >= TOTAL_MICROFONE);
            }

            if (vidas <= 0 || tempo <= 0 || winConditionMet) {
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const prevX = player.x;
            const prevY = player.y;

            if (teclas["w"]) player.y -= PLAYER_SPEED;
            if (teclas["s"]) player.y += PLAYER_SPEED;
            if (teclas["a"]) player.x -= PLAYER_SPEED;
            if (teclas["d"]) player.x += PLAYER_SPEED;

            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
            player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));

            obstaculos.forEach(obstacle => {
                const exclusionZone = 1.0;
                const expandedObstacleRect = {
                    x: obstacle.x - (obstacle.size * (exclusionZone - 1) / 2),
                    y: obstacle.y - (obstacle.size * (exclusionZone - 1) / 2),
                    width: obstacle.width * exclusionZone,
                    height: obstacle.height * exclusionZone
                };
                if (obstacle.isObstacle && checkCollision(player, expandedObstacleRect)) {
                    player.x = prevX;
                    player.y = prevY;
                }
            });

            handleInteractions();

            if (chest && currentPhase === 1) {
                drawItem(chest);
            }
            schoolItems.forEach(drawItem);
            obstaculos.forEach(drawItem);
            itens.forEach(drawItem);
            drawPlayer();
        }

        function updatePageTitle(phase) {
            let title = "Ursinho Amig√£o 2D - ";
            switch (phase) {
                case 1:
                    title += "Cap√≠tulo 1: Uma Aventura de Aprendizados";
                    break;
                case 2:
                    title += "Cap√≠tulo 2: A Festa do Sorvete";
                    break;
                case 3:
                    title += "Cap√≠tulo 3: Brincadeira de Crian√ßa";
                    break;
                case 4:
                    title += "Cap√≠tulo 4: Nem Todo Dia √© Brincadeira, mas Tamb√©m √©...";
                    break;
                case 5:
                    title += "Cap√≠tulo 5: No Reino dos Animais";
                    break;
                case 6:
                    title += "Cap√≠tulo 6: Aprender √© uma Arte";
                    break;
                case 7:
                    title += "Cap√≠tulo 7: Lazer no Parque";
                    break;
                case 8:
                    title += "Cap√≠tulo 8: Leiturinhas";
                    break;
                case 9:
                    title += "Cap√≠tulo 9: Planeta";
                    break;
                case 10:
                    title += "Cap√≠tulo 10: Explora√ß√£o da Natureza";
                    break;
                case 11:
                    title += "Cap√≠tulo 11: Oficina de Artes";
                    break;
                case 12:
                    title += "Cap√≠tulo 12: M√∫sica e Dan√ßa";
                    break;
                default:
                    title += "Aventura Desconhecida";
            }
            document.title = title;
            // Obtenha a refer√™ncia ao elemento chapterTitleDisplayElement aqui
            const currentChapterTitleDisplayElement = document.getElementById('chapterTitleDisplay');
            if (currentChapterTitleDisplayElement) {
                currentChapterTitleDisplayElement.innerText = title.split(" - ")[1];
            }
        }

        // Fun√ß√£o principal de inicializa√ß√£o do jogo
        function initGame() {
            // Obtenha as refer√™ncias globais aos elementos do HUD aqui
            vidasDisplayElement = document.getElementById('vidasDisplay');
            hudObjectiveLine1Element = document.getElementById('hudObjectiveLine1');
            hudObjectiveLine2Element = document.getElementById('hudObjectiveLine2');
            totalAllItemsCollectedDisplayElement = document.getElementById('totalAllItemsCollectedDisplay');
            tempoDisplayElement = document.getElementById('tempo');
            chapterTitleDisplayElement = document.getElementById('chapterTitleDisplay');
            objetivoFaseElement = document.getElementById('objetivoFase');

            // Atribui canvas e ctx ap√≥s o DOM estar carregado
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas(); // Chama resizeCanvas para definir as dimens√µes iniciais
            window.addEventListener('resize', resizeCanvas); // Adiciona listener para redimensionar

            // Obtenha refer√™ncias aos elementos de √°udio
            introMusicElement = document.getElementById('introMusic');
            
            // Tentar tocar a m√∫sica de introdu√ß√£o. Pode falhar devido a pol√≠ticas de autoplay.
            // A reprodu√ß√£o ser√° ativada na primeira intera√ß√£o do usu√°rio.
            if (introMusicElement) {
                introMusicElement.volume = 0.5; // Define um volume padr√£o
            }

            console.log("DEBUG: tempoDisplayElement no onload:", tempoDisplayElement); // Debug: verificar se o elemento √© encontrado

            const introScreen = document.getElementById('introScreen');
            const personagemSelecao = document.getElementById('personagemSelecao');
            
            const dismissIntro = () => {
                console.log("DEBUG: dismissIntro called.");
                const currentIntroScreen = document.getElementById('introScreen');
                const currentPersonagemSelecao = document.getElementById('personagemSelecao');

                if (currentIntroScreen && currentIntroScreen.style.display !== 'none') {
                    currentIntroScreen.style.display = 'none';
                    if (currentPersonagemSelecao) {
                        currentPersonagemSelecao.style.display = 'flex';
                        console.log("DEBUG: Transi√ß√£o para sele√ß√£o de personagem.");
                    } else {
                        console.error("ERRO: Elemento 'personagemSelecao' n√£o encontrado no DOM (dentro de dismissIntro).");
                    }
                    // Tentar tocar a m√∫sica aqui, ap√≥s a intera√ß√£o do usu√°rio
                    if (introMusicElement && introMusicElement.paused) {
                        introMusicElement.play().catch(e => console.log("Erro ao tocar m√∫sica de introdu√ß√£o ap√≥s intera√ß√£o:", e));
                        currentMusic = introMusicElement; // Define a m√∫sica de introdu√ß√£o como a m√∫sica atual
                    }
                    document.removeEventListener('keydown', dismissIntro);
                    currentIntroScreen.removeEventListener('click', dismissIntro);
                    currentIntroScreen.removeEventListener('touchstart', dismissIntro);
                }
            };

            if (introScreen) {
                introScreen.addEventListener('click', dismissIntro);
                introScreen.addEventListener('touchstart', dismissIntro);
            } else {
                console.error("ERRO: Elemento 'introScreen' n√£o encontrado no DOM (no window.onload).");
            }
            document.addEventListener('keydown', dismissIntro);

            document.getElementById('personagemUrso').addEventListener('click', () => selecionar('urso'));
            document.getElementById('personagemGato').addEventListener('click', () => selecionar('gato'));
            document.getElementById('personagemGirafa').addEventListener('click', () => selecionar('girafa'));
            document.getElementById('personagemCoelho').addEventListener('click', () => selecionar('coelho'));

            document.getElementById('btnUp').addEventListener('touchstart', (e) => { e.preventDefault(); tecla('w', true); });
            document.getElementById('btnUp').addEventListener('touchend', (e) => { e.preventDefault(); tecla('w', false); });
            document.getElementById('btnLeft').addEventListener('touchstart', (e) => { e.preventDefault(); tecla('a', true); });
            document.getElementById('btnLeft').addEventListener('touchend', (e) => { e.preventDefault(); tecla('a', false); });
            document.getElementById('btnDown').addEventListener('touchstart', (e) => { e.preventDefault(); tecla('s', true); });
            document.getElementById('btnDown').addEventListener('touchend', (e) => { e.preventDefault(); tecla('s', false); });
            document.getElementById('btnRight').addEventListener('touchstart', (e) => { e.preventDefault(); tecla('d', true); });
            document.getElementById('btnRight').addEventListener('touchend', (e) => { e.preventDefault(); tecla('d', false); });

            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                if (['w', 'a', 's', 'd', ' '].includes(key)) {
                    e.preventDefault();
                    if (key === ' ') {
                        coletando = true;
                    } else {
                        tecla(key, true);
                    }
                }
            });
            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                if (['w', 'a', 's', 'd', ' '].includes(key)) {
                    e.preventDefault();
                    if (key === ' ') {
                        coletando = false;
                    } else {
                        tecla(key, false);
                    }
                }
            });

            document.getElementById('botao-acao').addEventListener('touchstart', (e) => { e.preventDefault(); coletando = true; });
            document.getElementById('botao-acao').addEventListener('touchend', (e) => { e.preventDefault(); coletando = false; });

            // L√≥gica do bot√£o de controle de som
            const soundControlBtn = document.getElementById('soundControlBtn');
            const soundOnIcon = document.getElementById('soundOnIcon');
            const soundOffIcon = document.getElementById('soundOffIcon');

            if (soundControlBtn && soundOnIcon && soundOffIcon) {
                soundControlBtn.addEventListener('click', () => {
                    // Verifica qual m√∫sica est√° atualmente tocando para controlar o mute
                    const musicToControl = currentMusic; 
                    if (musicToControl) {
                        musicToControl.muted = !musicToControl.muted; // Alterna o estado mudo
                        if (musicToControl.muted) {
                            soundOnIcon.style.display = 'none';
                            soundOffIcon.style.display = 'block';
                        } else {
                            soundOnIcon.style.display = 'block';
                            soundOffIcon.style.display = 'none';
                            // Tenta tocar apenas se n√£o estiver tocando (para evitar m√∫ltiplos play() chamadas)
                            if (musicToControl.paused) {
                                musicToControl.play().catch(e => console.log("Erro ao tentar tocar m√∫sica ap√≥s desmutar:", e));
                            }
                        }
                    }
                });
            }


            atualizarHUD(); // Atualiza o HUD com os valores iniciais
        }

        // Chama a fun√ß√£o principal de inicializa√ß√£o do jogo quando o DOM estiver completamente carregado
        document.addEventListener('DOMContentLoaded', initGame);
    </script>

    <script>
      function selecionar(tipo) {
        const intro = document.getElementById("introScreen");
        if (intro) intro.remove();
        iniciar(tipo);
      }
    </script>
    </body>
</html>
