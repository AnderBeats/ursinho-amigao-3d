<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ursinho Amigão 2D - Aventura de Aprendizados</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #aee1f9; /* Fundo azul claro */
            font-family: 'Inter', sans-serif; /* Usando a fonte Inter */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align items to the top initially */
            min-height: 100vh; /* Garante que o corpo ocupa a altura total da viewport */
            position: relative; /* For absolute positioning of intro/selection screens */
        }
        #introScreen, #personagemSelecao {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            background: #aee1f9;
            color: #333;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            cursor: pointer;
        }
        #personagemSelecao {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: none; /* Hidden by default */
        }
        #introImagePlaceholder {
            width: 400px;
            height: 300px;
            background-color: #ffd54f;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8em;
            color: #333;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        #introScreen h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        #introScreen h1 span {
            display: block;
        }
        #introScreen p {
            font-size: 1.5em;
            font-weight: bold;
            color: #34495e;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .personagem-opcoes {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .personagem {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #333;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, background-color 0.2s;
            text-align: center;
            font-size: 3em;
        }
        .personagem:hover {
            background-color: #ffd54f;
            transform: translateY(-5px);
        }
        .personagem span {
            font-size: 0.3em;
            display: block;
            margin-top: 0.2em;
        }

        /* Main game content container */
        #mainGameContainer {
            position: absolute; /* Changed to absolute to fit between fixed header/footer */
            top: 0; /* Will be set dynamically by JS */
            bottom: 0; /* Will be set dynamically by JS */
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around; /* Centraliza verticalmente HUD e Canvas com espaço ao redor */
            box-sizing: border-box;
        }

        #chapterTitleDisplay {
            position: fixed; /* Mantém fixo no topo */
            top: 0; /* Alinha no topo */
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 0 0 8px 8px; /* Cantos arredondados apenas na parte inferior */
            font-size: 1.2em;
            z-index: 100; /* Garante que fique acima de outros elementos */
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #hud {
            width: 90%;
            max-width: 700px;
            background: rgba(0,0,0,0.4);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            font-size: 1.1em;
            display: flex; /* Sempre flexível quando visível */
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            box-sizing: border-box;
            /* Margens controladas por justify-content: space-around no pai */
        }
        .hud-column {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-basis: 48%;
            padding: 0 5px;
            box-sizing: border-box;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
        }
        .hud-column:last-child {
            align-items: flex-end;
        }

        canvas {
            background-color: #8bc34a;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            display: block;
            margin: 0 auto; /* Centraliza horizontalmente */
            flex-shrink: 0; /* Impede que o canvas encolha abaixo do seu tamanho de conteúdo */
            /* Largura e altura serão definidas dinamicamente pelo JS para manter a proporção 1:1 */
            width: auto;
            height: auto;
        }

        /* Container para todos os controles inferiores */
        #bottomControlsContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between; /* Distribui os itens */
            align-items: flex-end; /* Alinha os itens na parte inferior */
            padding: 10px 20px; /* Preenchimento dentro do contêiner */
            box-sizing: border-box;
            z-index: 100; /* Garante que fique acima de outros elementos */
            background: rgba(0,0,0,0.2); /* Fundo semi-transparente para visibilidade */
        }

        /* Controles posicionados estaticamente dentro de seu contêiner */
        #direcional {
            position: static; /* Não é mais fixo, agora é relativo a #bottomControlsContainer */
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .linha {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .botao-direcional, .botao-jogo {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            transition: background 0.2s, transform 0.1s;
            z-index: 10;
        }
        .botao-direcional:active, .botao-jogo:active {
            background: rgba(255,255,255,0.5);
            transform: translateY(2px);
        }
        #botao-acao {
            position: static; /* Não é mais fixo, agora é relativo a #bottomControlsContainer */
            margin-left: auto; /* Empurra para a direita */
            margin-right: 10px; /* Espaço do controle de som */
            width: 70px; /* Torna um pouco maior */
            height: 70px;
            border-radius: 50%;
        }

        #soundControlBtn {
            position: static; /* Não é mais fixo, agora é relativo a #bottomControlsContainer */
            width: 60px;
            height: 60px;
            margin: 0 auto; /* Centraliza horizontalmente dentro do flex container */
        }
        #soundControlBtn svg {
            width: 30px;
            height: 30px;
        }

        /* Overlays/Modals */
        #llmHintMessage, #temporaryMessage, #gameModal, #continueModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
            z-index: 25;
            display: none;
            max-width: 70%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #continueModal {
            z-index: 30;
            background: rgba(0, 0, 0, 0.9);
            flex-direction: column;
        }
        #continueModal h2 { font-size: 2.5em; margin-bottom: 20px; }
        #continueModal p { font-size: 1.8em; margin-bottom: 30px; }
        #continueModal .botoes-continue { display: flex; gap: 20px; }
        #continueModal .botoes-continue button {
            padding: 15px 30px; font-size: 1.5em; border: none; border-radius: 10px;
            cursor: pointer; transition: background-color 0.2s, transform 0.1s;
        }
        #continueModal .botoes-continue button:hover { background-color: #45a049; transform: translateY(-2px); }
        #continueModal #btnSim { background-color: #4CAF50; color: white; }
        #continueModal #btnNao { background-color: #f44336; color: white; }


        /* Media Queries for Mobile Adjustments */
        @media (max-width: 768px) {
            #introImagePlaceholder {
                width: 80vw;
                height: 40vh;
                font-size: 6em;
            }
            #introScreen h1 {
                font-size: 1.8em;
            }
            #introScreen p {
                font-size: 1.2em;
            }
            #mainGameContainer {
                padding-top: 60px; /* Adjusted padding-top for mobile */
            }
            #hud {
                font-size: 0.9em;
                padding: 8px;
                margin-top: 5px; /* Reduced margin for mobile */
                margin-bottom: 5px; /* Reduced margin for mobile */
            }
            .hud-column {
                align-items: flex-start;
            }
            .hud-column:last-child {
                align-items: flex-end;
            }
            .botao-direcional, .botao-jogo {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            #botao-acao {
                width: 60px;
                height: 60px;
                font-size: 26px;
            }
            #direcional {
                bottom: 10px;
                left: 10px;
            }
            #botao-acao {
                bottom: 20px;
                right: 10px;
            }
            /* Removed gameModal related styles as it's no longer used */
            #continueModal h2 {
                font-size: 2em;
            }
            #continueModal p {
                font-size: 1.5em;
            }
            #continueModal .botoes-continue button {
                padding: 12px 25px;
                font-size: 1.2em;
            }
        }

        @media (max-width: 360px) {
            #mainGameContainer {
                padding-top: 50px; /* Further adjusted padding-top for very small screens */
            }
            #hud {
                font-size: 0.9em;
                padding: 8px;
                margin-top: 5px;
                margin-bottom: 5px;
            }
            .hud-column:last-child {
                align-items: center; /* Center text when stacked */
            }
            #introScreen h1 {
                font-size: 1.3em;
            }
            #introScreen p {
                font-size: 0.9em;
            }
            .botao-direcional, .botao-jogo {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            #botao-acao {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
            #direcional {
                bottom: 2px;
                left: 2px;
            }
            #botao-acao {
                bottom: 10px;
                right: 2px;
            }
        </style>
</head>
<body>
    <!-- Tela de Introdução -->
    <div id="introScreen">
        <div id="introImagePlaceholder">
            🐻
        </div>
        <h1>
            <span>Ursinho Amigão e Seus Amigos em:</span><br>
            <span>Meu Dia na Escola - Parte I</span>
        </h1>
        <p>Pressione qualquer botão para começar</p>
    </div>

    <!-- Tela de Seleção de Personagem -->
    <div id="personagemSelecao">
        <h2>Escolha seu personagem</h2>
        <div class="personagem-opcoes">
            <div class="personagem" id="personagemUrso" style="background:#f4c542;">🐻<br><span>URSINHO<br>AMIGÃO</span></div>
            <div class="personagem" id="personagemGato" style="background:#8bc34a;">🐱<br><span>GATINHO<br>TITO</span></div>
            <div class="personagem" id="personagemGirafa" style="background:#ffb74d;">🦒<br><span>GIRAFINHA<br>GINA</span></div>
            <div class="personagem" id="personagemCoelho" style="background:#e91e63;">🐰<br><span>COELHINHA<br>LILI</span></div>
        </div>
    </div>

    <!-- Título do Capítulo Centralizado -->
    <div id="chapterTitleDisplay"></div>

    <!-- Main Game Content Container -->
    <div id="mainGameContainer">
        <!-- Heads-Up Display (HUD) -->
        <div id="hud">
            <div class="hud-column">
                <span id="vidasDisplay"></span>
                <span id="totalAllItemsCollectedDisplay"></span>
                <span id="tempo"></span>
            </div>
            <div class="hud-column">
                <span id="hudObjectiveLine1"></span>
                <span id="hudObjectiveLine2"></span>
            </div>
        </div>

        <!-- Canvas para o jogo 2D -->
        <canvas id="gameCanvas" tabindex="0"></canvas>
    </div>

    <!-- Container para todos os controles inferiores -->
    <div id="bottomControlsContainer">
        <!-- Controles Direcionais para Celular -->
        <div id="direcional">
            <div class="linha">
                <button class="botao-direcional" id="btnUp">▲</button>
            </div>
            <div class="linha">
                <button class="botao-direcional" id="btnLeft">◄</button>
                <button class="botao-direcional" id="btnDown">▼</button>
                <button class="botao-direcional" id="btnRight">►</button>
            </div>
        </div>

        <!-- Botão de controle de som -->
        <button id="soundControlBtn" class="botao-jogo">
            <svg id="soundOnIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            <svg id="soundOffIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-x" style="display: none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        </button>

        <!-- Botão de Ação para Celular -->
        <button id="botao-acao" class="botao-jogo">A</button>
    </div>

    <!-- Mensagem de Dica LLM -->
    <div id="llmHintMessage" style="display: none;">
        Aguarde a dica...
    </div>

    <!-- Mensagem Temporária (ex: "Vida perdida!") -->
    <div id="temporaryMessage" style="display: none;"></div>

    <!-- Modal de Fim de Jogo/Vitória -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button onclick="location.reload()">Jogar Novamente</button>
        </div>
    </div>

    <!-- Novo Modal de Continue -->
    <div id="continueModal">
        <h2>Fim de Jogo!</h2>
        <p>Você perdeu todas as suas vidas. Deseja continuar do início?</p>
        <p>Tempo restante: <span id="continueCountdown">10</span>s</p>
        <div class="botoes-continue">
            <button id="btnSim">Sim</button>
            <button id="btnNao">Não</button>
        </div>
    </div>

    <!-- Tags de áudio para as trilhas sonoras -->
    <audio id="introMusic" src="https://raw.githack.com/AnderBeats/ursinho-amigao-3d/main/Ursinho%20Trilha/Abertura_Fim.mp3" preload="auto" loop></audio>
    <!-- Removida a tag de música de fase, pois apenas a música de introdução será utilizada por enquanto. -->

    <!-- Script principal do jogo -->
    <script>
        // Centraliza a lógica do jogo em um objeto global para melhor organização e evitar problemas de escopo.
        const game = {
            canvas: null,
            ctx: null,
            player: null,
            teclas: {}, // Armazena o estado das teclas pressionadas
            itens: [], // Array para todos os itens do tesouro (coletáveis)
            obstaculos: [], // Array para os obstáculos que bloqueiam o caminho
            schoolItems: [], // Novos itens escolares que não são coletáveis nem obstáculos
            chest: null, // O baú do tesouro
            pedrasColetadas: 0, // Contagem de pedras coletadas
            TOTAL_PEDRAS: 3, // Total de pedras necessárias
            keysColetadas: 0, // Novo: Contagem de chaves coletadas
            TOTAL_CHAVES: 3, // Novo: Total de chaves necessárias para a Fase 1

            valesSorveteColetados: 0, // Novo: Contagem de vales sorvete coletados
            TOTAL_VALES_SORVETE: 4, // Novo: Total de vales sorvete necessários para a Fase 2
            sorvetesObjetivoColetados: 0, // Novo: Contagem de sorvetes objetivo coletados
            TOTAL_SORVETES_OBJETIVO: 4, // Novo: Total de sorvetes objetivo necessários para a Fase 2
            trofeusColetados: 0, // Novo: Contagem de troféus coletados para a Fase 3
            TOTAL_TROFEUS: 3, // Novo: Total de troféus necessários para a Fase 3
            bolasColetadas: 0, // Novo: Contagem de bolas coletadas para a Fase 3
            TOTAL_BOLAS_FASE3: 3, // Novo: Total de bolas necessárias para a Fase 3
            pipasColetadas: 0, // Novo: Contagem de pipas coletadas para a Fase 3
            TOTAL_PIPAS: 3, // Novo: Total de pipas necessárias para a Fase 3

            tubosEnsaioColetados: 0, // Novo: Contagem de tubos de ensaio coletados para a Fase 4
            TOTAL_TUBOS_ENSAIO: 3, // Novo: Total de tubos de ensaio necessários para a Fase 4
            imasColetados: 0, // Novo: Contagem de ímãs coletados para a Fase 4
            TOTAL_IMAS: 3, // Novo: Total de ímãs necessários para a Fase 4
            microscopioColetados: 0, // Novo: Contagem de microscópios coletados para a Fase 4
            TOTAL_MICROSCOPIO: 3, // Novo: Total de microscópios necessários para a Fase 4
            elefantesColetados: 0, // Novo: Contagem de elefantes coletados para a Fase 5
            TOTAL_ELEFANTES: 3, // Novo: Total de elefantes necessários para a Fase 5
            leoesColetados: 0, // Novo: Contagem de leões coletados para a Fase 5
            TOTAL_LEOES: 3, // Novo: Total de leões necessários para a Fase 5
            avesColetadas: 0, // Novo: Contagem de aves coletadas para a Fase 5
            TOTAL_AVES: 3, // Novo: Total de aves necessárias para a Fase 5
            pinturasColetadas: 0, // Novo: Contagem de pinturas coletadas para a Fase 6
            TOTAL_PINTURAS: 3, // Novo: Total de pinturas necessárias para a Fase 6
            esculturasColetadas: 0, // Novo: Contagem de esculturas coletadas para a Fase 6
            TOTAL_ESCULTURAS: 3, // Novo: Total de esculturas necessárias para a Fase 6
            fosseisColetados: 0, // Novo: Contagem de fósseis coletados para a Fase 6
            TOTAL_FOSSEIS: 3, // Novo: Total de fósseis necessários para a Fase 6
            cestasPiqueniqueColetadas: 0, // Novo: Contagem de cestas de piquenique coletadas para a Fase 7
            TOTAL_CESTAS_PIQUENIQUE: 3, // Novo: Total de cestas de piquenique necessárias para a Fase 7
            bolasFase7Coletadas: 0, // Novo: Contagem de bolas coletadas para a Fase 7
            TOTAL_BOLAS_FASE7: 3, // Novo: Total de bolas necessárias para a Fase 7
            brinquedosParqueColetados: 0, // Novo: Contagem de brinquedos de parque coletados para a Fase 7
            TOTAL_BRINQUEDOS_PARQUE: 3, // Novo: Total de brinquedos de parque necessários para a Fase 7

            // Novos contadores para os capítulos 8 a 12
            livroAventuraColetados: 0,
            TOTAL_LIVRO_AVENTURA: 3,
            livroAnimaisColetados: 0,
            TOTAL_LIVRO_ANIMAIS: 3,
            livroFabulaColetados: 0,
            TOTAL_LIVRO_FABULA: 3,

            lixeiraReciclagemColetados: 0,
            TOTAL_LIXEIRA_RECICLAGEM: 3,
            garrafaPlasticoColetados: 0,
            TOTAL_GARRAFA_PLASTICO: 3,
            arvoreMudaColetados: 0,
            TOTAL_ARVORE_MUDA: 3,

            plantaNativaColetados: 0,
            TOTAL_PLANTAS_NATIVAS: 3,
            animalSelvagemColetados: 0,
            TOTAL_ANIMAIS_SELVAGENS: 3,
            telescopioColetados: 0, // Renamed from binoculosColetados
            TOTAL_TELESCOPIO: 3, // Renamed from TOTAL_BINOCULOS

            pincelColetados: 0,
            TOTAL_PINCEL: 3,
            tintaColetados: 0,
            TOTAL_TINTA: 3,
            argilaColetados: 0,
            TOTAL_ARGILA: 3,

            violaoColetados: 0,
            TOTAL_VIOLAO: 3,
            pianoColetados: 0,
            TOTAL_PIANO: 3,
            microfoneColetados: 0,
            TOTAL_MICROFONE: 3,

            // Variáveis para o sistema de níveis
            currentLevel: 1, // Começa no Nível 1
            BASE_TIME: 90, // Tempo base em segundos para o Nível 1
            TIME_DECREMENT_PER_LEVEL: 10, // Decremento de tempo por nível

            totalAllItemsCollected: 0, // Nova variável para contar TODOS os itens coletados
            vidas: 3, // Vidas do jogador
            tempo: 0, // Tempo do jogo em segundos (inicializado em iniciar)
            coletando: false, // Flag para ação de coleta (coletar item ou usar chave no baú)
            gameInterval: null, // Para o temporador do jogo
            hintTimeout: null, // Para esconder a dica LLM
            hasKey: false, // Flag para verificar se a chave foi coletada
            continueCountdownInterval: null, // Intervalo para a contagem regressiva do continue
            continueTime: 10, // Tempo inicial da contagem regressiva do continue
            currentPlayerType: '', // Armazena o tipo de personagem selecionado para reinícios
            currentPhase: 1, // Inicia na Fase 1

            PLAYER_SIZE: 35, // Tamanho do personagem (AJUSTADO)
            ITEM_SIZE: 25, // Tamanho dos itens coletáveis (AJUSTADO)
            OBSTACLE_SIZE: 25, // Tamanho dos obstáculos (AJUSTADO)
            SCHOOL_ITEM_SIZE: 25, // Tamanho dos itens escolares não coletáveis (AJUSTADO)
            CHEST_SIZE: 45, // Tamanho do baú (AJUSTADO)
            PLAYER_SPEED: 2, // Velocidade do personagem (AJUSTADO PARA SER MAIS LENTO)

            // Variáveis para o limitador de FPS
            targetFPS: 30, // FPS alvo
            frameInterval: 0, // Intervalo de tempo entre frames em ms (calculado em initGame)
            lastFrameTime: 0, // Initialized globally

            // Global references to HUD elements (set in initGame)
            vidasDisplayElement: null,
            hudObjectiveLine1Element: null,
            hudObjectiveLine2Element: null,
            totalAllItemsCollectedDisplayElement: null,
            tempoDisplayElement: null,
            chapterTitleDisplayElement: null,
            objetivoFaseElement: null,
            
            // Variáveis de áudio
            introMusicElement: null,
            currentMusic: null, // Para controlar a música que está tocando atualmente

            // Método para tocar uma música, pausando a anterior se houver
            playMusic: function(musicElement) {
                // Se a música atual não é a que queremos tocar ou se não há música tocando, ajusta.
                if (this.currentMusic !== musicElement) {
                    if (this.currentMusic) {
                        this.currentMusic.pause();
                        this.currentMusic.currentTime = 0; // Reinicia a música para o começo
                    }
                    this.currentMusic = musicElement;
                    if (this.currentMusic) {
                        this.currentMusic.play().catch(e => console.log("Erro ao tocar música (pode precisar de interação do usuário):", e));
                    }
                } else if (this.currentMusic && this.currentMusic.paused) {
                    // Se a mesma música já está selecionada mas está pausada, tenta tocar.
                    this.currentMusic.play().catch(e => console.log("Erro ao retomar música (pode precisar de interação do usuário):", e));
                }
            },

            // Método para parar toda a música
            stopAllMusic: function() {
                if (this.currentMusic) {
                    this.currentMusic.pause();
                    this.currentMusic.currentTime = 0;
                    this.currentMusic = null;
                }
            },

            // Método para atualizar o estado da tecla (para teclado e toque)
            tecla: function(k, v) {
                this.teclas[k] = v;
            },

            // Método para redimensionar o canvas
            resizeCanvas: function() {
                if (!this.canvas) return;

                // Get heights of fixed elements
                const chapterTitleElement = document.getElementById('chapterTitleDisplay');
                const hudElement = document.getElementById('hud');
                const direcionalElement = document.getElementById('direcional');
                const botaoAcaoElement = document.getElementById('botao-acao');
                const soundControlElement = document.getElementById('soundControlBtn');

                // Get actual heights of elements that take up vertical space
                const chapterTitleHeight = chapterTitleElement ? chapterTitleElement.offsetHeight : 0;
                const hudHeight = hudElement ? hudElement.offsetHeight : 0;
                const hudMarginTop = hudElement ? parseFloat(getComputedStyle(hudElement).marginTop) : 0;
                const hudMarginBottom = hudElement ? parseFloat(getComputedStyle(hudElement).marginBottom) : 0;
                
                let direcionalHeight = direcionalElement ? direcionalElement.offsetHeight : 0;
                let soundControlHeight = soundControlElement ? soundControlElement.offsetHeight : 0;

                const controlsBottomMargin = 20; // Margin from bottom of controls to viewport edge
                const controlsSpacing = 10; // Spacing between direcional and sound control

                // Calculate the total height of the bottom fixed controls area
                const bottomControlsTotalHeight = Math.max(direcionalHeight, (botaoAcaoElement ? botaoAcaoElement.offsetHeight : 0), soundControlHeight) + controlsBottomMargin + controlsSpacing;

                // Set the top and bottom CSS properties for mainGameContainer
                const mainGameContainer = document.getElementById('mainGameContainer');
                if (mainGameContainer) {
                    // Calculate the desired top for mainGameContainer based on chapterTitleHeight
                    // Add a fixed gap (e.g., 20px) between title and HUD
                    mainGameContainer.style.top = `${chapterTitleHeight + 20}px`; // 20px is the desired gap

                    // mainGameContainer ends right above bottom controls
                    mainGameContainer.style.bottom = `${bottomControlsTotalHeight}px`;
                }

                // Calculate the available height for the canvas within the mainGameContainer.
                // This is the total height of mainGameContainer minus the HUD height and its margins.
                const availableSpaceInMainContainer = mainGameContainer ? mainGameContainer.clientHeight : window.innerHeight; // Fallback
                const availableCanvasHeight = availableSpaceInMainContainer - hudHeight - hudMarginTop - hudMarginBottom;

                // User explicitly requested a square canvas (1:1 aspect ratio)
                const aspectRatio = 1; // Desired 1:1 aspect ratio (width / height)

                // Determine the maximum possible size for the square canvas
                // It should be limited by both available width and available height
                let newCanvasSize = Math.min(window.innerWidth * 0.95, availableCanvasHeight); // Start with 95vw for mobile, or available height

                // Apply max width limit for desktop
                const maxWidthLimit = 720;
                if (newCanvasSize > maxWidthLimit) {
                    newCanvasSize = maxWidthLimit;
                }
                
                // Apply the 20% reduction to the height/width of the square field
                newCanvasSize = newCanvasSize * 0.80; // Reduce by 20%

                // Set the canvas element's attributes (drawing buffer size)
                this.canvas.width = newCanvasSize;
                this.canvas.height = newCanvasSize;

                // Set the CSS dimensions to match the attributes, ensuring it fits the container
                this.canvas.style.width = `${newCanvasSize}px`;
                this.canvas.style.height = `${newCanvasSize}px`;

                console.log(`DEBUG: Canvas resized to Width: ${newCanvasSize.toFixed(2)}px, Height: ${newCanvasSize.toFixed(2)}px (1:1 aspect ratio, 20% reduced)`);

                // Reposition player
                if (this.player) {
                    this.player.x = this.canvas.width / 2 - this.PLAYER_SIZE / 2;
                    this.player.y = this.canvas.height / 2 - this.PLAYER_SIZE / 2;
                }
            },

            // Retorna o emoji do personagem selecionado
            getCharacterEmoji: function(tipo) {
                switch (tipo) {
                    case 'urso': return '🐻';
                    case 'gato': return '🐱';
                    case 'girafa': return '🦒';
                    case 'coelho': return '🐰';
                    default: return '❓';
                }
            },

            // Cria um objeto de jogo (item, obstáculo, baú, item escolar)
            createGameObject: function(type, emoji, size, canBeCollected, isObstacle, color = null, isObjective = false) {
                return {
                    type: type,
                    emoji: emoji,
                    canBeCollected: canBeCollected, // Se pode ser coletado pelo botão de ação
                    isObstacle: isObstacle,       // Se bloqueia o caminho
                    color: color,
                    isObjective: isObjective,       // Se conta para o objetivo principal
                    x: 0,  
                    y: 0,  
                    size: size,
                    width: size,  
                    height: size  
                };
            },

            // Posiciona todos os objetos no canvas de forma aleatória, evitando sobreposição inicial
            placeGameObjectsRandomly: function() {
                const padding = 20; // Espaçamento das bordas do canvas
                const minX = padding;
                const minY = padding;
                const maxX = this.canvas.width - padding;
                const maxY = this.canvas.height - padding;

                const placedObjects = []; // Para controlar a sobreposição

                // Define uma área segura no centro para o jogador (dinâmica)
                const playerSafeZoneSize = this.PLAYER_SIZE + (4 * this.OBSTACLE_SIZE); // 2x OBSTACLE_SIZE em cada lado do player
                const playerSafeZone = {
                    x: this.canvas.width / 2 - playerSafeZoneSize / 2,
                    y: this.canvas.height / 2 - playerSafeZoneSize / 2,
                    width: playerSafeZoneSize,
                    height: playerSafeZoneSize
                };

                const getRandomPosition = (objSize, isObstacle = false) => {
                    let newX, newY, collision;
                    let attempts = 0;
                    const maxAttempts = 1000; // Aumentado para mais chances de posicionamento
                    // Define a distância mínima de afastamento para objetos (3 vezes o tamanho de um obstáculo)
                    const minClearanceBetweenObjects = 3 * this.OBSTACLE_SIZE;  

                    do {
                        collision = false;
                        newX = Math.random() * (maxX - minX - objSize) + minX;
                        newY = Math.random() * (maxY - minY - objSize) + minY;

                        const newRect = { x: newX, y: newY, width: objSize, height: objSize };

                        // Verifica colisão com objetos já posicionados
                        for (const placedObj of placedObjects) {
                            // Calcula a distância mínima necessária entre os centros dos objetos
                            const requiredMinDistanceX = (newRect.width / 2) + (placedObj.width / 2) + minClearanceBetweenObjects;
                            const requiredMinDistanceY = (newRect.height / 2) + (placedObj.height / 2) + minClearanceBetweenObjects;

                            // Verifica se os objetos estão muito próximos
                            if (Math.abs(newRect.x + newRect.width / 2 - (placedObj.x + placedObj.width / 2)) < requiredMinDistanceX &&
                                Math.abs(newRect.y + newRect.height / 2 - (placedObj.y + placedObj.height / 2)) < requiredMinDistanceY) {
                                collision = true;
                                break;
                            }
                        }

                        // Se for um obstáculo ou um item coletável, verifica também colisão com a zona segura do jogador
                        if (!collision && (isObstacle || newRect.canBeCollected) && this.checkCollision(newRect, playerSafeZone)) {
                            collision = true;
                        }

                        attempts++;
                    } while (collision && attempts < maxAttempts);

                    if (attempts === maxAttempts) {
                        console.warn(`AVISO: Não foi possível encontrar uma posição livre para o objeto de tamanho ${objSize} após ${maxAttempts} tentativas. Pode haver sobreposição.`);
                    }
                    return { x: newX, y: newY, width: objSize, height: objSize };
                };

                // Posicionar obstáculos primeiro para garantir o espaçamento
                this.obstaculos.forEach(obstacle => {
                    const pos = getRandomPosition(obstacle.size, true); // Passa true para isObstacle
                    obstacle.x = pos.x;
                    obstacle.y = pos.y;
                    placedObjects.push(obstacle);
                });

                // Posicionar o baú (apenas na Fase 1)
                if (this.chest && this.currentPhase === 1) {
                    const pos = getRandomPosition(this.chest.size);
                    this.chest.x = pos.x;
                    this.chest.y = pos.y;
                    placedObjects.push(this.chest);
                }

                // Posicionar itens
                this.itens.forEach(item => {
                    const pos = getRandomPosition(item.size);
                    item.x = pos.x;
                    item.y = pos.y;
                    placedObjects.push(item);
                });

                // Posicionar itens escolares
                this.schoolItems.forEach(sItem => {
                    const pos = getRandomPosition(sItem.size);
                    sItem.x = pos.x;
                    sItem.y = pos.y;
                    placedObjects.push(sItem);
                });
            },

            // Desenha um objeto no canvas
            drawItem: function(item) {
                if (!this.ctx) return; // Adicionado null check
                // Tenta usar uma lista de fontes de emoji para melhor compatibilidade
                this.ctx.font = `${item.size}px "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(item.emoji, item.x + item.size / 2, item.y + item.size / 2);
            },

            // Desenha o personagem no canvas
            drawPlayer: function() {
                if (!this.ctx) return; // Adicionado null check
                // Tenta usar uma lista de fontes de emoji para melhor compatibilidade
                this.ctx.font = `${this.player.width}px "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(this.player.emoji, this.player.x + this.player.width / 2, this.player.y + this.player.height / 2);
            },

            // Verifica colisão entre dois retângulos (AABB)
            checkCollision: function(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            },

            // Lógica de interações (coleta de itens, colisão com obstáculos, interação com o baú)
            handleInteractions: function() {
                // Oculta qualquer dica LLM ativa ao interagir
                const hintMessageDiv = document.getElementById('llmHintMessage');
                if (hintMessageDiv) {
                    hintMessageDiv.style.display = 'none';
                }
                if (this.hintTimeout) clearTimeout(this.hintTimeout);

                // 1. Coleta de Itens (se o botão de ação estiver pressionado)
                if (this.coletando) {
                    // Percorre todos os itens para verificar coleta
                    for (let i = 0; i < this.itens.length; i++) {
                        if (this.itens[i].canBeCollected && this.checkCollision(this.player, this.itens[i])) {
                            const collectedItem = this.itens.splice(i, 1)[0];
                            this.totalAllItemsCollected++; // Incrementa a contagem total

                            if (collectedItem.isObjective) {
                                if (this.currentPhase === 1) { // Lógica de objetivo da Fase 1
                                    if (collectedItem.type === 'pedra') {
                                        this.pedrasColetadas++;
                                        console.log(`DEBUG: Pedra coletada! Total de pedras: ${this.pedrasColetadas}/${this.TOTAL_PEDRAS}`);
                                    } else if (collectedItem.type === 'chave') {
                                        this.keysColetadas++; // Incrementa o contador de chaves
                                        console.log(`DEBUG: Chave coletada! Total de chaves: ${this.keysColetadas}/${this.TOTAL_CHAVES}`); // Log para a nova lógica de chaves
                                    }
                                } else if (this.currentPhase === 2) { // Lógica de objetivo da Fase 2
                                    if (collectedItem.type === 'vale_sorvete') {
                                        this.valesSorveteColetados++;
                                        console.log(`DEBUG: Vale Sorvete coletado! Total de vales: ${this.valesSorveteColetados}/${this.TOTAL_VALES_SORVETE}`);
                                    } else if (collectedItem.type === 'sorvete' && collectedItem.isObjective) { // Sorvetes objetivo na Fase 2
                                        this.sorvetesObjetivoColetados++;
                                        console.log(`DEBUG: Sorvete coletado! Total de sorvetes: ${this.sorvetesObjetivoColetados}/${this.TOTAL_SORVETES_OBJETIVO}`);
                                    }
                                } else if (this.currentPhase === 3) { // Lógica de objetivo da Fase 3
                                    if (collectedItem.type === 'trofeu') {
                                        this.trofeusColetados++;
                                        console.log(`DEBUG: Troféu coletado! Total de troféus: ${this.trofeusColetados}/${this.TOTAL_TROFEUS}`);
                                    } else if (collectedItem.type === 'bola' && collectedItem.isObjective) { // Bolas objetivo na Fase 3
                                        this.bolasColetadas++;
                                        console.log(`DEBUG: Bola coletada! Total de bolas: ${this.bolasColetadas}/${this.TOTAL_BOLAS_FASE3}`);
                                    } else if (collectedItem.type === 'pipa') { // Novo objetivo
                                        this.pipasColetadas++;
                                        console.log(`DEBUG: Pipa coletada! Total: ${this.pipasColetadas}/${this.TOTAL_PIPAS}`);
                                    }
                                } else if (this.currentPhase === 4) { // Lógica de objetivo da Fase 4
                                    if (collectedItem.type === 'tubo_ensaio') {
                                        this.tubosEnsaioColetados++;
                                        console.log(`DEBUG: Tubo de Ensaio coletado! Total: ${this.tubosEnsaioColetados}/${this.TOTAL_TUBOS_ENSAIO}`);
                                    } else if (collectedItem.type === 'ima') {
                                        this.imasColetados++;
                                        console.log(`DEBUG: Ímã coletado! Total: ${this.imasColetados}/${this.TOTAL_IMAS}`);
                                    } else if (collectedItem.type === 'microscopio') { // Novo objetivo
                                        this.microscopioColetados++;
                                        console.log(`DEBUG: Microscópio coletado! Total: ${this.microscopioColetados}/${this.TOTAL_MICROSCOPIO}`);
                                    }
                                } else if (this.currentPhase === 5) {
                                    // Itens do objetivo principal da Fase 5: 3 Elefantes, 3 Leões, 3 Aves
                                    if (collectedItem.type === 'elefante') {
                                        this.elefantesColetados++;
                                        console.log(`DEBUG: Elefante coletado! Total: ${this.elefantesColetados}/${this.TOTAL_ELEFANTES}`);
                                    } else if (collectedItem.type === 'leao') {
                                        this.leoesColetados++;
                                        console.log(`DEBUG: Leão coletado! Total: ${this.leoesColetados}/${this.TOTAL_LEOES}`);
                                    } else if (collectedItem.type === 'ave') {
                                        this.avesColetadas++;
                                        console.log(`DEBUG: Ave coletada! Total: ${this.avesColetadas}/${this.TOTAL_AVES}`);
                                    }
                                } else if (this.currentPhase === 6) {
                                    // Itens do objetivo principal da Fase 6: 3 Pinturas, 3 Esculturas, 3 Fósseis
                                    if (collectedItem.type === 'pintura') {
                                        this.pinturasColetadas++;
                                        console.log(`DEBUG: Pintura coletada! Total: ${this.pinturasColetadas}/${this.TOTAL_PINTURAS}`);
                                    } else if (collectedItem.type === 'escultura') {
                                        this.esculturasColetadas++;
                                        console.log(`DEBUG: Escultura coletada! Total: ${this.esculturasColetadas}/${this.TOTAL_ESCULTURAS}`);
                                    } else if (collectedItem.type === 'fossil') {
                                        this.fosseisColetados++;
                                        console.log(`DEBUG: Fóssil coletado! Total: ${this.fosseisColetados}/${this.TOTAL_FOSSEIS}`);
                                    }
                                } else if (this.currentPhase === 7) {
                                    // Itens do objetivo principal da Fase 7: 3 Cestas de Piquenique, 3 Bolas, 3 Brinquedos de Parque
                                    if (collectedItem.type === 'cesta_piquenique') {
                                        this.cestasPiqueniqueColetadas++;
                                        console.log(`DEBUG: Cesta de Piquenique coletada! Total: ${this.cestasPiqueniqueColetadas}/${this.TOTAL_CESTAS_PIQUENIQUE}`);
                                    } else if (collectedItem.type === 'bola' && collectedItem.isObjective) {
                                        this.bolasFase7Coletadas++;
                                        console.log(`DEBUG: Bola (Fase 7) coletada! Total: ${this.bolasFase7Coletadas}/${this.TOTAL_BOLAS_FASE7}`);
                                    } else if (collectedItem.type === 'brinquedo_parque') {
                                        this.brinquedosParqueColetados++;
                                        console.log(`DEBUG: Brinquedo de Parque coletado! Total: ${this.brinquedosParqueColetados}/${this.TOTAL_BRINQUEDOS_PARQUE}`);
                                    }
                                } else if (this.currentPhase === 8) { // Capítulo 8: Leiturinhas
                                    if (collectedItem.type === 'livro_aventura') {
                                        this.livroAventuraColetados++;
                                        console.log(`DEBUG: Livro de Aventura coletado! Total: ${this.livroAventuraColetados}/${this.TOTAL_LIVRO_AVENTURA}`);
                                    } else if (collectedItem.type === 'livro_animais') {
                                        this.livroAnimaisColetados++;
                                        console.log(`DEBUG: Livro de Animais coletado! Total: ${this.livroAnimaisColetados}/${this.TOTAL_LIVRO_ANIMAIS}`);
                                    } else if (collectedItem.type === 'livro_fabula') {
                                        this.livroFabulaColetados++;
                                        console.log(`DEBUG: Livro de Fábula coletado! Total: ${this.livroFabulaColetados}/${this.TOTAL_LIVRO_FABULA}`);
                                    }
                                } else if (this.currentPhase === 9) {
                                    if (collectedItem.type === 'lixeira_reciclagem') {
                                        this.lixeiraReciclagemColetados++;
                                        console.log(`DEBUG: Lixeira de Reciclagem coletada! Total: ${this.lixeiraReciclagemColetados}/${this.TOTAL_LIXEIRA_RECICLAGEM}`);
                                    } else if (collectedItem.type === 'garrafa_plastico') {
                                        this.garrafaPlasticoColetados++;
                                        console.log(`DEBUG: Garrafa Plástica coletada! Total: ${this.garrafaPlasticoColetados}/${this.TOTAL_GARRAFA_PLASTICO}`);
                                    } else if (collectedItem.type === 'arvore_muda') {
                                        this.arvoreMudaColetados++;
                                        console.log(`DEBUG: Muda de Árvore coletada! Total: ${this.arvoreMudaColetados}/${this.TOTAL_ARVORE_MUDA}`);
                                    }
                                } else if (this.currentPhase === 10) {
                                    if (collectedItem.type === 'planta_nativa') {
                                        this.plantaNativaColetados++;
                                        console.log(`DEBUG: Planta Nativa coletada! Total: ${this.plantaNativaColetados}/${this.TOTAL_PLANTAS_NATIVAS}`);
                                    } else if (collectedItem.type === 'animal_selvagem') {
                                        this.animalSelvagemColetados++;
                                        console.log(`DEBUG: Animal Selvagem coletado! Total: ${this.animalSelvagemColetados}/${this.TOTAL_ANIMAIS_SELVAGENS}`);
                                    } else if (collectedItem.type === 'telescopio') {
                                        this.telescopioColetados++;
                                        console.log(`DEBUG: Telescópio coletado! Total: ${this.telescopioColetados}/${this.TOTAL_TELESCOPIO}`);
                                    }
                                } else if (this.currentPhase === 11) {
                                    if (collectedItem.type === 'pincel') {
                                        this.pincelColetados++;
                                        console.log(`DEBUG: Pincel coletado! Total: ${this.pincelColetados}/${this.TOTAL_PINCEL}`);
                                    } else if (collectedItem.type === 'tinta') {
                                        this.tintaColetados++;
                                        console.log(`DEBUG: Tinta coletada! Total: ${this.tintaColetados}/${this.TOTAL_TINTA}`);
                                    } else if (collectedItem.type === 'argila') {
                                        this.argilaColetados++;
                                        console.log(`DEBUG: Argila coletada! Total: ${this.argilaColetados}/${this.TOTAL_ARGILA}`);
                                    }
                                } else if (this.currentPhase === 12) {
                                    if (collectedItem.type === 'violao') {
                                        this.violaoColetados++;
                                        console.log(`DEBUG: Violão coletado! Total: ${this.violaoColetados}/${this.TOTAL_VIOLAO}`);
                                    } else if (collectedItem.type === 'piano') {
                                        this.pianoColetados++;
                                        console.log(`DEBUG: Piano coletado! Total: ${this.pianoColetados}/${this.TOTAL_PIANO}`);
                                    } else if (collectedItem.type === 'microfone') {
                                        this.microfoneColetados++;
                                        console.log(`DEBUG: Microfone coletado! Total: ${this.microfoneColetados}/${this.TOTAL_MICROFONE}`);
                                    }
                                }
                            } else if (collectedItem.type === 'moeda') {
                                this.tempo += 5;
                                console.log(`DEBUG: Moeda coletada! Tempo +5s. Tempo atual: ${this.tempo}`);
                            }
                            this.atualizarHUD();
                            this.coletando = false;
                            return;
                        }
                    }

                    // Depois verifica itens escolares não coletáveis (se houver)
                    for (let i = 0; i < this.schoolItems.length; i++) {
                        if (this.schoolItems[i].canBeCollected && this.checkCollision(this.player, this.schoolItems[i])) {
                            const collectedItem = this.schoolItems.splice(i, 1)[0];
                            this.totalAllItemsCollected++; // Incrementa a contagem total
                            this.atualizarHUD();
                            this.coletando = false;
                            return;
                        }
                    }

                    // 2. Interação com o Baú (apenas na Fase 1)
                    if (this.currentPhase === 1 && this.chest && this.checkCollision(this.player, this.chest)) { // Only check collision if chest exists
                        if (this.pedrasColetadas === this.TOTAL_PEDRAS && this.keysColetadas === this.TOTAL_CHAVES) { // Updated condition
                            this.chest.isOpened = true; // Marca o baú como aberto
                            this.chest.emoji = '🗃️'; // Muda o emoji do baú para aberto
                            console.log("DEBUG: Baú aberto com sucesso!");
                            this.coletando = false;
                            this.atualizarHUD(); // Atualiza o HUD para mostrar o baú aberto
                            // A transição de fase é tratada no setInterval principal, que agora verifica chest.isOpened
                            return;
                        } else { // If trying to open but not all collected
                            const hintMessageDiv = document.getElementById('llmHintMessage');
                            let msg = "Você precisa coletar todos os itens do objetivo antes de abrir o baú!";
                            if (this.pedrasColetadas < this.TOTAL_PEDRAS) {
                                msg += ` Faltam ${this.TOTAL_PEDRAS - this.pedrasColetadas} pedras.`;
                            }
                            if (this.keysColetadas < this.TOTAL_CHAVES) {
                                msg += ` Faltam ${this.TOTAL_CHAVES - this.keysColetadas} chaves.`;
                            }
                            if (hintMessageDiv) { // Check if element exists before setting innerText
                               hintMessageDiv.innerText = msg;
                               hintMessageDiv.style.display = 'block';
                            }
                            if (this.hintTimeout) clearTimeout(this.hintTimeout);
                            this.hintTimeout = setTimeout(() => {
                                if (hintMessageDiv) { // Check again before hiding
                                    hintMessageDiv.style.display = 'none';
                                }
                            }, 5000);
                            this.coletando = false;
                        }
                    }
                }
            },

            // Método para atualizar a exibição do HUD
            atualizarHUD: function() {
                // Obtenha as referências dos elementos do HUD aqui para garantir que são válidas
                const currentVidasDisplayElement = document.getElementById('vidasDisplay');
                const currentHudObjectiveLine1Element = document.getElementById('hudObjectiveLine1');
                const currentHudObjectiveLine2Element = document.getElementById('hudObjectiveLine2');
                const currentTotalAllItemsCollectedDisplayElement = document.getElementById('totalAllItemsCollectedDisplay');
                const currentTempoDisplayElement = document.getElementById('tempo');

                let coracao = "❤️".repeat(this.vidas); // Exibe corações com base nas vidas
                let objectiveLine1Content = ''; // Conteúdo para a linha 1 do objetivo
                let objectiveLine2Content = ''; // Conteúdo para a linha 2 do objetivo - Inicializado aqui

                let hudTotalCollectedContent = `Total Coletado: ${this.totalAllItemsCollected}`;
                let hudTempoContent = `Tempo: ${this.tempo}s`;

                // Conteúdo do HUD principal (canto superior esquerdo)
                if (this.currentPhase === 1) {
                    objectiveLine1Content = `🔴 Pedras: ${this.pedrasColetadas} / ${this.TOTAL_PEDRAS}`;
                    objectiveLine2Content = `🔑 Chaves: ${this.keysColetadas} / ${this.TOTAL_CHAVES}<br>📦 Baú: ${this.chest && this.chest.isOpened ? '1/1 🔓' : '0/1 🔒'}`;
                } else if (this.currentPhase === 2) {
                    objectiveLine1Content = `🎟️ Vales Sorvete: ${this.valesSorveteColetados} / ${this.TOTAL_VALES_SORVETE}`;
                    objectiveLine2Content = `🍫🍦 Sorvetes: ${this.sorvetesObjetivoColetados} / ${this.TOTAL_SORVETES_OBJETIVO}`;
                } else if (this.currentPhase === 3) {
                    objectiveLine1Content = `🏆 Troféus: ${this.trofeusColetados} / ${this.TOTAL_TROFEUS}`;
                    objectiveLine2Content = `⚽ Bolas: ${this.bolasColetadas} / ${this.TOTAL_BOLAS_FASE3}<br>🪁 Pipas: ${this.pipasColetadas} / ${this.TOTAL_PIPAS}`;
                } else if (this.currentPhase === 4) {
                    objectiveLine1Content = `🧪 Tubos Ensaio: ${this.tubosEnsaioColetados} / ${this.TOTAL_TUBOS_ENSAIO}`;
                    objectiveLine2Content = `🧲 Ímãs: ${this.imasColetados} / ${this.TOTAL_IMAS}<br>🔬 Microscópios: ${this.microscopioColetados} / ${this.TOTAL_MICROSCOPIO}`;
                } else if (this.currentPhase === 5) {
                    objectiveLine1Content = `🐘 Elefantes: ${this.elefantesColetados} / ${this.TOTAL_ELEFANTES}`;
                    objectiveLine2Content = `🦁 Leões: ${this.leoesColetados} / ${this.TOTAL_LEOES}<br>🦜 Aves: ${this.avesColetadas} / ${this.TOTAL_AVES}`;
                } else if (this.currentPhase === 6) {
                    objectiveLine1Content = `🎨 Pinturas: ${this.pinturasColetadas} / ${this.TOTAL_PINTURAS}`;
                    objectiveLine2Content = `🗿 Esculturas: ${this.esculturasColetadas} / ${this.TOTAL_ESCULTURAS}<br>🦴 Fósseis: ${this.fosseisColetados} / ${this.TOTAL_FOSSEIS}`;
                } else if (this.currentPhase === 7) {
                    objectiveLine1Content = `🧺 Cestas Piquenique: ${this.cestasPiqueniqueColetadas} / ${this.TOTAL_CESTAS_PIQUENIQUE}`;
                    objectiveLine2Content = `⚽ Bolas: ${this.bolasFase7Coletadas} / ${this.TOTAL_BOLAS_FASE7}<br>🎠 Brinquedos: ${this.brinquedosParqueColetados} / ${this.TOTAL_BRINQUEDOS_PARQUE}`;
                } else if (this.currentPhase === 8) {
                    objectiveLine1Content = `📖 Aventura: ${this.livroAventuraColetados} / ${this.TOTAL_LIVRO_AVENTURA}`;
                    objectiveLine2Content = `🦁 Animais: ${this.livroAnimaisColetados} / ${this.TOTAL_LIVRO_ANIMAIS}<br>📜 Fábula: ${this.livroFabulaColetados} / ${this.TOTAL_LIVRO_FABULA}`;
                } else if (this.currentPhase === 9) {
                    objectiveLine1Content = `♻️ Reciclagem: ${this.lixeiraReciclagemColetados} / ${this.TOTAL_LIXEIRA_RECICLAGEM}`;
                    objectiveLine2Content = `🧴 Plástico: ${this.garrafaPlasticoColetados} / ${this.TOTAL_GARRAFA_PLASTICO}<br>🌱 Árvore: ${this.arvoreMudaColetados} / ${this.TOTAL_ARVORE_MUDA}`;
                } else if (this.currentPhase === 10) {
                    objectiveLine1Content = `🌿 Plantas: ${this.plantaNativaColetados} / ${this.TOTAL_PLANTAS_NATIVAS}`;
                    objectiveLine2Content = `🦁 Animais: ${this.animalSelvagemColetados} / ${this.TOTAL_ANIMAIS_SELVAGENS}<br>🔭 Telescópios: ${this.telescopioColetados} / ${this.TOTAL_TELESCOPIO}`;
                } else if (this.currentPhase === 11) {
                    objectiveLine1Content = `🖌️ Pincéis: ${this.pincelColetados} / ${this.TOTAL_PINCEL}`;
                    objectiveLine2Content = `🎨 Tintas: ${this.tintaColetados} / ${this.TOTAL_TINTA}<br>🏺 Argila: ${this.argilaColetados} / ${this.TOTAL_ARGILA}`;
                } else if (this.currentPhase === 12) {
                    objectiveLine1Content = `🎸 Violão: ${this.violaoColetados} / ${this.TOTAL_VIOLAO}`;
                    objectiveLine2Content = `🎹 Piano: ${this.pianoColetados} / ${this.TOTAL_PIANO}<br>🎤 Microfone: ${this.microfoneColetados} / ${this.TOTAL_MICROFONE}`;
                }

                // Atualiza o texto dos elementos do HUD
                if (currentVidasDisplayElement) currentVidasDisplayElement.innerText = `Vidas: ${coracao}`; // Adiciona o rótulo "Vidas:"
                if (currentTotalAllItemsCollectedDisplayElement) currentTotalAllItemsCollectedDisplayElement.innerText = `Total Coletado: ${this.totalAllItemsCollected}`;
                if (currentTempoDisplayElement) currentTempoDisplayElement.innerText = `Tempo: ${this.tempo}s`; // Adiciona o rótulo "Tempo:"

                if (currentHudObjectiveLine1Element) currentHudObjectiveLine1Element.innerHTML = objectiveLine1Content;
                if (currentHudObjectiveLine2Element) currentHudObjectiveLine2Element.innerHTML = objectiveLine2Content;
            },

            // Função para selecionar o personagem e iniciar o jogo
            selecionar: function(tipo) {
                const personagemSelecaoElement = document.getElementById('personagemSelecao');
                if (personagemSelecaoElement) {
                    personagemSelecaoElement.style.display = 'none'; // Esconde a tela de seleção
                }
                this.currentPlayerType = tipo; // Armazena o tipo de personagem
                console.log("Personagem selecionado:", tipo);
                this.iniciar(tipo, 1); // Inicia o jogo na Fase 1
            },

            // Inicializa o canvas 2D e os elementos do jogo
            iniciar: function(tipo, phase) {
                console.log(`Iniciando o jogo 2D com personagem: ${tipo}, Fase: ${phase}`);
                this.currentPhase = phase; // Atualiza a fase atual

                // Atualiza o título da página com o nome do capítulo
                this.updatePageTitle(this.currentPhase);

                // Garante que os modais estejam ocultos ao iniciar um novo jogo
                const gameModalElement = document.getElementById('gameModal');
                if (gameModalElement) gameModalElement.style.display = 'none';
                
                const llmHintMessageElement = document.getElementById('llmHintMessage');
                if (llmHintMessageElement) llmHintMessageElement.style.display = 'none';

                const continueModalElement = document.getElementById('continueModal');
                if (continueModalElement) continueModalElement.style.display = 'none';

                const temporaryMessageElement = document.getElementById('temporaryMessage');
                if (temporaryMessageElement) temporaryMessageElement.style.display = 'none';


                // Torna o HUD visível ao iniciar a fase
                const hudElementDiv = document.getElementById('hud');
                if (hudElementDiv) {
                    hudElementDiv.style.display = 'flex'; // Changed to flex
                }

                // Se for um "continue", reinicia vidas para 3. Se for reinício de fase por tempo, apenas reinicia o tempo e itens.
                if (this.continueCountdownInterval) { // Se veio do continue screen
                    clearInterval(this.continueCountdownInterval);
                    this.continueCountdownInterval = null;
                    this.continueTime = 10; // Reseta o contador para a próxima vez
                } else if (this.vidas === 0) { // Se vidas chegou a 0 e não é um continue, então é um game over completo
                    this.vidas = 3; // Reinicia vidas se for um novo jogo após game over
                }
                // Se vidas > 0 (reinício de fase por tempo), vidas não é resetada aqui

                // Reinicia as variáveis de fase
                this.pedrasColetadas = 0;
                this.keysColetadas = 0;
                this.valesSorveteColetados = 0; 
                this.sorvetesObjetivoColetados = 0;
                this.trofeusColetados = 0; 
                this.bolasColetadas = 0; 
                this.pipasColetadas = 0;
                this.tubosEnsaioColetados = 0; 
                this.imasColetados = 0; 
                this.microscopioColetados = 0;
                this.elefantesColetados = 0; 
                this.leoesColetados = 0; 
                this.avesColetadas = 0; 
                this.pinturasColetadas = 0; 
                this.esculturasColetadas = 0; 
                this.fosseisColetados = 0; 
                this.cestasPiqueniqueColetadas = 0; 
                this.bolasFase7Coletadas = 0; 
                this.brinquedosParqueColetados = 0; 
                this.totalAllItemsCollected = 0; // Reinicia a contagem total de itens coletados
                this.livroAventuraColetados = 0;
                this.livroAnimaisColetados = 0;
                this.livroFabulaColetados = 0;
                this.lixeiraReciclagemColetados = 0;
                this.garrafaPlasticoColetados = 0;
                this.arvoreMudaColetados = 0;
                this.plantaNativaColetados = 0;
                this.animalSelvagemColetados = 0;
                this.telescopioColetados = 0;
                this.pincelColetados = 0;
                this.tintaColetados = 0;
                this.argilaColetados = 0;
                this.violaoColetados = 0;
                this.pianoColetados = 0;
                this.microfoneColetados = 0;

                this.tempo = this.BASE_TIME - (this.currentLevel - 1) * this.TIME_DECREMENT_PER_LEVEL; // Tempo baseado no nível
                if (this.tempo < 30) this.tempo = 30; // Garante um tempo mínimo
                this.coletando = false;
                this.hasKey = false;
                
                // Configura o personagem do jogador (posição inicial)
                this.player = {
                    x: this.canvas.width / 2 - this.PLAYER_SIZE / 2,
                    y: this.canvas.height / 2 - this.PLAYER_SIZE / 2,
                    width: this.PLAYER_SIZE,
                    height: this.PLAYER_SIZE,
                    emoji: this.getCharacterEmoji(tipo)
                };

                this.itens = [];
                this.obstaculos = [];
                this.schoolItems = [];
                this.chest = null;

                // Gera os obstáculos temáticos da escola (comum para todas as fases)
                for (let i = 0; i < 3; i++) {
                    this.obstaculos.push(this.createGameObject('mesa', '🟫', this.OBSTACLE_SIZE, false, true));
                    this.obstaculos.push(this.createGameObject('cadeira', '🪑', this.OBSTACLE_SIZE, false, true));
                    this.obstaculos.push(this.createGameObject('armario', '🚪', this.OBSTACLE_SIZE, false, true));
                }

                // Gera os itens escolares (não coletáveis, não obstáculos - comum para todas as fases)
                for (let i = 0; i < 5; i++) { 
                    this.schoolItems.push(this.createGameObject('lapis', '✏️', this.SCHOOL_ITEM_SIZE, true, false, null, false)); 
                    this.schoolItems.push(this.createGameObject('caderno', '📓', this.SCHOOL_ITEM_SIZE, true, false, null, false)); 
                    this.schoolItems.push(this.createGameObject('livro', '📚', this.SCHOOL_ITEM_SIZE, false, false)); 
                    this.schoolItems.push(this.createGameObject('borracha', '🧽', this.SCHOOL_ITEM_SIZE, false, false)); 
                    this.schoolItems.push(this.createGameObject('mochila', '🎒', this.SCHOOL_ITEM_SIZE, false, false)); 
                }

                // Posiciona todos os objetos no canvas de forma aleatória, evitando sobreposição inicial
                this.placeGameObjectsRandomly();

                this.atualizarHUD(); // Atualiza o HUD com o novo total e objetivo

                // Limpa qualquer temporizador anterior e inicia o novo
                if (this.gameInterval) clearInterval(this.gameInterval);
                this.gameInterval = setInterval(() => {
                    let winConditionMet = false;
                    if (this.currentPhase === 1) {
                        winConditionMet = (this.chest && this.chest.isOpened);
                    } else if (this.currentPhase === 2) {
                        winConditionMet = (this.valesSorveteColetados === this.TOTAL_VALES_SORVETE && this.sorvetesObjetivoColetados === this.TOTAL_SORVETES_OBJETIVO);
                    } else if (this.currentPhase === 3) {
                        winConditionMet = (this.trofeusColetados >= this.TOTAL_TROFEUS && this.bolasColetadas >= this.TOTAL_BOLAS_FASE3 && this.pipasColetadas >= this.TOTAL_PIPAS);
                    } else if (this.currentPhase === 4) {
                        winConditionMet = (this.tubosEnsaioColetados >= this.TOTAL_TUBOS_ENSAIO && this.imasColetados >= this.TOTAL_IMAS && this.microscopioColetados >= this.TOTAL_MICROSCOPIO);
                    } else if (this.currentPhase === 5) {
                        winConditionMet = (this.elefantesColetados >= this.TOTAL_ELEFANTES && this.leoesColetados >= this.TOTAL_LEOES && this.avesColetadas >= this.TOTAL_AVES);
                    } else if (this.currentPhase === 6) {
                        winConditionMet = (this.pinturasColetadas === this.TOTAL_PINTURAS && this.esculturasColetadas === this.TOTAL_ESCULTURAS && this.fosseisColetados >= this.TOTAL_FOSSEIS);
                    } else if (this.currentPhase === 7) {
                        winConditionMet = (this.cestasPiqueniqueColetadas >= this.TOTAL_CESTAS_PIQUENIQUE && this.bolasFase7Coletadas >= this.TOTAL_BOLAS_FASE7 && this.brinquedosParqueColetados >= this.TOTAL_BRINQUEDOS_PARQUE);
                    } else if (this.currentPhase === 8) {
                        winConditionMet = (this.livroAventuraColetados >= this.TOTAL_LIVRO_AVENTURA && this.livroAnimaisColetados >= this.TOTAL_LIVRO_ANIMAIS && this.livroFabulaColetados >= this.TOTAL_LIVRO_FABULA);
                    } else if (this.currentPhase === 9) {
                        winConditionMet = (this.lixeiraReciclagemColetados >= this.TOTAL_LIXEIRA_RECICLAGEM && this.garrafaPlasticoColetados >= this.TOTAL_GARRAFA_PLASTICO && this.arvoreMudaColetados >= this.TOTAL_ARVORE_MUDA);
                    } else if (this.currentPhase === 10) {
                        winConditionMet = (this.plantaNativaColetados >= this.TOTAL_PLANTAS_NATIVAS && this.animalSelvagemColetados >= this.TOTAL_ANIMAIS_SELVAGENS && this.telescopioColetados >= this.TOTAL_TELESCOPIO);
                    } else if (this.currentPhase === 11) {
                        winConditionMet = (this.pincelColetados >= this.TOTAL_PINCEL && this.tintaColetados >= this.TOTAL_TINTA && this.argilaColetados >= this.TOTAL_ARGILA);
                    } else if (this.currentPhase === 12) {
                        winConditionMet = (this.violaoColetados >= this.TOTAL_VIOLAO && this.pianoColetados >= this.TOTAL_PIANO && this.microfoneColetados >= this.TOTAL_MICROFONE);
                    }

                    if (this.tempo > 0 && this.vidas > 0 && !winConditionMet) {
                        this.tempo--; // DECREMENTO DE TEMPO
                        const currentTempoElement = document.getElementById('tempo');
                        if (currentTempoElement) {
                            currentTempoElement.innerText = `Tempo: ${this.tempo}s`; // Atualiza o texto do tempo
                        } else {
                            console.error("Erro: Elemento 'tempo' não encontrado no DOM (dentro do setInterval).");
                        }
                        
                        if (this.tempo === 0) {
                            clearInterval(this.gameInterval); // Para o jogo enquanto a mensagem é exibida
                            this.showTemporaryMessage("Perdeu!", 3000); // Exibe "Perdeu!" por 3 segundos
                            
                            setTimeout(() => { // Após a mensagem temporária
                                this.vidas--; // Consome uma vida
                                this.atualizarHUD(); // Atualiza o HUD para mostrar a vida perdida

                                if (this.vidas > 0) {
                                    this.iniciar(this.currentPlayerType, this.currentPhase); // Reinicia a fase atual
                                } else {
                                    this.showContinueScreen();
                                }
                            }, 3000); // Espera a duração da mensagem temporária
                        }
                    } else if (winConditionMet) {
                        clearInterval(this.gameInterval); // Para o jogo
                        if (this.currentPhase < 12) { // Se ainda não é a última fase
                            this.showTemporaryMessage(`Capítulo ${this.currentPhase} Concluído!`, 2000);
                            setTimeout(() => {
                                this.currentLevel++; // Aumenta o nível para a próxima fase
                                this.iniciar(this.currentPlayerType, this.currentPhase + 1); // Inicia a próxima fase
                            }, 2000);
                        } else {
                            this.encerrar("✅ Parabéns! Você completou todos os capítulos!"); // Vitória final após o Capítulo 12
                        }
                    } else if (this.vidas <= 0) {
                        clearInterval(this.gameInterval); // Para o jogo
                        this.showContinueScreen();
                    }
                }, 1000);

                // Inicia o loop principal de animação
                this.lastFrameTime = performance.now();
                this.animar();
                if (this.canvas) { // Garante que o canvas tenha foco ao iniciar o jogo
                    this.canvas.focus();
                }
            },

            encerrar: function(msg) {
                console.log("DEBUG: Encerrar chamado com mensagem:", msg); // Log de depuração
                clearInterval(this.gameInterval); // Para o temporador do jogo
                const llmHintMessageElement = document.getElementById('llmHintMessage'); // Get reference here
                if (llmHintMessageElement) llmHintMessageElement.style.display = 'none'; // Oculta a mensagem de dica LLM
                if (this.hintTimeout) clearTimeout(this.hintTimeout); // Limpa qualquer timeout de dica

                const modal = document.getElementById('gameModal');
                if (modal) { // Added null check
                    document.getElementById('modalMessage').innerText = msg;
                    modal.style.display = 'flex'; // Mostra o modal
                }
                this.stopAllMusic(); // Parar música ao encerrar o jogo
            },

            showTemporaryMessage: function(msg, duration) {
                const tempMessageDiv = document.getElementById('temporaryMessage');
                if (tempMessageDiv) {
                    tempMessageDiv.innerText = msg;
                    tempMessageDiv.style.display = 'block';
                    setTimeout(() => {
                        tempMessageDiv.style.display = 'none';
                    }, duration);
                }
            },

            showContinueScreen: function() {
                const continueModalElement = document.getElementById('continueModal');
                if (continueModalElement) { // Added null check
                    continueModalElement.style.display = 'flex';
                }
                this.continueTime = 10;
                const continueCountdownElement = document.getElementById('continueCountdown');
                if (continueCountdownElement) { // Added null check
                    continueCountdownElement.innerText = this.continueTime;
                }


                if (this.continueCountdownInterval) clearInterval(this.continueCountdownInterval);
                this.continueCountdownInterval = setInterval(() => {
                    this.continueTime--;
                    if (continueCountdownElement) { // Added null check
                        continueCountdownElement.innerText = this.continueTime;
                    }
                    if (this.continueTime <= 0) {
                        clearInterval(this.continueCountdownInterval);
                        this.handleContinue('nao');
                    }
                }, 1000);
                this.stopAllMusic(); // Parar música na tela de continue
            },

            handleContinue: function(choice) {
                clearInterval(this.continueCountdownInterval);
                const continueModalElement = document.getElementById('continueModal');
                if (continueModalElement) { // Added null check
                    continueModalElement.style.display = 'none';
                }

                if (choice === 'sim') {
                    console.log("DEBUG: Jogador escolheu SIM. Reiniciando para seleção de personagem.");
                    this.vidas = 3;
                    const personagemSelecaoElement = document.getElementById('personagemSelecao');
                    if (personagemSelecaoElement) { // Added null check
                        personagemSelecaoElement.style.display = 'flex';
                    }
                    if (this.ctx && this.canvas) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); // Added canvas null check
                    this.pedrasColetadas = 0;
                    this.keysColetadas = 0;
                    this.valesSorveteColetados = 0;
                    this.sorvetesObjetivoColetados = 0;
                    this.trofeusColetados = 0;
                    this.bolasColetadas = 0;
                    this.pipasColetadas = 0;
                    this.tubosEnsaioColetados = 0;
                    this.imasColetados = 0;
                    this.microscopioColetados = 0;
                    this.elefantesColetados = 0;
                    this.leoesColetados = 0;
                    this.avesColetadas = 0;
                    this.pinturasColetadas = 0;
                    this.esculturasColetadas = 0;
                    this.fosseisColetados = 0;
                    this.cestasPiqueniqueColetadas = 0;
                    this.bolasFase7Coletadas = 0;
                    this.brinquedosParqueColetados = 0;
                    this.totalAllItemsCollected = 0;
                    this.livroAventuraColetados = 0;
                    this.livroAnimaisColetados = 0;
                    this.livroFabulaColetados = 0;
                    this.lixeiraReciclagemColetados = 0;
                    this.garrafaPlasticoColetados = 0;
                    this.arvoreMudaColetados = 0;
                    this.plantaNativaColetados = 0;
                    this.animalSelvagemColetados = 0;
                    this.telescopioColetados = 0;
                    this.pincelColetados = 0;
                    this.tintaColetados = 0;
                    this.argilaColetados = 0;
                    this.violaoColetados = 0;
                    this.pianoColetados = 0;
                    this.microfoneColetados = 0;
                    this.tempo = this.BASE_TIME; // Reset time to base for new game
                    this.coletando = false;
                    this.hasKey = false;
                    this.itens = [];
                    this.obstaculos = [];
                    this.schoolItems = [];
                    this.chest = null; // Reset chest for new game
                    this.currentPhase = 1; // Reseta para a Fase 1
                    this.currentLevel = 1; // Reseta o nível para 1
                    // Go back to intro screen for a full restart
                    const introScreenElement = document.getElementById('introScreen');
                    if (introScreenElement) { // Added null check
                        introScreenElement.style.display = 'flex';
                    }
                    if (personagemSelecaoElement) { // Added null check
                        personagemSelecaoElement.style.display = 'none';
                    }
                    const hudElement = document.getElementById('hud');
                    if (hudElement) { // Added null check
                        hudElement.style.display = 'none';
                    }
                } else {
                    console.log("DEBUG: Jogador escolheu NÃO ou tempo esgotou. Recarrega a página.");
                    location.reload();
                }
            },

            animar: function(currentTime) {
                requestAnimationFrame(this.animar.bind(this)); // Bind 'this' for recursive call

                if (currentTime < this.lastFrameTime + this.frameInterval) {
                    return;
                }
                this.lastFrameTime = currentTime;

                let winConditionMet = false;
                if (this.currentPhase === 1) {
                    winConditionMet = (this.chest && this.chest.isOpened);
                } else if (this.currentPhase === 2) {
                    winConditionMet = (this.valesSorveteColetados === this.TOTAL_VALES_SORVETE && this.sorvetesObjetivoColetados === this.TOTAL_SORVETES_OBJETIVO);
                } else if (this.currentPhase === 3) {
                    winConditionMet = (this.trofeusColetados >= this.TOTAL_TROFEUS && this.bolasColetadas >= this.TOTAL_BOLAS_FASE3 && this.pipasColetadas >= this.TOTAL_PIPAS);
                } else if (this.currentPhase === 4) {
                    winConditionMet = (this.tubosEnsaioColetados >= this.TOTAL_TUBOS_ENSAIO && this.imasColetados >= this.TOTAL_IMAS && this.microscopioColetados >= this.TOTAL_MICROSCOPIO);
                } else if (this.currentPhase === 5) {
                    winConditionMet = (this.elefantesColetados >= this.TOTAL_ELEFANTES && this.leoesColetados >= this.TOTAL_LEOES && this.avesColetadas >= this.TOTAL_AVES);
                } else if (this.currentPhase === 6) {
                    winConditionMet = (this.pinturasColetadas === this.TOTAL_PINTURAS && this.esculturasColetadas === this.TOTAL_ESCULTURAS && this.fosseisColetados >= this.TOTAL_FOSSEIS);
                } else if (this.currentPhase === 7) {
                    winConditionMet = (this.cestasPiqueniqueColetadas >= this.TOTAL_CESTAS_PIQUENIQUE && this.bolasFase7Coletadas >= this.TOTAL_BOLAS_FASE7 && this.brinquedosParqueColetados >= this.TOTAL_BRINQUEDOS_PARQUE);
                } else if (this.currentPhase === 8) {
                    winConditionMet = (this.livroAventuraColetados >= this.TOTAL_LIVRO_AVENTURA && this.livroAnimaisColetados >= this.TOTAL_LIVRO_ANIMAIS && this.livroFabulaColetados >= this.TOTAL_LIVRO_FABULA);
                } else if (this.currentPhase === 9) {
                    winConditionMet = (this.lixeiraReciclagemColetados >= this.TOTAL_LIXEIRA_RECICLAGEM && this.garrafaPlasticoColetados >= this.TOTAL_GARRAFA_PLASTICO && this.arvoreMudaColetados >= this.TOTAL_ARVORE_MUDA);
                } else if (this.currentPhase === 10) {
                    winConditionMet = (this.plantaNativaColetados >= this.TOTAL_PLANTAS_NATIVAS && this.animalSelvagemColetados >= this.TOTAL_ANIMAIS_SELVAGENS && this.telescopioColetados >= this.TOTAL_TELESCOPIO);
                } else if (this.currentPhase === 11) {
                    winConditionMet = (this.pincelColetados >= this.TOTAL_PINCEL && this.tintaColetados >= this.TOTAL_TINTA && this.argilaColetados >= this.TOTAL_ARGILA);
                } else if (this.currentPhase === 12) {
                    winConditionMet = (this.violaoColetados >= this.TOTAL_VIOLAO && this.pianoColetados >= this.TOTAL_PIANO && this.microfoneColetados >= this.TOTAL_MICROFONE);
                }

                if (this.vidas <= 0 || this.tempo <= 0 || winConditionMet) {
                    return;
                }

                if (this.ctx && this.canvas) { // Added null checks
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                } else {
                    console.error("Erro: Canvas ou contexto 2D não está disponível para limpeza.");
                    return;
                }


                const prevX = this.player.x;
                const prevY = this.player.y;

                if (this.teclas["w"]) this.player.y -= this.PLAYER_SPEED;
                if (this.teclas["s"]) this.player.y += this.PLAYER_SPEED;
                if (this.teclas["a"]) this.player.x -= this.PLAYER_SPEED;
                if (this.teclas["d"]) this.player.x += this.PLAYER_SPEED;

                this.player.x = Math.max(0, Math.min(this.canvas.width - this.player.width, this.player.x));
                this.player.y = Math.max(0, Math.min(this.canvas.height - this.player.height, this.player.y));

                this.obstaculos.forEach(obstacle => {
                    const exclusionZone = 1.0;
                    const expandedObstacleRect = {
                        x: obstacle.x - (obstacle.size * (exclusionZone - 1) / 2),
                        y: obstacle.y - (obstacle.size * (exclusionZone - 1) / 2),
                        width: obstacle.width * exclusionZone,
                        height: obstacle.height * exclusionZone
                    };
                    if (obstacle.isObstacle && this.checkCollision(this.player, expandedObstacleRect)) {
                        this.player.x = prevX;
                        this.player.y = prevY;
                    }
                });

                this.handleInteractions();

                if (this.chest && this.currentPhase === 1) {
                    this.drawItem(this.chest);
                }
                this.schoolItems.forEach(this.drawItem.bind(this)); // Bind 'this'
                this.obstaculos.forEach(this.drawItem.bind(this)); // Bind 'this'
                this.itens.forEach(this.drawItem.bind(this)); // Bind 'this'
                this.drawPlayer();
            },

            updatePageTitle: function(phase) {
                let title = "Ursinho Amigão 2D - ";
                switch (phase) {
                    case 1:
                        title += "Capítulo 1: Uma Aventura de Aprendizados";
                        break;
                    case 2:
                        title += "Capítulo 2: A Festa do Sorvete";
                        break;
                    case 3:
                        title += "Capítulo 3: Brincadeira de Criança";
                        break;
                    case 4:
                        title += "Capítulo 4: Nem Todo Dia é Brincadeira, mas Também é...";
                        break;
                    case 5:
                        title += "Capítulo 5: No Reino dos Animais";
                        break;
                    case 6:
                        title += "Capítulo 6: Aprender é uma Arte";
                        break;
                    case 7:
                        title += "Capítulo 7: Lazer no Parque";
                        break;
                    case 8:
                        title += "Capítulo 8: Leiturinhas";
                        break;
                    case 9:
                        title += "Capítulo 9: Planeta";
                        break;
                    case 10:
                        title += "Capítulo 10: Exploração da Natureza";
                        break;
                    case 11:
                        title += "Capítulo 11: Oficina de Artes";
                        break;
                    case 12:
                        title += "Capítulo 12: Música e Dança";
                        break;
                    default:
                        title += "Aventura Desconhecida";
                }
                document.title = title;
                const currentChapterTitleDisplayElement = document.getElementById('chapterTitleDisplay');
                if (currentChapterTitleDisplayElement) {
                    currentChapterTitleDisplayElement.innerText = title.split(" - ")[1];
                }
            },

            // Função principal de inicialização do jogo
            initGame: function() {
                // Obtenha as referências globais aos elementos do HUD aqui
                this.vidasDisplayElement = document.getElementById('vidasDisplay');
                this.hudObjectiveLine1Element = document.getElementById('hudObjectiveLine1');
                this.hudObjectiveLine2Element = document.getElementById('hudObjectiveLine2');
                this.totalAllItemsCollectedDisplayElement = document.getElementById('totalAllItemsCollectedDisplay');
                this.tempoDisplayElement = document.getElementById('tempo');
                this.chapterTitleDisplayElement = document.getElementById('chapterTitleDisplay');
                this.objetivoFaseElement = document.getElementById('objetivoFase');

                // Atribui canvas e ctx após o DOM estar carregado
                this.canvas = document.getElementById('gameCanvas');
                if (this.canvas) {
                    this.ctx = this.canvas.getContext('2d');
                    // Initial call to resizeCanvas to set initial dimensions
                    this.resizeCanvas();
                    // Add listener for window resize events
                    window.addEventListener('resize', this.resizeCanvas.bind(this));
                } else {
                    console.error("Erro: Elemento 'gameCanvas' não encontrado no DOM.");
                    return;
                }

                this.introMusicElement = document.getElementById('introMusic');
                if (this.introMusicElement) {
                    this.introMusicElement.volume = 0.5; // Define um volume padrão
                }

                console.log("DEBUG: tempoDisplayElement no onload:", this.tempoDisplayElement);

                const introScreen = document.getElementById('introScreen');
                const personagemSelecao = document.getElementById('personagemSelecao');
                
                const dismissIntro = () => {
                    console.log("DEBUG: dismissIntro called.");
                    const currentIntroScreen = document.getElementById('introScreen');
                    const currentPersonagemSelecao = document.getElementById('personagemSelecao');

                    if (currentIntroScreen && currentIntroScreen.style.display !== 'none') {
                        currentIntroScreen.style.display = 'none';
                        if (currentPersonagemSelecao) {
                            currentPersonagemSelecao.style.display = 'flex';
                            console.log("DEBUG: Transição para seleção de personagem.");
                        } else {
                            console.error("ERRO: Elemento 'personagemSelecao' não encontrado no DOM (dentro de dismissIntro).");
                        }
                        // Tentar tocar a música aqui, após a interação do usuário
                        if (this.introMusicElement && this.introMusicElement.paused) {
                            this.introMusicElement.play().catch(e => console.log("Erro ao tocar música de introdução após interação:", e));
                            this.currentMusic = this.introMusicElement; // Define a música de introdução como a música atual
                        }
                        document.removeEventListener('keydown', dismissIntro);
                        currentIntroScreen.removeEventListener('click', dismissIntro);
                        currentIntroScreen.removeEventListener('touchstart', dismissIntro);
                    }
                };

                if (introScreen) {
                    introScreen.addEventListener('click', dismissIntro);
                    introScreen.addEventListener('touchstart', dismissIntro);
                } else {
                    console.error("ERRO: Elemento 'introScreen' não encontrado no DOM (no window.onload).");
                }
                document.addEventListener('keydown', dismissIntro);

                // Adicionado null checks para os botões de seleção de personagem
                const personagemUrsoBtn = document.getElementById('personagemUrso');
                if (personagemUrsoBtn) personagemUrsoBtn.addEventListener('click', () => this.selecionar('urso'));
                
                const personagemGatoBtn = document.getElementById('personagemGato');
                if (personagemGatoBtn) personagemGatoBtn.addEventListener('click', () => this.selecionar('gato'));
                
                const personagemGirafaBtn = document.getElementById('personagemGirafa');
                if (personagemGirafaBtn) personagemGirafaBtn.addEventListener('click', () => this.selecionar('girafa'));
                
                const personagemCoelhoBtn = document.getElementById('personagemCoelho');
                if (personagemCoelhoBtn) personagemCoelhoBtn.addEventListener('click', () => this.selecionar('coelho'));

                // Adicionado null checks para os botões direcionais (toque)
                const btnUp = document.getElementById('btnUp');
                if (btnUp) {
                    btnUp.addEventListener('touchstart', (e) => { e.preventDefault(); this.tecla('w', true); });
                    btnUp.addEventListener('touchend', (e) => { e.preventDefault(); this.tecla('w', false); });
                }
                const btnLeft = document.getElementById('btnLeft');
                if (btnLeft) {
                    btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); this.tecla('a', true); });
                    btnLeft.addEventListener('touchend', (e) => { e.preventDefault(); this.tecla('a', false); });
                }
                const btnDown = document.getElementById('btnDown');
                if (btnDown) {
                    btnDown.addEventListener('touchstart', (e) => { e.preventDefault(); this.tecla('s', true); });
                    btnDown.addEventListener('touchend', (e) => { e.preventDefault(); this.tecla('s', false); });
                }
                const btnRight = document.getElementById('btnRight');
                if (btnRight) {
                    btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); this.tecla('d', true); });
                    btnRight.addEventListener('touchend', (e) => { e.preventDefault(); this.tecla('d', false); });
                }

                document.addEventListener('keydown', (e) => {
                    const key = e.key.toLowerCase();
                    if (['w', 'a', 's', 'd', ' '].includes(key)) {
                        e.preventDefault();
                        if (key === ' ') {
                            this.coletando = true;
                        } else {
                            this.tecla(key, true);
                        }
                    }
                });
                document.addEventListener('keyup', (e) => {
                    const key = e.key.toLowerCase();
                    if (['w', 'a', 's', 'd', ' '].includes(key)) {
                        e.preventDefault();
                        if (key === ' ') {
                            this.coletando = false;
                        } else {
                            this.tecla(key, false);
                        }
                    }
                });

                const botaoAcao = document.getElementById('botao-acao');
                if (botaoAcao) { // Added null check
                    botaoAcao.addEventListener('touchstart', (e) => { e.preventDefault(); this.coletando = true; });
                    botaoAcao.addEventListener('touchend', (e) => { e.preventDefault(); this.coletando = false; });
                }

                // Lógica do botão de controle de som
                const soundControlBtn = document.getElementById('soundControlBtn');
                const soundOnIcon = document.getElementById('soundOnIcon');
                const soundOffIcon = document.getElementById('soundOffIcon');

                if (soundControlBtn && soundOnIcon && soundOffIcon) {
                    soundControlBtn.addEventListener('click', () => {
                        // Verifica qual música está atualmente tocando para controlar o mute
                        const musicToControl = this.currentMusic; 
                        if (musicToControl) {
                            musicToControl.muted = !musicToControl.muted; // Alterna o estado mudo
                            if (musicToControl.muted) {
                                soundOnIcon.style.display = 'none';
                                soundOffIcon.style.display = 'block';
                            } else {
                                soundOnIcon.style.display = 'block';
                                soundOffIcon.style.display = 'none';
                                // Tenta tocar apenas se não estiver tocando (para evitar múltiplos play() chamadas)
                                if (musicToControl.paused) {
                                    musicToControl.play().catch(e => console.log("Erro ao tentar tocar música após desmutar:", e));
                                }
                            }
                        }
                    });
                }

                // Adicionado null checks para os botões do modal de continue
                const btnSim = document.getElementById('btnSim');
                if (btnSim) btnSim.addEventListener('click', () => this.handleContinue('sim'));
                
                const btnNao = document.getElementById('btnNao');
                if (btnNao) btnNao.addEventListener('click', () => this.handleContinue('nao'));

                console.log("DEBUG: Ouvintes de seleção de personagem, botões direcionais e botões de continue adicionados.");
                
                // Foca o canvas para garantir que ele receba eventos de teclado
                if (this.canvas) { 
                    this.canvas.focus();
                }

                this.atualizarHUD(); // Atualiza o HUD com os valores iniciais
            }
        };

        // Chama a função principal de inicialização do jogo quando o DOM estiver completamente carregado
        document.addEventListener('DOMContentLoaded', () => game.initGame());
    </script>
</body>
</html>
